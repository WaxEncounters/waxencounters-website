<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Wax Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Security Scripts -->
    <script src="js/security.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/server-validation.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .text-overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 2rem; border: 1px solid rgba(199, 122, 180, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .section-fade { opacity: 0; transform: translateY(40px); transition: opacity 1.2s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .section-fade.visible { opacity: 1; transform: translateY(0); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status-funded { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-shipped { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="index.html#hero" class="hover:text-gray-300 transition-colors duration-200">Home</a>
                        <a href="about.html" class="hover:text-gray-300 transition-colors duration-200">About Us</a>
                        <a href="supportarecord.html" class="hover:text-gray-300 transition-colors duration-200">Support a Record</a>
                        <a href="print.html" class="hover:text-gray-300 transition-colors duration-200">Print Your Vinyl</a>
                        <a href="collection.html" class="hover:text-gray-300 transition-colors duration-200">Collection</a>
                        <a href="account.html" class="text-pink-400 font-semibold">My Account</a>
                        <a href="contact.html" class="hover:text-gray-300 transition-colors duration-200">Contact</a>
                        <a href="#" id="logoutButton" class="hover:text-gray-300 transition-colors duration-200">Log Out</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24">
        <section class="relative">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="text-overlay inline-block">
                        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Welcome Back!</h1>
                        <p class="text-lg text-gray-300">Manage your vinyl pre-orders and account settings.</p>
                    </div>
                </div>

                <!-- Main Content Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Account Info Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="glass-card rounded-xl p-4 sticky top-32">
                            <h3 class="text-lg font-bold mb-3">Account Info</h3>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <p class="text-gray-400">Name</p>
                                    <p id="displayName" class="font-semibold">John Doe</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Email</p>
                                    <p id="displayEmail" class="font-semibold text-xs break-all">john.doe@example.com</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Member Since</p>
                                    <p id="displayMemberSince" class="font-semibold">December 2024</p>
                                </div>
                            </div>
                            <button id="editProfileBtn" class="premium-button w-full mt-4 px-3 py-2 text-black font-semibold rounded-lg text-xs">
                                Edit Profile
                            </button>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="lg:col-span-3 space-y-6">
                        <!-- Activity Overview -->
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="text-lg font-bold mb-4">Your Activity</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-pink-300 mb-1">5</div>
                                    <div class="text-xs text-gray-400">Pre-orders</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-400 mb-1">3</div>
                                    <div class="text-xs text-gray-400">Funded</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-400 mb-1">2</div>
                                    <div class="text-xs text-gray-400">Received</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pre-orders Section -->
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="text-lg font-bold mb-4">Your Pre-orders</h3>
                    
                            <!-- Pre-order Items -->
                            <div class="space-y-3">
                                <!-- Pre-order 1 -->
                                <div class="p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-sm">Ethereal Dreams</h4>
                                                <p class="text-xs text-gray-400">by Luna Nova</p>
                                                <p class="text-xs text-gray-500">#WE-2024-001</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="status-badge status-pending mb-1 text-xs">Pending</div>
                                            <p class="text-sm text-gray-400">€35</p>
                                            <p class="text-xs text-gray-500">Dec 15, 2024</p>
                                        </div>
                                    </div>
                                    <!-- Campaign Progress Bar -->
                                    <div class="mt-3">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs text-gray-400">Progress</span>
                                            <span class="text-xs font-semibold text-pink-400">€2,450 / €5,000</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                                            <div class="bg-gradient-to-r from-pink-500 to-purple-500 h-1.5 rounded-full" style="width: 49%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">49% funded • 12 days left</p>
                                    </div>
                                </div>

                                <!-- Pre-order 2 -->
                                <div class="p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-sm">Neon Dreams</h4>
                                                <p class="text-xs text-gray-400">by Cyber Pulse</p>
                                                <p class="text-xs text-gray-500">#WE-2024-002</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="status-badge status-funded mb-1 text-xs">Funded</div>
                                            <p class="text-sm text-gray-400">€45</p>
                                            <p class="text-xs text-gray-500">Dec 10, 2024</p>
                                        </div>
                                    </div>
                                    <!-- Campaign Progress Bar -->
                                    <div class="mt-3">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs text-gray-400">Progress</span>
                                            <span class="text-xs font-semibold text-green-400">€3,200 / €3,000</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                                            <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-1.5 rounded-full" style="width: 100%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">106% funded • Campaign successful!</p>
                                    </div>
                                </div>

                                <!-- Pre-order 3 -->
                                <div class="p-3 bg-white bg-opacity-5 rounded-lg">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-sm">Acoustic Soul Stories</h4>
                                                <p class="text-xs text-gray-400">by Emma Rivers</p>
                                                <p class="text-xs text-gray-500">#WE-2024-003</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="status-badge status-shipped mb-1 text-xs">Shipped</div>
                                            <p class="text-sm text-gray-400">€32</p>
                                            <p class="text-xs text-gray-500">Dec 5, 2024</p>
                                        </div>
                                    </div>
                                    <!-- Campaign Progress Bar -->
                                    <div class="mt-3">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs text-gray-400">Progress</span>
                                            <span class="text-xs font-semibold text-blue-400">€2,800 / €2,500</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                                            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-1.5 rounded-full" style="width: 100%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">112% funded • Record shipped!</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Browse More Records Button -->
                            <div class="mt-6 text-center">
                                <a href="supportarecord.html" class="premium-button px-6 py-3 text-black font-semibold rounded-lg text-sm inline-block">
                                    Browse More Records
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Intersection Observer for section animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        // Observe all animated elements
        document.querySelectorAll('.section-fade').forEach(el => {
            observer.observe(el);
        });

        // Function to load initial display data from account creation
        function loadInitialDisplayData() {
            console.log('Loading initial display data...');
            
            // Check if we have account creation data
            const verifiedEmail = localStorage.getItem('verifiedEmail');
            if (verifiedEmail && !localStorage.getItem('cachedDisplayData')) {
                // If we have a verified email but no cached display data,
                // create initial display data from the email
                const displayData = {
                    fullName: 'User Account', // Default until user edits profile
                    email: verifiedEmail,
                    timestamp: Date.now()
                };
                localStorage.setItem('cachedDisplayData', JSON.stringify(displayData));
                console.log('Created initial display data:', displayData);
            }
        }

        // Function to update account display with saved data
        async function updateAccountDisplay() {
            console.log('=== UPDATING ACCOUNT DISPLAY ===');
            console.log('SecureStorageManager exists:', !!window.SecureStorageManager);
            console.log('hasUserData:', window.SecureStorageManager ? window.SecureStorageManager.hasUserData() : 'N/A');
            
            // Always try to load cached data first, regardless of SecureStorageManager status
            try {
                // Get verified email from localStorage
                const verifiedEmail = localStorage.getItem('verifiedEmail');
                console.log('Verified email:', verifiedEmail);
                
                if (verifiedEmail) {
                    // Update email display immediately
                    document.getElementById('displayEmail').textContent = verifiedEmail;
                    console.log('Updated email display to:', verifiedEmail);
                    
                    // Try to load cached display data
                    const cachedDisplayData = localStorage.getItem('cachedDisplayData');
                    console.log('Cached display data raw:', cachedDisplayData);
                    
                    if (cachedDisplayData) {
                        try {
                            const displayData = JSON.parse(cachedDisplayData);
                            console.log('Parsed cached display data:', displayData);
                            
                            const fullName = displayData.fullName || 'User Account';
                            document.getElementById('displayName').textContent = fullName;
                            console.log('Updated name display to:', fullName);
                            
                            // If email in cached data is different, update it
                            if (displayData.email && displayData.email !== verifiedEmail) {
                                document.getElementById('displayEmail').textContent = displayData.email;
                                console.log('Updated email display to cached email:', displayData.email);
                            }
                        } catch (parseError) {
                            console.log('Error parsing cached display data:', parseError);
                            document.getElementById('displayName').textContent = 'User Account';
                        }
                    } else {
                        // No cached data - try to create it from available info
                        console.log('No cached data found, creating initial display data');
                        const initialDisplayData = {
                            fullName: 'User Account',
                            email: verifiedEmail,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('cachedDisplayData', JSON.stringify(initialDisplayData));
                        document.getElementById('displayName').textContent = 'User Account';
                        console.log('Created initial display data:', initialDisplayData);
                    }
                    
                    // Format member since date
                    const memberSince = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long' 
                    });
                    document.getElementById('displayMemberSince').textContent = memberSince;
                    
                    console.log('Account display updated successfully');
                } else {
                    console.log('No verified email found');
                    // Fallback to default values
                    document.getElementById('displayName').textContent = 'User Account';
                    document.getElementById('displayEmail').textContent = 'No email';
                }
            } catch (error) {
                console.log('Could not update account display:', error);
                // Fallback to default values
                document.getElementById('displayName').textContent = 'User Account';
                document.getElementById('displayEmail').textContent = 'No email';
            }
            console.log('=== END UPDATE ACCOUNT DISPLAY ===');
        }

        // Logout functionality
        document.addEventListener('DOMContentLoaded', function() {
            const logoutButton = document.getElementById('logoutButton');
            
            if (logoutButton) {
                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Confirm logout
                    if (confirm('Are you sure you want to log out?')) {
                        // Clear session data
                        if (window.SecureStorageManager) {
                            window.SecureStorageManager.clearSession();
                        }
                        
                        // Clear any other stored data (but preserve account verification for local testing)
                        localStorage.removeItem('userData');
                        localStorage.removeItem('sessionId');
                        localStorage.removeItem('verificationToken');
                        localStorage.removeItem('pendingVerificationEmail');
                        
                        // Preserve account verification status (both local and production)
                        // Users shouldn't need to re-verify after every logout
                        console.log('Preserving account verification status for better UX');
                        // Don't remove accountVerified and verifiedEmail
                        
                        // Log security event
                        if (window.ServerValidation) {
                            window.ServerValidation.logSecurityEvent('user_logout', {
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        // Redirect to homepage
                        alert('You have been logged out successfully.');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            // Update account display on page load
            updateAccountDisplay();
            
            // Try to load display data from account creation if available
            loadInitialDisplayData();
            
            // Update display when page becomes visible (when navigating back)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('Page became visible, updating account display...');
                    updateAccountDisplay();
                }
            });
            
            // Also update when window gains focus (additional backup)
            window.addEventListener('focus', function() {
                console.log('Window gained focus, updating account display...');
                updateAccountDisplay();
            });
        });

        // Edit Profile Modal
        document.addEventListener('DOMContentLoaded', function() {
            const editProfileBtn = document.getElementById('editProfileBtn');
            const editProfileModal = document.getElementById('editProfileModal');
            const closeModalBtn = document.getElementById('closeEditModal');
            const cancelEditBtn = document.getElementById('cancelEditModal');
            const verificationModal = document.getElementById('verificationModal');
            const closeVerificationBtn = document.getElementById('closeVerificationModal');
            const cancelVerificationBtn = document.getElementById('cancelVerificationModal');
            const editForm = document.getElementById('editProfileForm');
            const verificationForm = document.getElementById('verificationForm');

            // Note: Edit profile modal opening is handled below with password verification

            // Close edit profile modal (X button)
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    editProfileModal.classList.add('hidden');
                });
            }

            // Cancel edit profile modal (Cancel button)
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    editProfileModal.classList.add('hidden');
                });
            }

            // Close verification modal (X button)
            if (closeVerificationBtn) {
                closeVerificationBtn.addEventListener('click', function() {
                    verificationModal.classList.add('hidden');
                });
            }

            // Cancel verification modal (Cancel button)
            if (cancelVerificationBtn) {
                cancelVerificationBtn.addEventListener('click', function() {
                    verificationModal.classList.add('hidden');
                });
            }

            // Note: Background click to close has been removed for edit profile modal
            // Modal now only closes with Cancel button or ESC key

            // Close modals with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (!editProfileModal.classList.contains('hidden')) {
                        editProfileModal.classList.add('hidden');
                    }
                    if (!verificationModal.classList.contains('hidden')) {
                        verificationModal.classList.add('hidden');
                    }
                }
            });

            // Load current user data with proper password verification
            async function loadUserData() {
                console.log('loadUserData called');
                console.log('SecureStorageManager exists:', !!window.SecureStorageManager);
                console.log('hasUserData:', window.SecureStorageManager ? window.SecureStorageManager.hasUserData() : 'N/A');
                
                // Check if user is logged in via session
                const isLoggedIn = window.SecureStorageManager && window.SecureStorageManager.isSessionValid();
                console.log('User session valid:', isLoggedIn);
                
                
                if (window.SecureStorageManager && window.SecureStorageManager.hasUserData()) {
                    try {
                        // Create a proper password verification modal instead of simple prompt
                        const password = await showPasswordModal('Enter your login password to access profile data:');
                        if (password) {
                            console.log('Password provided, attempting to retrieve user data...');
                            const userData = await window.SecureStorageManager.retrieveUserData(password);
                            console.log('User data retrieval result:', userData);
                            
                            if (userData.success) {
                                console.log('Password verification successful, loading user data');
                                console.log('Actual user data:', userData.data);
                                
                                // Try to use cached display data first (more up-to-date)
                                const cachedDisplayData = localStorage.getItem('cachedDisplayData');
                                let formData = userData.data; // Default to encrypted data
                                
                                if (cachedDisplayData) {
                                    try {
                                        const cachedData = JSON.parse(cachedDisplayData);
                                        console.log('Found cached display data:', cachedData);
                                        
                                        // Use cached data for all fields if available
                                        if (cachedData.firstName) {
                                            formData.firstName = cachedData.firstName;
                                            console.log('Using cached firstName:', formData.firstName);
                                        }
                                        
                                        if (cachedData.lastName) {
                                            formData.lastName = cachedData.lastName;
                                            console.log('Using cached lastName:', formData.lastName);
                                        }
                                        
                                        if (cachedData.email) {
                                            formData.email = cachedData.email;
                                            console.log('Using cached email:', formData.email);
                                        }
                                        
                                        if (cachedData.shippingAddress) {
                                            formData.shippingAddress = cachedData.shippingAddress;
                                            console.log('Using cached shipping address:', formData.shippingAddress);
                                        }
                                        
                                        if (cachedData.iban) {
                                            formData.iban = cachedData.iban;
                                            console.log('Using cached IBAN:', formData.iban);
                                        }
                                        
                                        if (cachedData.bic) {
                                            formData.bic = cachedData.bic;
                                            console.log('Using cached BIC:', formData.bic);
                                        }
                                        
                                        if (cachedData.bankAccountOwner) {
                                            formData.bankAccountOwner = cachedData.bankAccountOwner;
                                            console.log('Using cached bank owner:', formData.bankAccountOwner);
                                        }
                                    } catch (error) {
                                        console.log('Error parsing cached data, using encrypted data:', error);
                                    }
                                }
                                
                                // Load the form data (prioritizing cached data where available)
                                console.log('Setting form field values...');
                                console.log('First Name:', formData.firstName);
                                console.log('Last Name:', formData.lastName);
                                console.log('Email:', formData.email);
                                console.log('Shipping:', formData.shippingAddress);
                                console.log('IBAN:', formData.iban);
                                console.log('BIC:', formData.bic);
                                console.log('Bank Owner:', formData.bankAccountOwner);
                                
                                document.getElementById('editFirstName').value = formData.firstName || '';
                                document.getElementById('editLastName').value = formData.lastName || '';
                                document.getElementById('editEmail').value = formData.email || '';
                                document.getElementById('editShipping').value = formData.shippingAddress || '';
                                document.getElementById('editIban').value = formData.iban || '';
                                document.getElementById('editBic').value = formData.bic || '';
                                document.getElementById('editBankOwner').value = formData.bankAccountOwner || '';
                                
                                console.log('Form fields set. Verifying values...');
                                console.log('editFirstName.value:', document.getElementById('editFirstName').value);
                                console.log('editLastName.value:', document.getElementById('editLastName').value);
                                console.log('editEmail.value:', document.getElementById('editEmail').value);
                                console.log('editShipping.value:', document.getElementById('editShipping').value);
                                
                                return true; // Success
                            } else {
                                console.log('Password verification failed, checking for data integrity issues...');
                                
                                // Check if this is a data integrity issue (common with older accounts)
                                if (userData.error && userData.error.includes('Data integrity check failed')) {
                                    console.log('Data integrity issue detected, using fallback method');
                                    
                                    // For accounts with data integrity issues, we'll use a simplified approach
                                    // Extract email from localStorage if available
                                    const verifiedEmail = localStorage.getItem('verifiedEmail');
                                    if (verifiedEmail) {
                                        console.log('Using verified email from localStorage:', verifiedEmail);
                                        document.getElementById('editFirstName').value = 'User';
                                        document.getElementById('editLastName').value = 'Account';
                                        document.getElementById('editEmail').value = verifiedEmail;
                                        document.getElementById('editShipping').value = '123 Main Street, City, Country';
                                        document.getElementById('editIban').value = 'GB29NWBK60161331926819';
                                        document.getElementById('editBic').value = 'NWBKGB2L';
                                        document.getElementById('editBankOwner').value = 'User Account';
                                        
                                        alert('Account data loaded with limited information due to data format changes. You can update your details now.');
                                        return true; // Success with fallback data
                                    } else {
                                        alert('Account data format issue detected. Please create a new account or contact support.');
                                        return false;
                                    }
                                } else {
                                    console.log('Password verification failed');
                                    alert('Invalid password. Please use the same password you used to log in.');
                                    return false; // Failed
                                }
                            }
                        } else {
                            console.log('Password verification cancelled');
                            return false; // Cancelled
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        alert('Error loading profile data. Please try again.');
                        return false;
                    }
                } else if (isLoggedIn) {
                    // User is logged in but no stored data - this shouldn't happen
                    console.log('User is logged in but no stored data found');
                    alert('Account data not found. Please log out and log in again.');
                    return false;
                } else {
                    console.log('No user data found and not logged in');
                    alert('Please log in first to access your profile.');
                    return false; // No user data - deny access
                }
            }

            // Show password verification modal
            function showPasswordModal(message) {
                return new Promise((resolve) => {
                    // Create password modal
                    const passwordModal = document.createElement('div');
                    passwordModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    passwordModal.innerHTML = `
                        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold">Password Verification</h3>
                                <button id="closePasswordModal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-gray-300 mb-6">${message}</p>
                            <div class="space-y-4">
                                <div>
                                    <label for="passwordInput" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                                    <div class="relative">
                                        <input id="passwordInput" type="password" class="w-full px-4 py-3 pr-12 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="Enter your password">
                                        <button id="togglePasswordVisibility" type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200">
                                            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            <svg id="eyeSlashIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex space-x-4">
                                    <button id="cancelPasswordModal" class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors duration-200">
                                        Cancel
                                    </button>
                                    <button id="verifyPasswordModal" class="flex-1 premium-button px-6 py-3 text-black font-semibold rounded-xl transition-all duration-200">
                                        Verify
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(passwordModal);
                    
                    // Focus on password input
                    const passwordInput = passwordModal.querySelector('#passwordInput');
                    passwordInput.focus();
                    
                    // Handle events
                    const closeBtn = passwordModal.querySelector('#closePasswordModal');
                    const cancelBtn = passwordModal.querySelector('#cancelPasswordModal');
                    const verifyBtn = passwordModal.querySelector('#verifyPasswordModal');
                    const toggleBtn = passwordModal.querySelector('#togglePasswordVisibility');
                    const eyeIcon = passwordModal.querySelector('#eyeIcon');
                    const eyeSlashIcon = passwordModal.querySelector('#eyeSlashIcon');
                    
                    function closeModal() {
                        document.body.removeChild(passwordModal);
                        resolve(null);
                    }
                    
                    closeBtn.addEventListener('click', closeModal);
                    cancelBtn.addEventListener('click', closeModal);
                    
                    // Password visibility toggle
                    toggleBtn.addEventListener('click', () => {
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            eyeIcon.classList.add('hidden');
                            eyeSlashIcon.classList.remove('hidden');
                        } else {
                            passwordInput.type = 'password';
                            eyeIcon.classList.remove('hidden');
                            eyeSlashIcon.classList.add('hidden');
                        }
                    });
                    
                    verifyBtn.addEventListener('click', () => {
                        const password = passwordInput.value;
                        if (password) {
                            document.body.removeChild(passwordModal);
                            resolve(password);
                        } else {
                            alert('Please enter your password.');
                        }
                    });
                    
                    // Handle Enter key
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            verifyBtn.click();
                        }
                    });
                    
                    // Handle ESC key
                    document.addEventListener('keydown', function escHandler(e) {
                        if (e.key === 'Escape') {
                            document.removeEventListener('keydown', escHandler);
                            closeModal();
                        }
                    });
                });
            }

            // Load user data when modal opens
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', async function() {
                    console.log('Edit profile button clicked');
                    const success = await loadUserData();
                    console.log('loadUserData returned:', success);
                    
                    if (success) {
                        console.log('Opening edit profile modal');
                        editProfileModal.classList.remove('hidden');
                    } else {
                        // Password verification failed or was cancelled
                        console.log('Edit profile cancelled due to failed password verification');
                        // Ensure modal stays hidden
                        editProfileModal.classList.add('hidden');
                    }
                });
            }

            // Handle edit form submission
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get current values
                    const currentFirstName = document.getElementById('editFirstName').value;
                    const currentLastName = document.getElementById('editLastName').value;
                    const currentEmail = document.getElementById('editEmail').value;
                    const currentShipping = document.getElementById('editShipping').value;
                    const currentIban = document.getElementById('editIban').value;
                    const currentBic = document.getElementById('editBic').value;
                    const currentBankOwner = document.getElementById('editBankOwner').value;
                    
                    // Check if any sensitive fields are being changed
                    const emailChanged = currentEmail !== 'alberto.marabelli@outlook.it';
                    const bankChanged = currentIban !== 'GB29NWBK60161331926819' ||
                                      currentBic !== 'NWBKGB2L' ||
                                      currentBankOwner !== 'User Account';
                    
                    if (emailChanged || bankChanged) {
                        // Show verification modal
                        verificationModal.classList.remove('hidden');
                        editProfileModal.classList.add('hidden');
                    } else {
                        // Only shipping address changed, no verification needed
                        const success = await updateProfileData(currentFirstName, currentLastName, currentEmail, currentShipping, currentIban, currentBic, currentBankOwner);
                        if (success) {
                            alert('Profile updated successfully!');
                            editProfileModal.classList.add('hidden');
                        }
                    }
                });
            }

            // Update profile data function with proper password verification
            async function updateProfileData(firstName, lastName, email, shipping, iban, bic, bankOwner) {
                if (window.SecureStorageManager && window.SecureStorageManager.hasUserData()) {
                    try {
                        const password = await showPasswordModal('Enter your password to save changes:');
                        if (password) {
                            const userData = await window.SecureStorageManager.retrieveUserData(password);
                            if (userData.success) {
                                // Update the data
                                console.log('Updating user data with new values:');
                                console.log('Old firstName:', userData.data.firstName);
                                console.log('New firstName:', firstName);
                                console.log('Old lastName:', userData.data.lastName);
                                console.log('New lastName:', lastName);
                                
                                userData.data.firstName = firstName;
                                userData.data.lastName = lastName;
                                userData.data.email = email;
                                userData.data.shippingAddress = shipping;
                                userData.data.iban = iban;
                                userData.data.bic = bic;
                                userData.data.bankAccountOwner = bankOwner;
                                
                                console.log('Updated user data:', userData.data);
                                
                                // Save updated data
                                const saveResult = await window.SecureStorageManager.storeUserData(userData.data, password);
                                console.log('Save result:', saveResult);
                                console.log('Profile data updated successfully');
                                
                                // Update the account display with the data we just retrieved
                                const fullName = `${userData.data.firstName || ''} ${userData.data.lastName || ''}`.trim() || 'User Account';
                                document.getElementById('displayName').textContent = fullName;
                                document.getElementById('displayEmail').textContent = userData.data.email || 'No email';
                                
                                // Cache the display data for future page loads (including all form data)
                                const displayData = {
                                    fullName: fullName,
                                    email: userData.data.email,
                                    firstName: userData.data.firstName,
                                    lastName: userData.data.lastName,
                                    shippingAddress: userData.data.shippingAddress,
                                    iban: userData.data.iban,
                                    bic: userData.data.bic,
                                    bankAccountOwner: userData.data.bankAccountOwner,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem('cachedDisplayData', JSON.stringify(displayData));
                                console.log('Cached display data:', displayData);
                                
                                // Also update the verified email in localStorage to match
                                localStorage.setItem('verifiedEmail', userData.data.email);
                                console.log('Updated verified email to:', userData.data.email);
                                
                                // Format member since date
                                const memberSince = new Date().toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long' 
                                });
                                document.getElementById('displayMemberSince').textContent = memberSince;
                                
                                return true;
                            } else {
                                alert('Invalid password. Changes not saved.');
                                return false;
                            }
                        } else {
                            console.log('Password verification cancelled');
                            return false;
                        }
                    } catch (error) {
                        console.error('Error updating profile data:', error);
                        alert('Error saving changes. Please try again.');
                        return false;
                    }
                } else {
                    console.log('No user data found to update');
                    return false;
                }
            }

            // Handle verification form submission
            if (verificationForm) {
                verificationForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const verificationType = document.querySelector('input[name="verificationType"]:checked').value;
                    const verificationCode = document.getElementById('verificationCode').value;
                    
                    if (verificationType === 'email') {
                        // Check verification code
                        const isLocalTesting = window.location.protocol === 'file:';
                        const expectedCode = isLocalTesting ? '123456' : sessionStorage.getItem('profileVerificationCode');
                        const expectedEmail = isLocalTesting ? null : sessionStorage.getItem('profileVerificationEmail');
                        
                        if (verificationCode === expectedCode) {
                            // Get the form data and update
                            const currentFirstName = document.getElementById('editFirstName').value;
                            const currentLastName = document.getElementById('editLastName').value;
                            const currentEmail = document.getElementById('editEmail').value;
                            const currentShipping = document.getElementById('editShipping').value;
                            const currentIban = document.getElementById('editIban').value;
                            const currentBic = document.getElementById('editBic').value;
                            const currentBankOwner = document.getElementById('editBankOwner').value;
                            
                            const success = await updateProfileData(currentFirstName, currentLastName, currentEmail, currentShipping, currentIban, currentBic, currentBankOwner);
                            if (success) {
                                alert('Email verification successful! Profile updated.');
                                verificationModal.classList.add('hidden');
                            }
                        } else {
                            alert('Invalid verification code. Please try again.');
                        }
                    } else if (verificationType === 'sms') {
                        // Simulate SMS verification
                        if (verificationCode === '789012') {
                            // Get the form data and update
                            const currentFirstName = document.getElementById('editFirstName').value;
                            const currentLastName = document.getElementById('editLastName').value;
                            const currentEmail = document.getElementById('editEmail').value;
                            const currentShipping = document.getElementById('editShipping').value;
                            const currentIban = document.getElementById('editIban').value;
                            const currentBic = document.getElementById('editBic').value;
                            const currentBankOwner = document.getElementById('editBankOwner').value;
                            
                            const success = await updateProfileData(currentFirstName, currentLastName, currentEmail, currentShipping, currentIban, currentBic, currentBankOwner);
                            if (success) {
                                alert('SMS verification successful! Profile updated.');
                                verificationModal.classList.add('hidden');
                            }
                        } else {
                            alert('Invalid verification code. Please try again.');
                        }
                    }
                });
            }

            // Send verification code
            window.sendVerificationCode = function() {
                const verificationType = document.querySelector('input[name="verificationType"]:checked').value;
                const sendBtn = document.querySelector('button[onclick="sendVerificationCode()"]');
                
                // Disable button temporarily
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                
                // Check if we're in local testing mode
                const isLocalTesting = window.location.protocol === 'file:';
                
                if (isLocalTesting) {
                    // Local testing - use simulated verification
                    setTimeout(() => {
                        if (verificationType === 'email') {
                            alert('Verification code sent to your email address.\n\nFor testing purposes, use code: 123456');
                        } else if (verificationType === 'sms') {
                            alert('Verification code sent to your phone number.\n\nFor testing purposes, use code: 789012');
                        }
                        
                        // Re-enable button
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'Send Verification Code';
                    }, 1500);
                } else {
                    // Production mode - send real verification email
                    if (verificationType === 'email') {
                        sendRealVerificationEmail();
                    } else if (verificationType === 'sms') {
                        // SMS verification would need a different service
                        alert('SMS verification not yet implemented. Please use email verification.');
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'Send Verification Code';
                    }
                }
            };

            // Function to send real verification email for profile changes
            async function sendRealVerificationEmail() {
                try {
                    console.log('Sending real verification email for profile changes...');
                    
                    // Get user's email from the form
                    const userEmail = document.getElementById('editEmail').value;
                    if (!userEmail) {
                        alert('Please enter your email address first.');
                        return;
                    }
                    
                    // Generate verification code
                    const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    // Store verification code temporarily
                    sessionStorage.setItem('profileVerificationCode', verificationCode);
                    sessionStorage.setItem('profileVerificationEmail', userEmail);
                    
                    // Send email using EmailJS
                    if (window.EmailService) {
                        const emailResult = await window.EmailService.sendProfileChangeVerificationEmail(
                            userEmail, 
                            verificationCode
                        );
                        
                        if (emailResult.success) {
                            alert('Verification code sent to your email address. Please check your inbox.');
                        } else {
                            alert('Failed to send verification email. Please try again.');
                        }
                    } else {
                        alert('Email service not available. Please try again later.');
                    }
                    
                    // Re-enable button
                    const sendBtn = document.getElementById('sendVerificationBtn');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Verification Code';
                    
                } catch (error) {
                    console.error('Error sending verification email:', error);
                    alert('Error sending verification email. Please try again.');
                    
                    // Re-enable button
                    const sendBtn = document.getElementById('sendVerificationBtn');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Verification Code';
                }
            }

            // Function to update account display with real data (requires password)
            async function updateAccountDisplayWithData() {
                console.log('Updating account display with real data...');
                
                if (window.SecureStorageManager && window.SecureStorageManager.hasUserData()) {
                    try {
                        const password = await showPasswordModal('Enter your password to view account details:');
                        if (password) {
                            const userData = await window.SecureStorageManager.retrieveUserData(password);
                            if (userData.success) {
                                // Update display with real data
                                const fullName = `${userData.data.firstName || ''} ${userData.data.lastName || ''}`.trim() || 'User Account';
                                document.getElementById('displayName').textContent = fullName;
                                document.getElementById('displayEmail').textContent = userData.data.email || 'No email';
                                
                                // Format member since date
                                const memberSince = new Date().toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long' 
                                });
                                document.getElementById('displayMemberSince').textContent = memberSince;
                                
                                console.log('Account display updated with real data');
                                return true;
                            } else {
                                alert('Could not retrieve account data. Please try again.');
                                return false;
                            }
                        } else {
                            console.log('Password prompt cancelled');
                            return false;
                        }
                    } catch (error) {
                        console.error('Error updating account display:', error);
                        alert('Error retrieving account data: ' + error.message);
                        return false;
                    }
                } else {
                    console.log('No user data found');
                    return false;
                }
            }

            // Debug function to check stored user data
            window.debugUserData = async function() {
                console.log('=== DEBUG USER DATA ===');
                console.log('SecureStorageManager exists:', !!window.SecureStorageManager);
                console.log('hasUserData:', window.SecureStorageManager ? window.SecureStorageManager.hasUserData() : 'N/A');
                console.log('isSessionValid:', window.SecureStorageManager ? window.SecureStorageManager.isSessionValid() : 'N/A');
                
                // Check localStorage for any user-related data
                console.log('localStorage keys:', Object.keys(localStorage));
                for (let key of Object.keys(localStorage)) {
                    if (key.includes('wax_encounters_') || key.includes('user') || key.includes('account')) {
                        console.log(`${key}:`, localStorage.getItem(key));
                    }
                }
                
                if (window.SecureStorageManager && window.SecureStorageManager.hasUserData()) {
                    const password = prompt('Enter your password to see stored data:');
                    if (password) {
                        try {
                            const userData = await window.SecureStorageManager.retrieveUserData(password);
                            console.log('Retrieved user data:', userData);
                        } catch (error) {
                            console.error('Error retrieving user data:', error);
                        }
                    }
                }
                console.log('=== END DEBUG ===');
            };

            // Function to fix account data integrity issues
            window.fixAccountData = async function() {
                console.log('=== FIXING ACCOUNT DATA ===');
                
                const password = prompt('Enter your password to fix account data:');
                if (!password) {
                    console.log('Password required to fix account data');
                    return;
                }
                
                try {
                    // Get verified email from localStorage
                    const verifiedEmail = localStorage.getItem('verifiedEmail');
                    console.log('Verified email:', verifiedEmail);
                    
                    if (!verifiedEmail) {
                        alert('No verified email found. Cannot fix account data.');
                        return;
                    }
                    
                    // Create new account data with current format
                    const newUserData = {
                        email: verifiedEmail,
                        username: verifiedEmail.split('@')[0], // Use email prefix as username
                        shippingAddress: '',
                        iban: '',
                        bic: '',
                        bankAccountOwner: '',
                        phoneNumber: '',
                        emailVerified: true,
                        registrationDate: new Date().toISOString()
                    };
                    
                    console.log('Creating new account data:', newUserData);
                    
                    // Store the new data
                    await window.SecureStorageManager.storeUserData(newUserData, password);
                    
                    alert('Account data fixed successfully! You can now edit your profile.');
                    console.log('Account data fixed successfully');
                    
                } catch (error) {
                    console.error('Error fixing account data:', error);
                    alert('Error fixing account data. Please try again.');
                }
                
                console.log('=== END FIX ===');
            };

            // Function to test password verification
            window.testPassword = async function() {
                console.log('=== TESTING PASSWORD ===');
                
                const password = prompt('Enter your password to test:');
                if (!password) {
                    console.log('Password required');
                    return;
                }
                
                try {
                    console.log('Testing password:', password);
                    const result = await window.SecureStorageManager.retrieveUserData(password);
                    console.log('Password test result:', result);
                    
                    if (result.success) {
                        alert('Password works! Data retrieved successfully.');
                        console.log('Retrieved data:', result.data);
                    } else {
                        alert('Password failed: ' + result.error);
                        console.log('Password failed with error:', result.error);
                    }
                } catch (error) {
                    console.error('Error testing password:', error);
                    alert('Error testing password: ' + error.message);
                }
                
                console.log('=== END TEST ===');
            };


            // Debug function to check cached display data
            window.checkCachedDisplayData = function() {
                console.log('=== CHECKING CACHED DISPLAY DATA ===');
                const cachedData = localStorage.getItem('cachedDisplayData');
                if (cachedData) {
                    console.log('Cached display data:', JSON.parse(cachedData));
                } else {
                    console.log('No cached display data found');
                }
                console.log('Verified email:', localStorage.getItem('verifiedEmail'));
                console.log('=== END CHECK ===');
            };

            // Function to force refresh account display
            window.refreshAccountDisplay = function() {
                console.log('=== FORCE REFRESHING ACCOUNT DISPLAY ===');
                updateAccountDisplay();
                console.log('=== END FORCE REFRESH ===');
            };

            // Function to manually save current display data
            window.saveCurrentDisplayData = function() {
                console.log('=== MANUALLY SAVING DISPLAY DATA ===');
                const currentName = document.getElementById('displayName').textContent;
                const currentEmail = document.getElementById('displayEmail').textContent;
                
                const displayData = {
                    fullName: currentName,
                    email: currentEmail,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('cachedDisplayData', JSON.stringify(displayData));
                console.log('Manually saved display data:', displayData);
                console.log('=== END MANUAL SAVE ===');
            };

            // Function to manually test form field filling
            window.testFormFilling = function() {
                console.log('=== TESTING FORM FIELD FILLING ===');
                document.getElementById('editFirstName').value = 'Test First Name';
                document.getElementById('editLastName').value = 'Test Last Name';
                document.getElementById('editEmail').value = 'test@example.com';
                document.getElementById('editShipping').value = 'Test Address';
                document.getElementById('editIban').value = 'TEST123';
                document.getElementById('editBic').value = 'TESTBIC';
                document.getElementById('editBankOwner').value = 'Test Owner';
                console.log('Form fields filled with test data');
                console.log('=== END TEST ===');
            };

            // Function to test data retrieval after saving
            window.testDataRetrieval = async function() {
                console.log('=== TESTING DATA RETRIEVAL ===');
                const password = prompt('Enter your password to test data retrieval:');
                if (password) {
                    try {
                        const userData = await window.SecureStorageManager.retrieveUserData(password);
                        console.log('Retrieved user data:', userData);
                        if (userData.success) {
                            console.log('First Name:', userData.data.firstName);
                            console.log('Last Name:', userData.data.lastName);
                            console.log('Email:', userData.data.email);
                            console.log('Shipping:', userData.data.shippingAddress);
                        }
                    } catch (error) {
                        console.error('Error retrieving data:', error);
                    }
                }
                console.log('=== END TEST ===');
            };

            // Function to completely rebuild account data
            window.rebuildAccountData = async function() {
                console.log('=== REBUILDING ACCOUNT DATA ===');
                
                const password = prompt('Enter your password to rebuild account data:');
                if (!password) {
                    console.log('Password required');
                    return;
                }
                
                try {
                    // Get verified email from localStorage
                    const verifiedEmail = localStorage.getItem('verifiedEmail');
                    console.log('Verified email:', verifiedEmail);
                    
                    if (!verifiedEmail) {
                        alert('No verified email found. Cannot rebuild account data.');
                        return;
                    }
                    
                    // Clear old corrupted data
                    console.log('Clearing old corrupted data...');
                    localStorage.removeItem('wax_encounters_user_data');
                    
                    // Create completely new account data with all required fields
                    const newUserData = {
                        firstName: 'User', // Default first name
                        lastName: 'Account', // Default last name
                        email: verifiedEmail,
                        username: verifiedEmail.split('@')[0],
                        shippingAddress: '123 Main Street, City, Country',
                        iban: 'GB29NWBK60161331926819', // Valid UK IBAN format
                        bic: 'NWBKGB2L', // Valid BIC format
                        bankAccountOwner: 'User Account',
                        phoneNumber: '',
                        password: password, // Required field
                        emailVerified: true,
                        registrationDate: new Date().toISOString()
                    };
                    
                    console.log('Creating new account data:', newUserData);
                    
                    // Store the new data with the same password
                    await window.SecureStorageManager.storeUserData(newUserData, password);
                    console.log('Data stored successfully');
                    
                    // Test the new data
                    console.log('Testing new account data...');
                    const testResult = await window.SecureStorageManager.retrieveUserData(password);
                    
                    if (testResult.success) {
                        alert('Account data rebuilt successfully! Your password now works properly.');
                        console.log('Account data rebuilt and tested successfully');
                        console.log('New data:', testResult.data);
                    } else {
                        alert('Error: New account data failed verification. Please try again.');
                        console.error('New data verification failed:', testResult);
                    }
                    
                } catch (error) {
                    console.error('Error rebuilding account data:', error);
                    alert('Error rebuilding account data: ' + error.message);
                }
                
                console.log('=== END REBUILD ===');
            };

        });
    </script>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Edit Profile</h3>
                <button id="closeEditModal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <form id="editProfileForm" class="space-y-6">
                <!-- Name Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editFirstName" class="block text-sm font-medium text-gray-300 mb-2">First Name</label>
                        <input id="editFirstName" type="text" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    </div>
                    <div>
                        <label for="editLastName" class="block text-sm font-medium text-gray-300 mb-2">Last Name</label>
                        <input id="editLastName" type="text" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    </div>
                </div>

                <!-- Email -->
                <div>
                    <label for="editEmail" class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                    <input id="editEmail" type="email" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    <p class="text-xs text-gray-400 mt-1">Changing email requires verification</p>
                </div>

                <!-- Shipping Address -->
                <div>
                    <label for="editShipping" class="block text-sm font-medium text-gray-300 mb-2">Shipping Address</label>
                    <textarea id="editShipping" rows="3" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 resize-none text-base"></textarea>
                </div>

                <!-- Bank Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editIban" class="block text-sm font-medium text-gray-300 mb-2">IBAN</label>
                        <input id="editIban" type="text" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    </div>
                    <div>
                        <label for="editBic" class="block text-sm font-medium text-gray-300 mb-2">BIC</label>
                        <input id="editBic" type="text" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    </div>
                </div>

                <div>
                    <label for="editBankOwner" class="block text-sm font-medium text-gray-300 mb-2">Bank Account Owner</label>
                    <input id="editBankOwner" type="text" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                    <p class="text-xs text-gray-400 mt-1">Changing bank details requires verification</p>
                </div>

                <div class="flex space-x-4">
                    <button type="button" id="cancelEditModal" class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 premium-button px-6 py-3 text-black font-semibold rounded-xl transition-all duration-200">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Verify Changes</h3>
                <button id="closeVerificationModal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <p class="text-gray-300 mb-4">To protect your account, we need to verify your identity before making these changes.</p>
            <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 border-opacity-30 rounded-lg p-3 mb-6">
                <p class="text-yellow-200 text-sm">
                    <strong>Security Notice:</strong> Email and bank detail changes require verification to prevent unauthorized access to your account.
                </p>
            </div>
            
            <form id="verificationForm" class="space-y-6">
                <!-- Verification Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">Choose verification method:</label>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="verificationType" value="email" checked class="h-4 w-4 text-pink-400 focus:ring-pink-400 bg-white bg-opacity-10 border-white border-opacity-20">
                            <span class="text-gray-300">Email verification</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="verificationType" value="sms" class="h-4 w-4 text-pink-400 focus:ring-pink-400 bg-white bg-opacity-10 border-white border-opacity-20">
                            <span class="text-gray-300">SMS verification</span>
                        </label>
                    </div>
                </div>

                <!-- Send Code Button -->
                <button type="button" onclick="sendVerificationCode()" class="w-full px-4 py-3 bg-pink-600 hover:bg-pink-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors duration-200">
                    Send Verification Code
                </button>

                <!-- Verification Code -->
                <div>
                    <label for="verificationCode" class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                    <input id="verificationCode" type="text" placeholder="Enter 6-digit code" maxlength="6" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base text-center text-lg tracking-widest">
                </div>

                <div class="flex space-x-4">
                    <button type="button" id="cancelVerificationModal" class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 premium-button px-6 py-3 text-black font-semibold rounded-xl transition-all duration-200">
                        Verify & Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
