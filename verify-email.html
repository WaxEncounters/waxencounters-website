<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - Wax Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .text-overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 2rem; border: 1px solid rgba(199, 122, 180, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .section-fade { opacity: 0; transform: translateY(40px); transition: opacity 1.2s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .section-fade.visible { opacity: 1; transform: translateY(0); }
        .success-icon { animation: pulse 2s infinite; }
        .error-icon { animation: shake 0.5s ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
    <link rel="icon" href="data:,">
    <!-- Security Scripts -->
    <script src="js/security.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/server-validation.js"></script>
    <script src="js/email-service.js"></script>
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="index.html#hero" class="hover:text-gray-300 transition-colors duration-200">Home</a>
                        <a href="about.html" class="hover:text-gray-300 transition-colors duration-200">About Us</a>
                        <a href="supportarecord.html" class="hover:text-gray-300 transition-colors duration-200">Support a Record</a>
                        <a href="print.html" class="hover:text-gray-300 transition-colors duration-200">Print Your Vinyl</a>
                        <a href="collection.html" class="hover:text-gray-300 transition-colors duration-200">Collection</a>
                        <a href="contact.html" class="hover:text-gray-300 transition-colors duration-200">Contact</a>
                        <a href="login.html" class="hover:text-gray-300 transition-colors duration-200">Log In</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24">
        <section class="relative">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="text-overlay inline-block">
                        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Email Verification</h1>
                        <p class="text-lg text-gray-300">Verifying your email address...</p>
                    </div>
                </div>

                <div class="max-w-2xl mx-auto glass-card rounded-2xl p-8 text-center">
                    <!-- Verification Status -->
                    <div id="verificationStatus">
                        <!-- Success State -->
                        <div id="successState" class="hidden">
                            <div class="w-20 h-20 bg-green-400 bg-opacity-20 rounded-full mx-auto mb-6 flex items-center justify-center success-icon">
                                <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold mb-4 text-green-400">Email Verified Successfully!</h2>
                            <p class="text-gray-300 mb-6 leading-relaxed">
                                Your email address has been verified. You can now access your account and start supporting vinyl campaigns.
                            </p>
                            <a href="account.html" class="premium-button px-8 py-4 text-black font-semibold rounded-xl text-lg inline-block mb-4">
                                Go to My Account
                            </a>
                        </div>

                        <!-- Error State -->
                        <div id="errorState" class="hidden">
                            <div class="w-20 h-20 bg-red-400 bg-opacity-20 rounded-full mx-auto mb-6 flex items-center justify-center error-icon">
                                <svg class="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold mb-4 text-red-400">Verification Failed</h2>
                            <p class="text-gray-300 mb-6 leading-relaxed">
                                The verification link is invalid or has expired. Please request a new verification email.
                            </p>
                            <button id="resendVerification" class="premium-button px-8 py-4 text-black font-semibold rounded-xl text-lg inline-block mb-4">
                                Resend Verification Email
                            </button>
                        </div>

                        <!-- Loading State -->
                        <div id="loadingState">
                            <div class="w-20 h-20 bg-blue-400 bg-opacity-20 rounded-full mx-auto mb-6 flex items-center justify-center">
                                <svg class="w-10 h-10 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold mb-4">Verifying Your Email</h2>
                            <p class="text-gray-300 mb-6 leading-relaxed">
                                Please wait while we verify your email address...
                            </p>
                        </div>
                    </div>

                    <!-- Back to Login -->
                    <div class="mt-8 pt-6 border-t border-white border-opacity-20">
                        <p class="text-sm text-gray-400 mb-4">Need help with verification?</p>
                        <a href="contact.html" class="glass-card px-6 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-sm inline-block">
                            Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Handle email verification
        document.addEventListener('DOMContentLoaded', function() {
            // For local testing, we'll simulate successful verification
            // In production, this will work with real URL parameters
            
            // Check if we're in local file mode
            if (window.location.protocol === 'file:') {
                // For local testing, show success message
                showSuccess('alberto.marabelli@outlook.it', 'test-token');
            } else {
                // For production, use real URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const token = urlParams.get('token');

                // Debug logging
                console.log('Verification page loaded');
                console.log('URL:', window.location.href);
                console.log('Email parameter:', email);
                console.log('Token parameter:', token);

                if (email && token) {
                    console.log('Starting verification process...');
                    verifyEmail(email, token);
                } else {
                    console.log('Missing email or token parameter');
                    showError('Invalid verification link');
                }
            }
        });

        async function verifyEmail(email, token) {
            try {
                // Simulate verification process
                // In a real implementation, this would verify with your backend
                await new Promise(resolve => setTimeout(resolve, 2000));

                // For demo purposes, we'll consider any token valid
                // In production, you'd verify the token against your database
                const isValid = true; // This would be determined by your backend

                if (isValid) {
                    // Mark account as verified for production
                    localStorage.setItem('accountVerified', 'true');
                    localStorage.setItem('verifiedEmail', email);
                    
                    // Update session to active
                    if (window.SecureStorageManager) {
                        await window.SecureStorageManager.updateSession(true);
                    }
                    
                    // Create initial display data for the verified account
                    // We'll use the email username as the initial name until they edit their profile
                    const emailUsername = email.split('@')[0];
                    const initialDisplayData = {
                        fullName: 'User Account', // Default until user edits profile
                        email: email,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('cachedDisplayData', JSON.stringify(initialDisplayData));
                    
                    // Also create an admin-accessible user record for the dashboard
                    // This ensures the account appears in admin dashboard even without admin authentication
                    const adminUserRecord = {
                        email: email,
                        fullName: 'User Account',
                        username: emailUsername,
                        verifiedAt: Date.now(),
                        status: 'verified',
                        source: 'email_verification'
                    };
                    
                    // Store in a format that admin dashboard can easily access
                    localStorage.setItem('admin_user_' + email.replace('@', '_at_'), JSON.stringify(adminUserRecord));
                    
                    console.log('Created initial display data for verified account:', initialDisplayData);
                    console.log('Created admin user record:', adminUserRecord);
                    
                    console.log('Email verification successful for:', email);
                    showSuccess();
                } else {
                    showError('Invalid or expired verification token');
                }

            } catch (error) {
                console.error('Verification error:', error);
                showError('Verification failed. Please try again.');
            }
        }

        function showSuccess() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            
            if (message) {
                document.querySelector('#errorState p').textContent = message;
            }
        }

        // Resend verification email
        document.getElementById('resendVerification').addEventListener('click', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            
            if (email && window.EmailService) {
                const token = window.EmailService.generateVerificationToken();
                const verificationLink = window.EmailService.generateVerificationLink(email, token);
                
                const result = await window.EmailService.sendVerificationEmail(
                    email, 
                    'User', // You might want to get the actual name
                    verificationLink
                );
                
                if (result.success) {
                    alert('Verification email has been resent! Please check your inbox.');
                } else {
                    alert('Failed to resend verification email. Please try again later.');
                }
            } else {
                alert('Unable to resend verification email. Please contact support.');
            }
        });

        // Intersection Observer for section animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        // Observe all animated elements
        document.querySelectorAll('.section-fade').forEach(el => {
            observer.observe(el);
        });
    </script>
</body>
</html>
