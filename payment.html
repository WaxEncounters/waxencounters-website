<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Complete Your Order - Wax Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/vacation.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .text-overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border-radius: 20px; padding: 2rem; border: 1px solid rgba(199, 122, 180, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .section-fade { opacity: 0; transform: translateY(40px); transition: opacity 1.2s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .section-fade.visible { opacity: 1; transform: translateY(0); }
        .payment-method { border: 2px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .payment-method:hover { border-color: rgba(199, 122, 180, 0.5); }
        .payment-method.selected { border-color: #c77ab4; background: rgba(199, 122, 180, 0.1); }
    </style>
    <link rel="icon" href="data:,">
    <script src="js/purchase-tracker.js"></script>
    <!-- EasyPost SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@easypost/api@5.0.0/dist/easypost.min.js"></script>
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <!-- Desktop Navigation -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="index.html#hero" class="hover:text-gray-300 transition-colors duration-200">Home</a>
                        <a href="about.html" class="hover:text-gray-300 transition-colors duration-200">About Us</a>
                        <a href="print.html" class="hover:text-gray-300 transition-colors duration-200">Print Your Vinyl</a>
                        <a href="supportarecord.html" class="hover:text-gray-300 transition-colors duration-200">Support a Record</a>
                        <a href="collection.html" class="hover:text-gray-300 transition-colors duration-200">Collection</a>
                        <a href="account.html" class="hover:text-gray-300 transition-colors duration-200">My Account</a>
                        <a href="contact.html" class="hover:text-gray-300 transition-colors duration-200">Contact</a>
                    </div>
                </div>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" id="mobile-menu-button" class="text-gray-300 hover:text-white focus:outline-none focus:text-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile menu panel -->
        <div id="mobile-menu" class="md:hidden hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-black bg-opacity-90 backdrop-filter backdrop-blur-lg border-t border-white border-opacity-10">
                <a href="index.html#hero" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">Home</a>
                <a href="about.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">About Us</a>
                <a href="print.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">Print Your Vinyl</a>
                <a href="supportarecord.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">Support a Record</a>
                <a href="collection.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">Collection</a>
                <a href="account.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">My Account</a>
                <a href="contact.html" class="block px-3 py-2 text-base font-medium hover:text-gray-300 transition-colors duration-200">Contact</a>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-16 sm:pt-24">
        <section class="relative">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="text-overlay inline-block">
                        <h1 id="mainHeading" class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Complete Your Order</h1>
                        <p id="mainDescription" class="text-lg text-gray-300">Complete your vinyl record purchase.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                    <!-- Order Summary -->
                    <div class="glass-card rounded-2xl p-4 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Order Summary</h3>
                        
                        <!-- Product Info -->
                        <div class="flex items-center space-x-3 sm:space-x-4 mb-4 sm:mb-6 p-3 sm:p-4 bg-white bg-opacity-5 rounded-xl">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-base sm:text-lg truncate">Ethereal Dreams</h4>
                                <p class="text-gray-400 text-sm sm:text-base truncate">by Luna Nova</p>
                                <p class="text-xs sm:text-sm text-gray-500 truncate">Vinyl Record Pre-order</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-lg sm:text-xl font-bold">€35</p>
                            </div>
                        </div>

                        <!-- Quantity Selector -->
                        <div class="mb-4 flex items-center justify-between bg-white bg-opacity-5 rounded-xl p-3 sm:p-4">
                            <label for="quantity" class="text-sm font-medium">Quantity</label>
                            <div class="flex items-center gap-2">
                                <button type="button" id="qtyMinus" class="px-3 py-1 bg-white bg-opacity-10 rounded">−</button>
                                <input id="quantity" type="number" min="1" value="1" class="w-16 text-center px-2 py-1 bg-white bg-opacity-10 rounded border border-white border-opacity-20">
                                <button type="button" id="qtyPlus" class="px-3 py-1 bg-white bg-opacity-10 rounded">+</button>
                            </div>
                        </div>

                        <!-- Campaign Progress (for pre-orders only) -->
                        <div id="campaignProgress" class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">Campaign Progress</span>
                                <span class="text-sm text-gray-400">78 / 100</span>
                            </div>
                            <div class="w-full bg-white bg-opacity-10 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-pink-400 to-purple-400 h-3 rounded-full" style="width: 78%;"></div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">22 days remaining to reach funding goal</p>
                        </div>

                        <!-- Order Details -->
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Vinyl Record</span>
                                <span class="items-subtotal">€35.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Shipping</span>
                                <span class="shipping-cost">€5.00</span>
                            </div>
                            <div class="border-t border-white border-opacity-20 pt-3">
                                <div class="flex justify-between text-lg font-semibold">
                                    <span>Total</span>
                                    <span class="order-total">€40.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Important Notice -->
                        <div id="importantNotice" class="bg-yellow-400 bg-opacity-10 border border-yellow-400 border-opacity-30 rounded-lg p-4">
                            <p class="text-sm text-yellow-300">
                                <strong>Important:</strong> This is a pre-order. If the campaign doesn't reach its funding goal, you'll receive a full refund automatically.
                            </p>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div class="glass-card rounded-2xl p-4 sm:p-8">
                        <h3 class="text-2xl font-bold mb-6">Payment Information</h3>
                        
                        <form id="paymentForm" class="space-y-6">
                            <!-- Payment Method Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">Payment Method</label>
                                <div class="space-y-3">
                                    <div class="payment-method bg-white bg-opacity-5 rounded-xl p-4" data-method="card">
                                        <div class="flex items-center space-x-3">
                                            <input type="radio" name="paymentMethod" value="card" class="text-pink-400 focus:ring-pink-400" checked>
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                                            </svg>
                                            <span>Credit/Debit Card</span>
                                        </div>
                                    </div>
                                    <div class="payment-method bg-white bg-opacity-5 rounded-xl p-4" data-method="paypal">
                                        <div class="flex items-center space-x-3">
                                            <input type="radio" name="paymentMethod" value="paypal" class="text-pink-400 focus:ring-pink-400">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            <span>PayPal</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Information -->
                            <div class="border-t border-white border-opacity-20 pt-4">
                                <h4 class="text-md font-semibold mb-3">Personal Information</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">First Name *</label>
                                        <input type="text" name="firstName" required placeholder="John" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Last Name *</label>
                                        <input type="text" name="lastName" required placeholder="Doe" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label for="email" class="block text-xs font-medium text-gray-300 mb-1">Email *</label>
                                        <input type="email" id="email" name="email" required placeholder="you@example.com" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- Card Details (shown by default) -->
                            <div id="cardDetails" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-300 mb-1">Card Number</label>
                                    <input type="text" placeholder="1234 5678 9012 3456" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Expiry Date</label>
                                        <input type="text" placeholder="MM/YY" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">CVV</label>
                                        <input type="text" placeholder="123" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-300 mb-1">Cardholder Name</label>
                                    <input type="text" placeholder="John Doe" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                </div>
                            </div>

                            <!-- Billing Address -->
                            <div class="border-t border-white border-opacity-20 pt-4">
                                <div class="flex items-center mb-3">
                                    <input type="checkbox" id="differentBilling" class="mr-2 text-pink-400 focus:ring-pink-400">
                                    <label for="differentBilling" class="text-sm font-medium text-gray-300">Billing address is different from shipping address</label>
                                </div>
                                <div id="billingAddressFields" class="hidden space-y-3">
                                    <h4 class="text-md font-semibold mb-3">Billing Address</h4>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Address</label>
                                        <input type="text" placeholder="123 Main Street" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">City</label>
                                            <input type="text" placeholder="New York" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">Postal Code</label>
                                            <input type="text" placeholder="10001" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Information -->
                            <div class="border-t border-white border-opacity-20 pt-4">
                                <h4 class="text-md font-semibold mb-3">Shipping Information</h4>
                                
                                <!-- Shipping Address Form -->
                                <div class="space-y-3">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">First Name *</label>
                                            <input type="text" id="shippingFirstName" placeholder="John" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">Last Name *</label>
                                            <input type="text" id="shippingLastName" placeholder="Doe" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Street Address *</label>
                                        <input type="text" id="shippingAddress" placeholder="123 Main Street" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Apartment, suite, etc. (optional)</label>
                                        <input type="text" id="shippingAddress2" placeholder="Apt 4B" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm">
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">City *</label>
                                            <input type="text" id="shippingCity" placeholder="New York" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">State/Province *</label>
                                            <input type="text" id="shippingState" placeholder="NY" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-300 mb-1">ZIP/Postal Code *</label>
                                            <input type="text" id="shippingPostalCode" placeholder="10001" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Country *</label>
                                        <select id="shippingCountry" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-sm" required>
                                            <option value="">Select Country</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Calculate Shipping Button -->
                                    <button type="button" id="calculateShippingBtn" class="w-full premium-button px-4 py-2 text-black font-semibold rounded-lg hover:scale-105 transition-transform duration-200 text-sm">
                                        🚚 Calculate Shipping Options
                                    </button>
                                    
                                    <!-- Shipping Options Display -->
                                    <div id="shippingOptions" class="hidden space-y-3">
                                        <h5 class="text-md font-semibold text-pink-400">Choose Shipping Method:</h5>
                                        <div id="shippingMethodsList" class="space-y-2">
                                            <!-- Shipping options will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Shipping Error Display -->
                                    <div id="shippingError" class="hidden bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-lg p-4">
                                        <p class="text-sm text-red-300" id="shippingErrorMessage"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms Agreement -->
                            <div class="flex items-start space-x-3">
                                <input id="paymentTerms" type="checkbox" required class="h-5 w-5 rounded border-white border-opacity-20 bg-white bg-opacity-10 text-pink-400 focus:ring-pink-400 mt-1">
                                <label for="paymentTerms" id="termsLabel" class="text-sm text-gray-300 leading-relaxed">
                                    I agree to the <a href="#" class="text-pink-400 hover:text-pink-300">Terms of Service</a> and understand that this is a pre-order. If the campaign doesn't reach its funding goal, I will receive a full refund.
                                </label>
                            </div>

                            <!-- Complete Order Button -->
                            <button id="submitButton" type="submit" class="premium-button w-full px-6 py-3 sm:px-8 sm:py-4 text-black font-semibold rounded-xl text-base sm:text-lg hover:scale-105 transition-transform duration-200">
                                Complete Order - €40.00
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Purchase Confirmation Modal -->
    <div id="purchaseModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass-card rounded-2xl p-6 sm:p-8 max-w-md w-full text-center">
                <div class="mx-auto mb-4 w-14 h-14 rounded-full bg-gradient-to-br from-pink-400 to-purple-400 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-2">Thank you for your purchase!</h3>
                <p class="text-gray-300 mb-6">We will send you an email soon with your tracking.</p>
                <button id="purchaseModalClose" class="premium-button px-6 py-2 rounded-lg text-black font-semibold">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Check URL parameters and update page content accordingly
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const recordId = urlParams.get('recordId');
            const type = urlParams.get('type');
            
            console.log('=== PAYMENT PAGE LOADED ===');
            console.log('Payment page URL params:', { recordId, type });
            console.log('Current URL:', window.location.href);
            console.log('Document referrer:', document.referrer);
            console.log('Page title:', document.title);
            
            // Load record data if recordId is provided
            if (recordId) {
                loadRecordData(recordId, type);
            } else {
                // Fallback to referrer-based detection
                const referrer = document.referrer;
                console.log('Payment page referrer:', referrer);
                
                // Check if user came from collection page (direct purchase)
                const isFromCollection = referrer.includes('collection.html') || 
                                       referrer.includes('collection') ||
                                       window.location.search.includes('type=direct');
                
                console.log('Is from collection:', isFromCollection);
                
                if (isFromCollection) {
                    // User came from collection page - direct purchase
                    console.log('Updating page for direct purchase');
                    updatePageForDirectPurchase();
                } else {
                    // User came from support a record page - pre-order
                    console.log('Updating page for pre-order');
                    updatePageForPreOrder();
                }
            }
        });

        function updatePageForDirectPurchase() {
            // Update page title
            document.getElementById('pageTitle').textContent = 'Buy Your Record - Wax Encounters';
            
            // Update main heading
            document.getElementById('mainHeading').textContent = 'Buy Your Record';
            
            // Update description
            document.getElementById('mainDescription').textContent = 'Complete your vinyl record purchase.';
            
            // Hide campaign progress section
            document.getElementById('campaignProgress').style.display = 'none';
            
            // Update important notice
            const notice = document.getElementById('importantNotice');
            notice.className = 'bg-green-400 bg-opacity-10 border border-green-400 border-opacity-30 rounded-lg p-4';
            notice.innerHTML = '<p class="text-sm text-green-300"><strong>Ready to Ship:</strong> This record is already pressed and ready for immediate shipping.</p>';
            
            // Update submit button
            document.getElementById('submitButton').textContent = 'Buy Record - €40.00';
            
            // Update terms text
            document.getElementById('termsLabel').innerHTML = 'I agree to the <a href="#" class="text-pink-400 hover:text-pink-300">Terms of Service</a> and understand that this is a direct purchase.';
        }

        function updatePageForPreOrder() {
            // Keep all pre-order content as is
            // This is the default state
        }

        // Load record data from localStorage and update page
        function loadRecordData(recordId, type) {
            console.log('=== LOADING RECORD DATA ===');
            console.log('Function called with:', { recordId, type });
            
            try {
                const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
                console.log('All records in localStorage:', records);
                console.log('Looking for record ID:', recordId);
                console.log('Record type:', type);
                
                const record = records.find(r => r.id === recordId);
                
                if (!record) {
                    console.error('Record not found:', recordId);
                    console.log('Available record IDs:', records.map(r => r.id));
                    console.log('ERROR: Record not found. Please try again.');
                    // Don't redirect - just show error message
                    document.body.innerHTML = `
                        <div class="min-h-screen bg-black text-white flex items-center justify-center">
                            <div class="text-center">
                                <h1 class="text-2xl font-bold mb-4">Record Not Found</h1>
                                <p class="mb-4">The record with ID "${recordId}" was not found.</p>
                                <p class="mb-4">Available records: ${records.map(r => r.id).join(', ')}</p>
                                <a href="supportarecord.html" class="bg-blue-500 text-white px-4 py-2 rounded">Back to Support a Record</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                console.log('Loaded record:', record);
                
                // Update page content based on record type
                if (type === 'crowdfunding' || record.type === 'crowdfunding') {
                    updatePageForCrowdfundingRecord(record, recordId);
                } else if (type === 'immediate' || record.type === 'immediate') {
                    updatePageForImmediateRecord(record, recordId);
                } else {
                    // Default to crowdfunding if type is unclear
                    updatePageForCrowdfundingRecord(record, recordId);
                }
                
            } catch (error) {
                console.error('Error loading record data:', error);
                console.log('ERROR: Error loading record data. Please try again.');
                // Don't redirect - just show error message
                document.body.innerHTML = `
                    <div class="min-h-screen bg-black text-white flex items-center justify-center">
                        <div class="text-center">
                            <h1 class="text-2xl font-bold mb-4">Error Loading Record</h1>
                            <p class="mb-4">There was an error loading the record data.</p>
                            <p class="mb-4">Error: ${error.message}</p>
                            <a href="supportarecord.html" class="bg-blue-500 text-white px-4 py-2 rounded">Back to Support a Record</a>
                        </div>
                    </div>
                `;
            }
        }

        // Update page for crowdfunding record
        function updatePageForCrowdfundingRecord(record, recordId) {
            // Update page title
            document.getElementById('pageTitle').textContent = `Pre-order ${record.albumTitle} - Wax Encounters`;
            
            // Update main heading
            document.getElementById('mainHeading').textContent = 'Complete Your Pre-order';
            
            // Update description
            document.getElementById('mainDescription').textContent = `Pre-order "${record.albumTitle}" by ${record.artistName}`;
            
            // Update product info
            const productInfo = document.querySelector('.flex.items-center.space-x-4.mb-6');
            if (productInfo) {
                productInfo.innerHTML = `
                    <div class="w-20 h-20 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center overflow-hidden">
                        <img src="${record.coverImage || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                             alt="${record.albumTitle}" 
                             class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${record.albumTitle}</h4>
                        <p class="text-gray-400">by ${record.artistName}</p>
                        <p class="text-sm text-gray-500">Vinyl Record Pre-order</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold">€${record.price}</p>
                    </div>
                `;
            }
            
            // Update campaign progress
            const progressPercentage = Math.min((record.raised / record.fundingGoal) * 100, 100);
            const daysLeft = calculateDaysLeft(record.startDate, record.campaignDays);
            
            const campaignProgress = document.getElementById('campaignProgress');
            if (campaignProgress) {
                campaignProgress.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Campaign Progress</span>
                        <span class="text-sm text-gray-400">${record.backers || 0} / ${Math.ceil(record.fundingGoal / record.price)}</span>
                    </div>
                    <div class="w-full bg-white bg-opacity-10 rounded-full h-3 overflow-hidden">
                        <div class="bg-gradient-to-r from-pink-400 to-purple-400 h-3 rounded-full" style="width: ${progressPercentage}%;"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">${daysLeft} days remaining to reach funding goal</p>
                `;
            }
            
            // Update order details
            const orderDetails = document.querySelector('.space-y-3.mb-6');
            if (orderDetails) {
                orderDetails.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-300">Vinyl Record</span>
                        <span class="items-subtotal">€${record.price.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Shipping</span>
                        <span class="shipping-cost">€5.00</span>
                    </div>
                    <div class="border-t border-white border-opacity-20 pt-3">
                        <div class="flex justify-between text-lg font-semibold">
                            <span>Total</span>
                            <span class="order-total">€${(record.price + 5).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            // Update submit button
            document.getElementById('submitButton').textContent = `Complete Pre-order - €${(record.price + 5).toFixed(2)}`;
            
            // Store record ID for payment processing
            window.currentRecordId = recordId;
            window.currentRecordType = 'crowdfunding';
        }

        // Update page for immediate sale record
        function updatePageForImmediateRecord(record, recordId) {
            // Update page title
            document.getElementById('pageTitle').textContent = `Buy ${record.albumTitle} - Wax Encounters`;
            
            // Update main heading
            document.getElementById('mainHeading').textContent = 'Buy Your Record';
            
            // Update description
            document.getElementById('mainDescription').textContent = `Buy "${record.albumTitle}" by ${record.artistName}`;
            
            // Update product info
            const productInfo = document.querySelector('.flex.items-center.space-x-4.mb-6');
            if (productInfo) {
                productInfo.innerHTML = `
                    <div class="w-20 h-20 bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg flex items-center justify-center overflow-hidden">
                        <img src="${record.coverImage || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" 
                             alt="${record.albumTitle}" 
                             class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg">${record.albumTitle}</h4>
                        <p class="text-gray-400">by ${record.artistName}</p>
                        <p class="text-sm text-gray-500">Vinyl Record</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold">€${record.price}</p>
                    </div>
                `;
            }
            
            // Hide campaign progress section
            document.getElementById('campaignProgress').style.display = 'none';
            
            // Update order details
            const orderDetails = document.querySelector('.space-y-3.mb-6');
            if (orderDetails) {
                orderDetails.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-300">Vinyl Record</span>
                        <span class="items-subtotal">€${record.price.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Shipping</span>
                        <span class="shipping-cost">€5.00</span>
                    </div>
                    <div class="border-t border-white border-opacity-20 pt-3">
                        <div class="flex justify-between text-lg font-semibold">
                            <span>Total</span>
                            <span class="order-total">€${(record.price + 5).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            // Update important notice
            const notice = document.getElementById('importantNotice');
            notice.className = 'bg-green-400 bg-opacity-10 border border-green-400 border-opacity-30 rounded-lg p-4';
            notice.innerHTML = '<p class="text-sm text-green-300"><strong>Ready to Ship:</strong> This record is already pressed and ready for immediate shipping.</p>';
            
            // Update submit button
            document.getElementById('submitButton').textContent = `Buy Record - €${(record.price + 5).toFixed(2)}`;
            
            // Update terms text
            document.getElementById('termsLabel').innerHTML = 'I agree to the <a href="#" class="text-pink-400 hover:text-pink-300">Terms of Service</a> and understand that this is a direct purchase.';
            
            // Store record ID for payment processing
            window.currentRecordId = recordId;
            window.currentRecordType = 'immediate';
        }

        // Calculate days left for campaign
        function calculateDaysLeft(startDate, campaignDays) {
            const start = new Date(startDate);
            const end = new Date(start.getTime() + (campaignDays * 24 * 60 * 60 * 1000));
            const now = new Date();
            const diffTime = end - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        // Intersection Observer for section animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        // Observe all animated elements
        document.querySelectorAll('.section-fade').forEach(el => {
            observer.observe(el);
        });

        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                // Remove selected class from all methods
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                // Add selected class to clicked method
                this.classList.add('selected');
                // Check the radio button
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Payment form submission
        const paymentForm = document.getElementById('paymentForm');
        if (paymentForm) {
            paymentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(paymentForm);
                const firstName = formData.get('firstName');
                const lastName = formData.get('lastName');
                const email = (formData.get('email') || '').trim();
                const termsAccepted = document.getElementById('paymentTerms').checked;
                
                // Validate required fields
                if (!firstName || !lastName) {
                    alert('Please fill in your first name and last name');
                    return;
                }
                if (!email) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                if (!termsAccepted) {
                    alert('Please accept the terms and conditions to complete your order');
                    return;
                }
                
                // Process payment with purchase tracker
                processPayment(firstName, lastName, formData);
            });
        }

        // Process payment and update inventory/campaigns
        function processPayment(firstName, lastName, formData) {
            try {
                // Get record details from stored variables or URL parameters
                const recordId = window.currentRecordId;
                const recordType = window.currentRecordType;
                
                if (!recordId) {
                    console.log('ERROR: No record selected. Please try again.');
                    return;
                }
                
                // Get the record data to get the price
                const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
                const record = records.find(r => r.id === recordId);
                
                if (!record) {
                    console.log('ERROR: Record not found. Please try again.');
                    return;
                }
                
                const price = record.price;
                
                // Create sample records if they don't exist (for demo)
                createSampleRecordsIfNeeded();
                
                let success = false;
                let message = '';
                
                if (recordType === 'immediate' || record.type === 'immediate') {
                    // Process immediate sale
                    success = window.PurchaseTracker.processImmediatePurchase(recordId, 1);
                    message = success ? 
                        `Purchase successful! Your record will be shipped to ${firstName} ${lastName}.` :
                        'Purchase failed. Please try again.';
                } else {
                    // Process crowdfunding pre-order
                    success = window.PurchaseTracker.processCrowdfundingPurchase(recordId, price);
                    message = success ? 
                        `Pre-order successful! Thank you ${firstName} ${lastName} for supporting this campaign.` :
                        'Pre-order failed. Please try again.';
                }
                
                if (success) {
                    // Store order details
                    const lastSelected = JSON.parse(localStorage.getItem('lastSelectedShipping') || 'null');
                    let resolvedEmail = '';
                    const sessionLoggedIn = !!(window.SecureStorageManager && window.SecureStorageManager.isSessionValid());
                    try {
                        resolvedEmail = (document.getElementById('email')?.value || localStorage.getItem('userEmail') || localStorage.getItem('verifiedEmail') || '').trim();
                        if (!resolvedEmail) {
                            const cachedData = localStorage.getItem('cachedDisplayData');
                            if (cachedData) {
                                const parsed = JSON.parse(cachedData);
                                resolvedEmail = parsed.email || '';
                            }
                        }
                    } catch (e) {
                        console.warn('Error resolving email:', e);
                        resolvedEmail = localStorage.getItem('userEmail') || '';
                    }
                    const orderDetails = {
                        id: 'order_' + Date.now(),
                        customerName: `${firstName} ${lastName}`,
                        customerEmail: sessionLoggedIn ? (resolvedEmail || 'unknown') : 'unknown',
                        contactEmail: !sessionLoggedIn ? (resolvedEmail || '') : undefined,
                        recordId: recordId,
                        recordTitle: record.albumTitle,
                        recordArtist: record.artistName,
                        amount: price,
                        type: recordType || record.type,
                        timestamp: new Date().toISOString(),
                        status: 'completed',
                        isGuest: !sessionLoggedIn,
                        labelGenerated: false,
                        trackingNumber: null,
                        shipmentId: null,
                        // Persist shipping data with the order (if available)
                        shipping: lastSelected && lastSelected.method ? {
                            serviceId: lastSelected.method.id,
                            carrier: lastSelected.method.carrier,
                            serviceName: lastSelected.method.serviceName,
                            price: lastSelected.method.price
                        } : null,
                        recipient: lastSelected && lastSelected.recipientAddress ? lastSelected.recipientAddress : {
                            firstName, lastName,
                            address1: formData.address1 || '', address2: formData.address2 || '',
                            city: formData.city || '', state: '', postalCode: formData.zip || '', country: formData.country || ''
                        },
                        parcel: lastSelected && lastSelected.parcel ? lastSelected.parcel : { lengthCm: 33, widthCm: 33, heightCm: 3, weightKg: 0.8 }
                    };
                    
                    // Save order to localStorage (in production, this would go to a database)
                    const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    existingOrders.push(orderDetails);
                    localStorage.setItem('orders', JSON.stringify(existingOrders));
                    
                    // Update user's total spent in userData (only for logged-in users)
                    if (sessionLoggedIn && resolvedEmail) {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        userData[resolvedEmail] = userData[resolvedEmail] || { preOrders: [], totalSpent: 0 };
                        userData[resolvedEmail].totalSpent = (userData[resolvedEmail].totalSpent || 0) + price;
                        userData[resolvedEmail].preOrders = userData[resolvedEmail].preOrders || [];
                        userData[resolvedEmail].preOrders.push({
                            recordId: recordId,
                            recordTitle: record.albumTitle,
                            amount: price,
                            timestamp: new Date().toISOString(),
                            status: 'completed'
                        });
                        localStorage.setItem('userData', JSON.stringify(userData));
                        console.log('Updated user total spent:', userData[resolvedEmail].totalSpent);
                    }
                    
                    // Show purchase confirmation modal
                    const modal = document.getElementById('purchaseModal');
                    const modalBtn = document.getElementById('purchaseModalClose');
                    if (modal) {
                        modal.classList.remove('hidden');
                        if (modalBtn) {
                            modalBtn.onclick = () => modal.classList.add('hidden');
                        }
                    }

                    // Ensure guest users do not appear logged in after purchase
                    try {
                        if (window.SecureStorageManager) {
                            window.SecureStorageManager.clearSession();
                        }
                        localStorage.removeItem('userEmail');
                        localStorage.removeItem('sessionId');
                    } catch (e) {
                        console.warn('Guest logout cleanup failed:', e);
                    }

                    // Redirect: guests to home, logged-in users to account (based on session state)
                    setTimeout(() => {
                        const stillLoggedIn = !!(window.SecureStorageManager && window.SecureStorageManager.isSessionValid());
                        window.location.href = stillLoggedIn ? 'account.html' : 'index.html';
                    }, 2200);
                } else {
                    alert(message);
                }
                
            } catch (error) {
                console.error('Payment processing error:', error);
                alert('An error occurred during payment processing. Please try again.');
            }
        }

        // Create sample records for demo purposes
        function createSampleRecordsIfNeeded() {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            
            // Create sample immediate sale record if it doesn't exist
            if (!records.find(r => r.id === 'sample_immediate_record')) {
                records.push({
                    id: 'sample_immediate_record',
                    type: 'immediate',
                    artistName: 'Demo Artist',
                    albumTitle: 'Sample Album',
                    genre: 'Electronic',
                    description: 'A sample album for immediate purchase',
                    price: 35.00,
                    quantity: 50,
                    sold: 0,
                    status: 'available',
                    uploadedAt: new Date().toISOString()
                });
            }
            
            // Create sample crowdfunding record if it doesn't exist
            if (!records.find(r => r.id === 'sample_crowdfunding_record')) {
                records.push({
                    id: 'sample_crowdfunding_record',
                    type: 'crowdfunding',
                    artistName: 'Crowdfunding Artist',
                    albumTitle: 'Crowdfunding Album',
                    genre: 'Ambient',
                    description: 'A sample album for crowdfunding',
                    price: 35.00,
                    fundingGoal: 3500.00,
                    campaignDays: 30,
                    startDate: new Date().toISOString().split('T')[0],
                    raised: 0,
                    backers: 0,
                    status: 'campaign',
                    uploadedAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('uploadedRecords', JSON.stringify(records));
        }

        // ShipEngine Integration
        class ShippingCalculator {
            constructor() {
                this.shipEngine = null;
                this.selectedShippingMethod = null;
                this.shippingCost = 0;
                this.initializeShipEngine();
                this.setupEventListeners();
            }

            async initializeShipEngine() {
                try {
                    // Initialize ShipEngine with your API key
                    // Note: In production, you'll need to get your API key from ShipEngine
                    this.shipEngine = new ShipEngine({
                        apiKey: 'TEST_API_KEY', // Replace with your actual API key
                        environment: 'sandbox' // Use 'production' for live environment
                    });
                    console.log('ShipEngine initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize ShipEngine:', error);
                }
            }

            setupEventListeners() {
                const calculateBtn = document.getElementById('calculateShippingBtn');
                if (calculateBtn) {
                    calculateBtn.addEventListener('click', () => this.calculateShipping());
                }
            }

            async calculateShipping() {
                // Get shipping address from form
                const address = this.getShippingAddress();
                
                if (!this.validateAddress(address)) {
                    this.showShippingError('Please fill in all required shipping address fields.');
                    return;
                }

                // Quantity and derived parcel weight/dimensions
                const quantity = this.getQuantity();
                const perRecordWeightKg = 0.8;
                const totalWeightKg = Math.max(perRecordWeightKg * quantity, perRecordWeightKg);
                const heightCm = quantity > 10 ? 15 : (quantity > 5 ? 7 : 3.5);

                // Show loading state
                const calculateBtn = document.getElementById('calculateShippingBtn');
                const originalText = calculateBtn.textContent;
                calculateBtn.textContent = '🔄 Calculating...';
                calculateBtn.disabled = true;

                try {
                    // Call backend rates endpoint (Packlink proxy)
                    const body = {
                        recipient: {
                            firstName: address.firstName,
                            lastName: address.lastName,
                            address1: address.address1,
                            address2: address.address2 || '',
                            city: address.city,
                            state: address.state,
                            postalCode: address.postalCode,
                            country: address.country
                        },
                        parcel: {
                            lengthCm: 33,
                            widthCm: 33,
                            heightCm: heightCm,
                            weightKg: totalWeightKg
                        },
                        origin: {
                            company: 'Wax Encounters',
                            address1: 'via Monte Sabotino 10',
                            city: 'Bovisio Masciago',
                            postalCode: '20813',
                            country: 'IT',
                            phone: '3474211714'
                        }
                    };
                    // Removed server rates call; use fixed-rate calculator instead
                    const shippingRates = this.getFixedRatesForAddress(address, totalWeightKg, heightCm);
                    this.displayShippingOptions(shippingRates);
                    this.hideShippingError();
                    
                } catch (error) {
                    console.error('Error calculating shipping:', error);
                    this.showShippingError('Unable to calculate shipping rates. Please try again.');
                } finally {
                    // Reset button state
                    calculateBtn.textContent = originalText;
                    calculateBtn.disabled = false;
                }
            }

            getShippingAddress() {
                return {
                    firstName: document.getElementById('shippingFirstName').value.trim(),
                    lastName: document.getElementById('shippingLastName').value.trim(),
                    address1: document.getElementById('shippingAddress').value.trim(),
                    address2: document.getElementById('shippingAddress2').value.trim(),
                    city: document.getElementById('shippingCity').value.trim(),
                    state: document.getElementById('shippingState').value.trim(),
                    postalCode: document.getElementById('shippingPostalCode').value.trim(),
                    country: document.getElementById('shippingCountry').value
                };
            }

            validateAddress(address) {
                const required = ['firstName', 'lastName', 'address1', 'city', 'state', 'postalCode', 'country'];
                return required.every(field => address[field] && address[field].length > 0);
            }

            async getEasyPostShippingRates(address) {
                // Initialize EasyPost with your API key
                // Note: Replace 'YOUR_EASYPOST_API_KEY' with your actual API key
                const apiKey = 'YOUR_EASYPOST_API_KEY'; // You'll need to set this
                
                if (apiKey === 'YOUR_EASYPOST_API_KEY') {
                    // Fallback to simulated rates if API key not set
                    console.log('EasyPost API key not configured, using simulated rates');
                    return await this.getSimulatedShippingRates(address);
                }

                try {
                    // Initialize EasyPost client
                    const client = new EasyPost(apiKey);

                    // Create from address (your business address in Italy)
                    const fromAddress = {
                        name: 'Wax Encounters',
                        street1: 'Via Roma 123',
                        city: 'Milan',
                        state: 'MI',
                        zip: '20100',
                        country: 'IT'
                    };

                    // Create to address (customer address)
                    const toAddress = {
                        name: `${address.firstName} ${address.lastName}`,
                        street1: address.address1,
                        street2: address.address2 || '',
                        city: address.city,
                        state: address.state,
                        zip: address.postalCode,
                        country: address.country
                    };

                    // Create parcel (vinyl record dimensions and weight)
                    const parcel = {
                        length: 30.5, // cm
                        width: 30.5,  // cm
                        height: 2.5,  // cm
                        weight: 0.5   // kg
                    };

                    // Get shipping rates from EasyPost
                    const shipment = await client.Shipment.create({
                        to_address: toAddress,
                        from_address: fromAddress,
                        parcel: parcel
                    });

                    // Format rates for display
                    const rates = shipment.rates.map(rate => ({
                        service: rate.service,
                        cost: (rate.rate / 100).toFixed(2), // Convert cents to euros
                        days: rate.est_delivery_days ? `${rate.est_delivery_days} business days` : 'Varies',
                        carrier: rate.carrier,
                        id: rate.id
                    }));

                    return rates;

                } catch (error) {
                    console.error('EasyPost API error:', error);
                    // Fallback to simulated rates if API fails
                    return await this.getSimulatedShippingRates(address);
                }
            }

            async getSimulatedShippingRates(address) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Simulate different shipping rates based on country
                const baseRates = {
                    'US': [
                        { service: 'USPS Ground', cost: 5.99, days: '5-7 business days', carrier: 'USPS' },
                        { service: 'UPS Ground', cost: 8.99, days: '3-5 business days', carrier: 'UPS' },
                        { service: 'FedEx Ground', cost: 9.99, days: '3-5 business days', carrier: 'FedEx' },
                        { service: 'UPS 2-Day', cost: 15.99, days: '2 business days', carrier: 'UPS' },
                        { service: 'FedEx 2-Day', cost: 16.99, days: '2 business days', carrier: 'FedEx' },
                        { service: 'UPS Next Day', cost: 25.99, days: '1 business day', carrier: 'UPS' }
                    ],
                    'CA': [
                        { service: 'Canada Post Standard', cost: 12.99, days: '7-10 business days', carrier: 'Canada Post' },
                        { service: 'UPS Standard', cost: 18.99, days: '5-7 business days', carrier: 'UPS' },
                        { service: 'FedEx International', cost: 22.99, days: '3-5 business days', carrier: 'FedEx' }
                    ],
                    'GB': [
                        { service: 'Royal Mail Standard', cost: 8.99, days: '5-7 business days', carrier: 'Royal Mail' },
                        { service: 'DHL Express', cost: 19.99, days: '2-3 business days', carrier: 'DHL' },
                        { service: 'UPS Express', cost: 24.99, days: '1-2 business days', carrier: 'UPS' }
                    ],
                    'DE': [
                        { service: 'DHL Standard', cost: 9.99, days: '3-5 business days', carrier: 'DHL' },
                        { service: 'DHL Express', cost: 18.99, days: '1-2 business days', carrier: 'DHL' },
                        { service: 'UPS Express', cost: 22.99, days: '1-2 business days', carrier: 'UPS' }
                    ],
                    'IT': [
                        { service: 'Poste Italiane Standard', cost: 7.99, days: '5-7 business days', carrier: 'Poste Italiane' },
                        { service: 'DHL Express', cost: 16.99, days: '2-3 business days', carrier: 'DHL' },
                        { service: 'UPS Express', cost: 19.99, days: '1-2 business days', carrier: 'UPS' }
                    ]
                };

                // Get rates for the selected country, or default to Italy rates
                const countryRates = baseRates[address.country] || baseRates['IT'];
                
                // Add some variation based on postal code (simulate distance)
                return countryRates.map(rate => ({
                    ...rate,
                    cost: (rate.cost + (Math.random() * 2 - 1)).toFixed(2), // Add ±€1 variation
                    id: `shipping_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                }));
            }

            displayShippingOptions(rates) {
                const shippingOptions = document.getElementById('shippingOptions');
                const shippingMethodsList = document.getElementById('shippingMethodsList');
                
                // Clear previous options
                shippingMethodsList.innerHTML = '';
                
                // Create shipping method options
                rates.forEach((rate, index) => {
                    const option = document.createElement('div');
                    option.className = 'shipping-option bg-white bg-opacity-5 rounded-xl p-4 cursor-pointer hover:bg-opacity-10 transition-all duration-200 border-2 border-transparent';
                    option.dataset.shippingId = rate.id;
                    option.dataset.cost = rate.cost.toFixed(2);
                    
                    option.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <input type="radio" name="shippingMethod" value="${rate.id}" class="text-pink-400 focus:ring-pink-400" ${index === 0 ? 'checked' : ''}>
                                <div>
                                    <div class="font-semibold">${rate.service}</div>
                                    <div class="text-sm text-gray-400">${rate.days}</div>
                                    ${rate.carrier ? `<div class="text-xs text-pink-300">via ${rate.carrier}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg">€${rate.cost.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler
                    option.addEventListener('click', () => this.selectShippingMethod(rate));
                    
                    shippingMethodsList.appendChild(option);
                });
                
                // Show shipping options
                shippingOptions.classList.remove('hidden');
                
                // Select first option by default
                if (rates.length > 0) {
                    this.selectShippingMethod(rates[0]);
                }
            }

            selectShippingMethod(rate) {
                // Update selected method
                this.selectedShippingMethod = rate;
                this.shippingCost = rate.cost;
                
                // Update visual selection
                document.querySelectorAll('.shipping-option').forEach(option => {
                    option.classList.remove('border-pink-400', 'bg-pink-400', 'bg-opacity-10');
                });
                
                const selectedOption = document.querySelector(`[data-shipping-id="${rate.id}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('border-pink-400', 'bg-pink-400', 'bg-opacity-10');
                }
                
                // Update radio button
                const radio = document.querySelector(`input[value="${rate.id}"]`);
                if (radio) {
                    radio.checked = true;
                }
                
                // Update order total using current quantity
                this.updateOrderTotal();

                // Persist selection and address for admin label generation
                try {
                    const address = this.getShippingAddress();
                    const quantity = this.getQuantity();
                    const heightCm = quantity > 10 ? 15 : (quantity > 5 ? 7 : 3.5);
                    const payload = {
                        selection: {
                            id: rate.id,
                            carrier: rate.carrier,
                            serviceName: rate.serviceName || rate.service,
                            price: rate.cost
                        },
                        recipientAddress: address,
                        parcel: { lengthCm: 33, widthCm: 33, heightCm: heightCm, weightKg: Math.max(0.8 * quantity, 0.8) },
                        quantity
                    };
                    localStorage.setItem('lastSelectedShipping', JSON.stringify(payload));
                } catch (e) {
                    console.warn('Could not persist shipping selection:', e);
                }
            }

            updateOrderTotal() {
                // Get the record price
                const recordPrice = this.getRecordPrice();
                const quantity = this.getQuantity();
                const itemsSubtotal = recordPrice * quantity;
                const total = itemsSubtotal + this.shippingCost;
                
                // Update shipping cost display
                const shippingElements = document.querySelectorAll('.shipping-cost');
                shippingElements.forEach(el => {
                    el.textContent = `€${this.shippingCost.toFixed(2)}`;
                });
                
                // Update items subtotal
                const itemsEls = document.querySelectorAll('.items-subtotal');
                itemsEls.forEach(el => {
                    el.textContent = `€${itemsSubtotal.toFixed(2)}`;
                });

                // Update total display
                const totalElements = document.querySelectorAll('.order-total');
                totalElements.forEach(el => {
                    el.textContent = `€${total.toFixed(2)}`;
                });
                
                // Update submit button
                const submitButton = document.getElementById('submitButton');
                if (submitButton) {
                    const buttonText = submitButton.textContent.split(' - ')[0];
                    submitButton.textContent = `${buttonText} - €${total.toFixed(2)}`;
                }
            }

            getRecordPrice() {
                // Try to get price from current record data
                if (window.currentRecord) {
                    return window.currentRecord.price || 35;
                }
                
                // Fallback to default price
                return 35;
            }

            getQuantity() {
                const input = document.getElementById('quantity');
                const value = Number(input?.value || 1);
                return Math.max(1, Math.floor(value));
            }

            showShippingError(message) {
                const errorDiv = document.getElementById('shippingError');
                const errorMessage = document.getElementById('shippingErrorMessage');
                
                if (errorDiv && errorMessage) {
                    errorMessage.textContent = message;
                    errorDiv.classList.remove('hidden');
                }
            }

            hideShippingError() {
                const errorDiv = document.getElementById('shippingError');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }

            getSelectedShippingMethod() {
                return this.selectedShippingMethod;
            }
        }

        // Initialize shipping calculator when page loads
        let shippingCalculator;
        document.addEventListener('DOMContentLoaded', function() {
            shippingCalculator = new ShippingCalculator();
            // Populate country list fully
            const countrySelect = document.getElementById('shippingCountry');
            if (countrySelect && countrySelect.options.length <= 1) {
                // Ensure select text is visible
                countrySelect.style.color = '#ffffff';
                countrySelect.style.backgroundColor = 'rgba(255,255,255,0.10)';
                const countries = [
                    { code: 'AF', name: 'Afghanistan' },{ code: 'AL', name: 'Albania' },{ code: 'DZ', name: 'Algeria' },{ code: 'AD', name: 'Andorra' },{ code: 'AO', name: 'Angola' },{ code: 'AG', name: 'Antigua and Barbuda' },{ code: 'AR', name: 'Argentina' },{ code: 'AM', name: 'Armenia' },{ code: 'AU', name: 'Australia' },{ code: 'AT', name: 'Austria' },{ code: 'AZ', name: 'Azerbaijan' },
                    { code: 'BS', name: 'Bahamas' },{ code: 'BH', name: 'Bahrain' },{ code: 'BD', name: 'Bangladesh' },{ code: 'BB', name: 'Barbados' },{ code: 'BY', name: 'Belarus' },{ code: 'BE', name: 'Belgium' },{ code: 'BZ', name: 'Belize' },{ code: 'BJ', name: 'Benin' },{ code: 'BT', name: 'Bhutan' },{ code: 'BO', name: 'Bolivia' },{ code: 'BA', name: 'Bosnia and Herzegovina' },{ code: 'BW', name: 'Botswana' },{ code: 'BR', name: 'Brazil' },{ code: 'BN', name: 'Brunei' },{ code: 'BG', name: 'Bulgaria' },{ code: 'BF', name: 'Burkina Faso' },{ code: 'BI', name: 'Burundi' },
                    { code: 'KH', name: 'Cambodia' },{ code: 'CM', name: 'Cameroon' },{ code: 'CA', name: 'Canada' },{ code: 'CV', name: 'Cape Verde' },{ code: 'CF', name: 'Central African Republic' },{ code: 'TD', name: 'Chad' },{ code: 'CL', name: 'Chile' },{ code: 'CN', name: 'China' },{ code: 'CO', name: 'Colombia' },{ code: 'KM', name: 'Comoros' },{ code: 'CG', name: 'Congo' },{ code: 'CR', name: 'Costa Rica' },{ code: 'HR', name: 'Croatia' },{ code: 'CU', name: 'Cuba' },{ code: 'CY', name: 'Cyprus' },{ code: 'CZ', name: 'Czech Republic' },
                    { code: 'DK', name: 'Denmark' },{ code: 'DJ', name: 'Djibouti' },{ code: 'DM', name: 'Dominica' },{ code: 'DO', name: 'Dominican Republic' },
                    { code: 'EC', name: 'Ecuador' },{ code: 'EG', name: 'Egypt' },{ code: 'SV', name: 'El Salvador' },{ code: 'GQ', name: 'Equatorial Guinea' },{ code: 'ER', name: 'Eritrea' },{ code: 'EE', name: 'Estonia' },{ code: 'SZ', name: 'Eswatini' },{ code: 'ET', name: 'Ethiopia' },
                    { code: 'FJ', name: 'Fiji' },{ code: 'FI', name: 'Finland' },{ code: 'FR', name: 'France' },
                    { code: 'GA', name: 'Gabon' },{ code: 'GM', name: 'Gambia' },{ code: 'GE', name: 'Georgia' },{ code: 'DE', name: 'Germany' },{ code: 'GH', name: 'Ghana' },{ code: 'GR', name: 'Greece' },{ code: 'GD', name: 'Grenada' },{ code: 'GT', name: 'Guatemala' },{ code: 'GN', name: 'Guinea' },{ code: 'GW', name: 'Guinea-Bissau' },{ code: 'GY', name: 'Guyana' },
                    { code: 'HT', name: 'Haiti' },{ code: 'HN', name: 'Honduras' },{ code: 'HK', name: 'Hong Kong' },{ code: 'HU', name: 'Hungary' },
                    { code: 'IS', name: 'Iceland' },{ code: 'IN', name: 'India' },{ code: 'ID', name: 'Indonesia' },{ code: 'IR', name: 'Iran' },{ code: 'IQ', name: 'Iraq' },{ code: 'IE', name: 'Ireland' },{ code: 'IL', name: 'Israel' },{ code: 'IT', name: 'Italy' },
                    { code: 'JM', name: 'Jamaica' },{ code: 'JP', name: 'Japan' },{ code: 'JO', name: 'Jordan' },
                    { code: 'KZ', name: 'Kazakhstan' },{ code: 'KE', name: 'Kenya' },{ code: 'KI', name: 'Kiribati' },{ code: 'KR', name: 'South Korea' },{ code: 'KW', name: 'Kuwait' },{ code: 'KG', name: 'Kyrgyzstan' },
                    { code: 'LA', name: 'Laos' },{ code: 'LV', name: 'Latvia' },{ code: 'LB', name: 'Lebanon' },{ code: 'LS', name: 'Lesotho' },{ code: 'LR', name: 'Liberia' },{ code: 'LY', name: 'Libya' },{ code: 'LI', name: 'Liechtenstein' },{ code: 'LT', name: 'Lithuania' },{ code: 'LU', name: 'Luxembourg' },
                    { code: 'MO', name: 'Macao' },{ code: 'MG', name: 'Madagascar' },{ code: 'MW', name: 'Malawi' },{ code: 'MY', name: 'Malaysia' },{ code: 'MV', name: 'Maldives' },{ code: 'ML', name: 'Mali' },{ code: 'MT', name: 'Malta' },{ code: 'MH', name: 'Marshall Islands' },{ code: 'MR', name: 'Mauritania' },{ code: 'MU', name: 'Mauritius' },{ code: 'MX', name: 'Mexico' },{ code: 'FM', name: 'Micronesia' },{ code: 'MD', name: 'Moldova' },{ code: 'MC', name: 'Monaco' },{ code: 'MN', name: 'Mongolia' },{ code: 'ME', name: 'Montenegro' },{ code: 'MA', name: 'Morocco' },{ code: 'MZ', name: 'Mozambique' },
                    { code: 'MM', name: 'Myanmar' },
                    { code: 'NA', name: 'Namibia' },{ code: 'NR', name: 'Nauru' },{ code: 'NP', name: 'Nepal' },{ code: 'NL', name: 'Netherlands' },{ code: 'NZ', name: 'New Zealand' },{ code: 'NI', name: 'Nicaragua' },{ code: 'NE', name: 'Niger' },{ code: 'NG', name: 'Nigeria' },{ code: 'MK', name: 'North Macedonia' },{ code: 'NO', name: 'Norway' },
                    { code: 'OM', name: 'Oman' },
                    { code: 'PK', name: 'Pakistan' },{ code: 'PW', name: 'Palau' },{ code: 'PA', name: 'Panama' },{ code: 'PG', name: 'Papua New Guinea' },{ code: 'PY', name: 'Paraguay' },{ code: 'PE', name: 'Peru' },{ code: 'PH', name: 'Philippines' },{ code: 'PL', name: 'Poland' },{ code: 'PT', name: 'Portugal' },
                    { code: 'QA', name: 'Qatar' },
                    { code: 'RO', name: 'Romania' },{ code: 'RU', name: 'Russia' },{ code: 'RW', name: 'Rwanda' },
                    { code: 'KN', name: 'Saint Kitts and Nevis' },{ code: 'LC', name: 'Saint Lucia' },{ code: 'VC', name: 'Saint Vincent and the Grenadines' },{ code: 'WS', name: 'Samoa' },{ code: 'SM', name: 'San Marino' },{ code: 'ST', name: 'Sao Tome and Principe' },{ code: 'SA', name: 'Saudi Arabia' },{ code: 'SN', name: 'Senegal' },{ code: 'RS', name: 'Serbia' },{ code: 'SC', name: 'Seychelles' },{ code: 'SL', name: 'Sierra Leone' },{ code: 'SG', name: 'Singapore' },{ code: 'SK', name: 'Slovakia' },{ code: 'SI', name: 'Slovenia' },{ code: 'SB', name: 'Solomon Islands' },{ code: 'SO', name: 'Somalia' },{ code: 'ZA', name: 'South Africa' },{ code: 'ES', name: 'Spain' },{ code: 'LK', name: 'Sri Lanka' },{ code: 'SD', name: 'Sudan' },{ code: 'SR', name: 'Suriname' },{ code: 'SE', name: 'Sweden' },{ code: 'CH', name: 'Switzerland' },{ code: 'SY', name: 'Syria' },
                    { code: 'TW', name: 'Taiwan' },{ code: 'TJ', name: 'Tajikistan' },{ code: 'TZ', name: 'Tanzania' },{ code: 'TH', name: 'Thailand' },{ code: 'TL', name: 'Timor-Leste' },{ code: 'TG', name: 'Togo' },{ code: 'TO', name: 'Tonga' },{ code: 'TT', name: 'Trinidad and Tobago' },{ code: 'TN', name: 'Tunisia' },{ code: 'TR', name: 'Turkey' },{ code: 'TM', name: 'Turkmenistan' },{ code: 'TV', name: 'Tuvalu' },
                    { code: 'UG', name: 'Uganda' },{ code: 'UA', name: 'Ukraine' },{ code: 'AE', name: 'United Arab Emirates' },{ code: 'GB', name: 'United Kingdom' },{ code: 'US', name: 'United States' },{ code: 'UY', name: 'Uruguay' },{ code: 'UZ', name: 'Uzbekistan' },
                    { code: 'VU', name: 'Vanuatu' },{ code: 'VA', name: 'Vatican City' },{ code: 'VE', name: 'Venezuela' },{ code: 'VN', name: 'Vietnam' },
                    { code: 'YE', name: 'Yemen' },{ code: 'ZM', name: 'Zambia' },{ code: 'ZW', name: 'Zimbabwe' }
                ];
                countries.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code;
                    opt.textContent = c.name;
                    // Make dropdown list text readable
                    opt.style.color = '#000000';
                    countrySelect.appendChild(opt);
                });
                // Style the placeholder option slightly dimmer
                if (countrySelect.options[0]) {
                    countrySelect.options[0].style.color = '#bbbbbb';
                }
            }
            // Quantity controls
            const qtyInput = document.getElementById('quantity');
            const qtyMinus = document.getElementById('qtyMinus');
            const qtyPlus = document.getElementById('qtyPlus');
            function onQtyChange() {
                // Recompute totals with current shipping selection
                shippingCalculator.updateOrderTotal();
            }
            if (qtyInput) qtyInput.addEventListener('input', onQtyChange);
            if (qtyMinus) qtyMinus.addEventListener('click', () => {
                const current = Number(qtyInput.value || 1);
                qtyInput.value = Math.max(1, current - 1);
                onQtyChange();
            });
            if (qtyPlus) qtyPlus.addEventListener('click', () => {
                const current = Number(qtyInput.value || 1);
                qtyInput.value = current + 1;
                onQtyChange();
            });
            
            // Handle billing address checkbox
            const differentBillingCheckbox = document.getElementById('differentBilling');
            const billingAddressFields = document.getElementById('billingAddressFields');
            
            if (differentBillingCheckbox && billingAddressFields) {
                differentBillingCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        billingAddressFields.classList.remove('hidden');
                    } else {
                        billingAddressFields.classList.add('hidden');
                    }
                });
            }
            
            // Handle mobile menu
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });
    </script>
</body>
</html>
