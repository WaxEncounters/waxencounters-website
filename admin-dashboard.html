<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Wax Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/security.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/purchase-tracker.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .admin-card { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(30px); border: 1px solid rgba(199, 122, 180, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status-funded { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-shipped { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-refunded { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <span class="text-pink-400 font-semibold">Admin Dashboard</span>
                        <a href="admin-upload.html" class="hover:text-gray-300 transition-colors duration-200">üìÄ Upload a Record</a>
                        <button id="logoutAdminBtn" class="hover:text-gray-300 transition-colors duration-200">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24">
        <section class="relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="admin-card rounded-2xl p-8 inline-block">
                        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Admin Dashboard</h1>
                        <p class="text-lg text-gray-300">Monitor users, campaigns, and manage operations.</p>
                        <div class="mt-4">
                            <button id="adminAuthBtn" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors font-semibold">
                                üîê Authenticate for Full Data Access
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-pink-300 mb-2" id="totalUsers">0</div>
                            <div class="text-sm text-gray-400">Total Users</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-400 mb-2" id="activeCampaigns">0</div>
                            <div class="text-sm text-gray-400">Active Campaigns</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-400 mb-2" id="totalRevenue">‚Ç¨0</div>
                            <div class="text-sm text-gray-400">Total Revenue</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-yellow-400 mb-2" id="pendingRefunds">0</div>
                            <div class="text-sm text-gray-400">Pending Refunds</div>
                        </div>
                    </div>
                </div>

                <!-- Users Database -->
                <div class="admin-card rounded-2xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold">Users Database</h3>
                        <button id="refreshUsersBtn" class="premium-button px-4 py-2 text-black font-semibold rounded-lg text-sm">
                            Refresh Data
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white border-opacity-20">
                                    <th class="text-left py-3 px-4 text-sm font-semibold">User ID</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Name</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Email</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Pre-orders</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Total Spent</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Status</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Campaigns Overview -->
                <div class="admin-card rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-6">Campaign Progress</h3>
                    
                    <div class="space-y-4" id="campaignsList">
                        <!-- Campaigns will be populated here -->
                    </div>
                </div>

                <!-- Inventory Management -->
                <div class="admin-card rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-6 text-pink-400">Inventory Management</h3>
                    
                    <div class="space-y-4" id="inventoryList">
                        <!-- Inventory will be populated here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Check admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession) {
                alert('Access denied. Admin authentication required.');
                window.location.href = 'login.html';
                return;
            }

            loadDashboardData();
            
            // Admin authentication button for encrypted data access
            document.getElementById('adminAuthBtn').addEventListener('click', async function() {
                const adminPassword = prompt('Enter admin master key to access encrypted user data:');
                if (adminPassword) {
                    const isAuthenticated = await adminDataAccess.authenticateAdmin(adminPassword);
                    if (isAuthenticated) {
                        alert('‚úÖ Admin authenticated! You can now access encrypted user data.');
                        this.textContent = 'üîì Authenticated - Reloading Data...';
                        this.className = 'px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-semibold';
                        // Reload user data to show encrypted data
                        await loadUsersData();
                    } else {
                        alert('‚ùå Invalid admin key. Access denied.');
                    }
                }
            });
        });

        // Load dashboard data
        function loadDashboardData() {
            loadUsersData();
            loadCampaignsData();
            loadInventoryData();
            updateStatistics();
        }

        // Secure admin data access system
        class AdminDataAccess {
            constructor() {
                this.adminPassword = null;
                this.isAuthenticated = false;
            }
            
            // Authenticate admin with master key
            async authenticateAdmin(adminPassword) {
                // In production, this would verify against server
                // For now, we'll use a secure admin key
                const masterAdminKey = 'WAX_ADMIN_MASTER_2024';
                
                if (adminPassword === masterAdminKey) {
                    this.adminPassword = adminPassword;
                    this.isAuthenticated = true;
                    return true;
                }
                return false;
            }
            
            // Decrypt user data for admin viewing
            async decryptUserDataForAdmin(encryptedData) {
                if (!this.isAuthenticated) {
                    throw new Error('Admin not authenticated');
                }
                
                try {
                    // Use the admin password as decryption key for user data
                    const decryptedData = await this.decryptData(encryptedData, this.adminPassword);
                    return JSON.parse(decryptedData);
                } catch (error) {
                    console.error('Failed to decrypt user data:', error);
                    throw new Error('Failed to decrypt user data');
                }
            }
            
            // Simple decryption method (in production, use proper server-side decryption)
            async decryptData(encryptedData, password) {
                // This is a simplified version - in production, use proper AES decryption
                try {
                    const parsed = JSON.parse(encryptedData);
                    if (parsed.encryptedData) {
                        // Use the security module for proper decryption
                        if (window.SecurityUtils) {
                            return await window.SecurityUtils.decryptData(parsed.encryptedData, password);
                        }
                    }
                    return encryptedData;
                } catch (error) {
                    return encryptedData;
                }
            }
        }
        
        // Global admin data access instance
        const adminDataAccess = new AdminDataAccess();
        
        // Load users data
        async function loadUsersData() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';

            console.log('Loading users data for admin dashboard...');
            
            // Get all user data from localStorage
            const userData = localStorage.getItem('userData');
            const verifiedEmails = localStorage.getItem('verifiedEmail');
            const cachedDisplayData = localStorage.getItem('cachedDisplayData');
            
            // Also try the encrypted storage key
            const encryptedUserData = localStorage.getItem('wax_encounters_user_data');
            
            console.log('User data found:', !!userData);
            console.log('Verified email:', verifiedEmails);
            console.log('Cached display data:', cachedDisplayData);
            
            // Find all admin user records (created during email verification)
            const allAdminUsers = [];
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('admin_user_')) {
                    try {
                        const userRecord = JSON.parse(localStorage.getItem(key));
                        allAdminUsers.push(userRecord);
                        console.log('Found admin user record:', userRecord);
                    } catch (error) {
                        console.error('Error parsing admin user record:', key, error);
                    }
                }
            });
            
            console.log('Total admin user records found:', allAdminUsers.length);

            // Process all users (both current user and admin user records)
            let usersAdded = 0;
            
            // Add current user if they have cached data
            if (cachedDisplayData) {
                try {
                    const cached = JSON.parse(cachedDisplayData);
                    console.log('Adding current user from cached data:', cached);
                    
                    const userEmail = cached.email || verifiedEmails || 'N/A';
                    const userName = cached.fullName || 'User Account';
                    const accountCreated = cached.timestamp || Date.now();
                    
                    // Create a user object from cached data
                    const user = {
                        firstName: cached.firstName || 'N/A',
                        lastName: cached.lastName || 'N/A',
                        email: cached.email,
                        username: cached.username || cached.email?.split('@')[0],
                        phone: cached.phone || 'Not provided',
                        shippingAddress: cached.shippingAddress || 'Not provided',
                        iban: cached.iban || 'Not provided',
                        bic: cached.bic || 'Not provided',
                        bankAccountOwner: cached.bankAccountOwner || 'Not provided',
                        preOrders: cached.preOrders || [],
                        totalSpent: cached.totalSpent || 0
                    };
                    
                    addUserToTable(user, userName, userEmail, accountCreated, 'cached');
                    usersAdded++;
                } catch (error) {
                    console.error('Error parsing cached display data:', error);
                }
            }
            
            // Add all admin user records (from email verification)
            allAdminUsers.forEach(adminUser => {
                console.log('Adding admin user record:', adminUser);
                
                // Create user object from admin record
                const user = {
                    firstName: 'User',
                    lastName: 'Account',
                    email: adminUser.email,
                    username: adminUser.username || adminUser.email.split('@')[0],
                    phone: 'Not provided',
                    shippingAddress: 'Not provided',
                    iban: 'Not provided',
                    bic: 'Not provided',
                    bankAccountOwner: 'Not provided',
                    preOrders: [],
                    totalSpent: 0
                };
                
                addUserToTable(user, adminUser.fullName, adminUser.email, adminUser.verifiedAt, 'admin_record');
                usersAdded++;
            });
            
            // Try encrypted user data if admin is authenticated (for detailed info)
            if (encryptedUserData && adminDataAccess.isAuthenticated) {
                try {
                    console.log('Attempting to decrypt encrypted user data for detailed info...');
                    const decryptedUserData = await adminDataAccess.decryptUserDataForAdmin(encryptedUserData);
                    console.log('Decrypted user data:', decryptedUserData);
                    
                    if (decryptedUserData && decryptedUserData.data) {
                        const user = decryptedUserData.data;
                        const userEmail = user.email || verifiedEmails || 'N/A';
                        const userName = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : 'User Account';
                        const accountCreated = decryptedUserData.storedAt || Date.now();
                        
                        // Update existing user with detailed info or add new one
                        updateUserWithDetailedInfo(user, userName, userEmail, accountCreated);
                    }
                } catch (error) {
                    console.error('Error decrypting user data:', error);
                }
            }
            
            // Show message if no users found
            if (usersAdded === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="py-8 px-4 text-center text-gray-400">
                        No verified users found. Users will appear here once they verify their email addresses.
                    </td>
                `;
                usersTableBody.appendChild(row);
            }
        }
        
        // Helper function to add user to table
        function addUserToTable(user, userName, userEmail, accountCreated, dataSource) {
            const usersTableBody = document.getElementById('usersTableBody');
            const row = document.createElement('tr');
            row.className = 'border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5';
            row.id = 'user-row-' + userEmail.replace('@', '_at_');
            
            const preOrders = user.preOrders ? user.preOrders.length : 0;
            const totalSpent = user.totalSpent || 0;
            const createdDate = new Date(accountCreated).toLocaleDateString();
            
            // Determine account status
            const isVerified = localStorage.getItem('accountVerified') === 'true' || dataSource === 'admin_record';
            const statusText = isVerified ? 'Verified' : 'Pending';
            const statusClass = isVerified ? 'status-funded' : 'status-pending';
            
            row.innerHTML = `
                <td class="py-3 px-4 text-sm">${userEmail.split('@')[0]}</td>
                <td class="py-3 px-4 text-sm">${userName}</td>
                <td class="py-3 px-4 text-sm">${userEmail}</td>
                <td class="py-3 px-4 text-sm">${preOrders}</td>
                <td class="py-3 px-4 text-sm">‚Ç¨${totalSpent}</td>
                <td class="py-3 px-4">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td class="py-3 px-4">
                    <button onclick="viewUserDetails('${userEmail}')" class="text-pink-400 hover:text-pink-300 text-sm">View Details</button>
                </td>
            `;
            
            usersTableBody.appendChild(row);
            
            console.log('User added to admin dashboard:', userEmail, 'Source:', dataSource);
        }
        
        // Helper function to update user with detailed info
        function updateUserWithDetailedInfo(user, userName, userEmail, accountCreated) {
            const rowId = 'user-row-' + userEmail.replace('@', '_at_');
            const existingRow = document.getElementById(rowId);
            
            if (existingRow) {
                // Update existing row with detailed info
                const cells = existingRow.querySelectorAll('td');
                cells[1].textContent = userName; // Update name
                cells[3].textContent = user.preOrders ? user.preOrders.length : 0; // Update pre-orders
                cells[4].textContent = '‚Ç¨' + (user.totalSpent || 0); // Update total spent
                console.log('Updated existing user with detailed info:', userEmail);
            } else {
                // Add new row with detailed info
                addUserToTable(user, userName, userEmail, accountCreated, 'encrypted');
            }
        }

        // Load campaigns data
        function loadCampaignsData() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '';

            // Get uploaded records from localStorage
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            
            // Filter crowdfunding campaigns
            const campaigns = records.filter(record => record.type === 'crowdfunding');
            
            // Add sample campaigns if no real ones exist (for demo purposes)
            if (campaigns.length === 0) {
                campaigns.push(
                    {
                        id: 'campaign-1',
                        name: 'Ethereal Dreams',
                        artist: 'Luna Nova',
                        target: 5000,
                        raised: 2450,
                        backers: 78,
                        status: 'active',
                        daysLeft: 22
                    },
                    {
                        id: 'campaign-2',
                        name: 'Neon Dreams',
                        artist: 'Cyber Pulse',
                        target: 3000,
                        raised: 3200,
                        backers: 203,
                        status: 'funded',
                        daysLeft: 0
                    }
                );
            } else {
                // Transform real campaigns to match the display format
                campaigns.forEach(campaign => {
                    campaign.name = campaign.albumTitle;
                    campaign.artist = campaign.artistName;
                    campaign.target = campaign.fundingGoal;
                    campaign.raised = campaign.raised || 0;
                    campaign.backers = campaign.backers || 0;
                    campaign.daysLeft = calculateDaysLeft(campaign.startDate, campaign.campaignDays);
                    campaign.status = campaign.raised >= campaign.fundingGoal ? 'funded' : 
                                    campaign.daysLeft <= 0 ? 'ended' : 'active';
                });
            }

            campaigns.forEach(campaign => {
                const campaignCard = document.createElement('div');
                campaignCard.className = 'p-4 bg-white bg-opacity-5 rounded-xl';
                
                const progressPercent = Math.min((campaign.raised / campaign.target) * 100, 100);
                const statusClass = campaign.status === 'funded' ? 'status-funded' : 
                                  campaign.status === 'shipped' ? 'status-shipped' : 'status-pending';
                const statusText = campaign.status === 'funded' ? 'Funded' : 
                                 campaign.status === 'shipped' ? 'Shipped' : 'Active';
                
                campaignCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-lg">${campaign.name}</h4>
                            <p class="text-sm text-gray-400">by ${campaign.artist}</p>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <p class="text-sm text-gray-400 mt-1">${campaign.backers} backers</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-400">Progress</span>
                            <span class="text-sm font-semibold">‚Ç¨${campaign.raised} / ‚Ç¨${campaign.target}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-pink-500 to-purple-500 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${progressPercent.toFixed(1)}% funded ${campaign.daysLeft > 0 ? `‚Ä¢ ${campaign.daysLeft} days left` : ''}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="manageCampaign('${campaign.id}')" class="premium-button px-3 py-1 text-black font-semibold rounded text-xs">
                            Manage
                        </button>
                        <button onclick="viewCampaignDetails('${campaign.id}')" class="glass-card px-3 py-1 rounded text-xs hover:bg-white hover:bg-opacity-10">
                            Details
                        </button>
                    </div>
                `;
                
                campaignsList.appendChild(campaignCard);
            });
        }

        function calculateDaysLeft(startDate, campaignDays) {
            const start = new Date(startDate);
            const end = new Date(start.getTime() + (campaignDays * 24 * 60 * 60 * 1000));
            const now = new Date();
            const diffTime = end - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        // Load inventory data
        function loadInventoryData() {
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';

            // Get uploaded records from localStorage
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            
            // Filter immediate sale records
            const inventoryItems = records.filter(record => record.type === 'immediate');
            
            if (inventoryItems.length === 0) {
                inventoryList.innerHTML = `
                    <div class="admin-card rounded-xl p-8 text-center">
                        <div class="w-16 h-16 bg-green-400 bg-opacity-20 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">No Inventory Items</h4>
                        <p class="text-gray-300 text-sm mb-4">Upload immediate sale records to manage inventory</p>
                        <a href="admin-upload.html" class="text-pink-400 hover:text-pink-300 text-sm font-medium">
                            Upload a Record ‚Üí
                        </a>
                    </div>
                `;
                return;
            }

            inventoryItems.forEach(item => {
                const inventoryElement = document.createElement('div');
                inventoryElement.className = 'admin-card rounded-xl p-6 mb-4';
                
                const stockPercentage = (item.quantity / (item.quantity + (item.sold || 0))) * 100;
                const isLowStock = item.quantity <= 10;
                const isOutOfStock = item.quantity <= 0;
                
                let statusClass = 'status-funded';
                let statusText = 'Available';
                
                if (isOutOfStock) {
                    statusClass = 'status-refunded';
                    statusText = 'Out of Stock';
                } else if (isLowStock) {
                    statusClass = 'status-pending';
                    statusText = 'Low Stock';
                }

                inventoryElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold mb-1">${item.albumTitle}</h4>
                            <p class="text-gray-300 text-sm">by ${item.artistName}</p>
                        </div>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-300">Stock Level</span>
                            <span class="text-white">${item.quantity} / ${item.quantity + (item.sold || 0)} units</span>
                        </div>
                        <div class="w-full bg-white bg-opacity-10 rounded-full h-3 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-1000 ease-out" 
                                 style="width: ${stockPercentage}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${stockPercentage.toFixed(1)}% in stock</p>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex space-x-4">
                            <span class="text-gray-300">‚Ç¨${item.price}</span>
                            <span class="text-gray-300">${item.sold || 0} sold</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="updateInventory('${item.id}')" class="text-pink-400 hover:text-pink-300 text-sm font-medium">
                                Update Stock
                            </button>
                            <button onclick="viewInventoryDetails('${item.id}')" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                                Details
                            </button>
                            <button onclick="deleteInventoryItem('${item.id}')" class="text-red-400 hover:text-red-300 text-sm font-medium">
                                Delete Item
                            </button>
                        </div>
                    </div>
                `;
                
                inventoryList.appendChild(inventoryElement);
            });
        }

        // Update statistics
        function updateStatistics() {
            // Update total users
            const adminUsers = Object.keys(localStorage).filter(key => key.startsWith('admin_user_'));
            const totalUsers = adminUsers.length;
            document.getElementById('totalUsers').textContent = totalUsers;

            // Update active campaigns
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const activeCampaigns = records.filter(record => record.type === 'crowdfunding' && record.status !== 'ended').length;
            document.getElementById('activeCampaigns').textContent = activeCampaigns;

            // Update total revenue
            const totalRevenue = records.reduce((sum, record) => {
                if (record.type === 'immediate') {
                    return sum + (record.price * (record.sold || 0));
                } else if (record.type === 'crowdfunding') {
                    return sum + (record.raised || 0);
                }
                return sum;
            }, 0);
            document.getElementById('totalRevenue').textContent = '‚Ç¨' + totalRevenue.toLocaleString();

            // Update pending refunds (for demo purposes)
            document.getElementById('pendingRefunds').textContent = '0';
        }

        // User management functions
        async function viewUserDetails(email) {
            // Get user data from localStorage
            const userData = localStorage.getItem('userData');
            const verifiedEmails = localStorage.getItem('verifiedEmail');
            const cachedDisplayData = localStorage.getItem('cachedDisplayData');
            
            console.log('Viewing details for user:', email);
            console.log('Available data:', { userData: !!userData, verifiedEmails, cachedDisplayData: !!cachedDisplayData });
            
            // Create a modal instead of alert for better display
            await showUserDetailsModal(email, userData, cachedDisplayData);
        }
        
        async function showUserDetailsModal(email, userData, cachedDisplayData) {
            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.onclick = function(e) {
                if (e.target === backdrop) {
                    document.body.removeChild(backdrop);
                }
            };
            
            let userInfo = '';
            let hasFullData = false;
            let dataSource = 'none';
            
            console.log('Modal data check:', { userData: !!userData, cachedDisplayData: !!cachedDisplayData, email });
            
            // Try to get user data from multiple sources
            let user = null;
            let parsedUserData = null;
            
            // First try cached display data (most reliable)
            if (cachedDisplayData) {
                try {
                    console.log('Attempting to retrieve user data from cached display data...');
                    const cached = JSON.parse(cachedDisplayData);
                    console.log('Cached display data:', cached);
                    
                    if (cached && cached.email === email) {
                        console.log('Found user data in cached display data');
                        // Create a user object from cached data
                        user = {
                            firstName: cached.firstName || 'N/A',
                            lastName: cached.lastName || 'N/A',
                            email: cached.email,
                            username: cached.username || cached.email.split('@')[0],
                            phone: cached.phone || 'Not provided',
                            shippingAddress: cached.shippingAddress || 'Not provided',
                            iban: cached.iban || 'Not provided',
                            bic: cached.bic || 'Not provided',
                            bankAccountOwner: cached.bankAccountOwner || 'Not provided',
                            preOrders: cached.preOrders || [],
                            totalSpent: cached.totalSpent || 0
                        };
                        
                        parsedUserData = {
                            storedAt: cached.timestamp || Date.now()
                        };
                        
                        hasFullData = true;
                        dataSource = 'cached';
                        console.log('Successfully created user object from cached data:', user);
                    }
                } catch (error) {
                    console.error('Error parsing cached display data:', error);
                }
            }
            
            // Try encrypted user data if admin is authenticated
            if (!hasFullData) {
                const encryptedUserData = localStorage.getItem('wax_encounters_user_data');
                if (encryptedUserData && adminDataAccess.isAuthenticated) {
                    try {
                        console.log('Attempting to decrypt encrypted user data...');
                        const decryptedUserData = await adminDataAccess.decryptUserDataForAdmin(encryptedUserData);
                        console.log('Decrypted user data:', decryptedUserData);
                        
                        if (decryptedUserData && decryptedUserData.data) {
                            user = decryptedUserData.data;
                            parsedUserData = decryptedUserData;
                            hasFullData = true;
                            dataSource = 'encrypted';
                            console.log('Successfully created user object from encrypted data:', user);
                        }
                    } catch (error) {
                        console.error('Error decrypting user data:', error);
                    }
                }
            }
            
            // Fallback to regular userData if available
            if (!hasFullData && userData) {
                try {
                    parsedUserData = JSON.parse(userData);
                    user = parsedUserData.data;
                    hasFullData = true;
                    dataSource = 'userData';
                    console.log('Successfully parsed user data for modal:', user);
                } catch (error) {
                    console.error('Error parsing userData in modal:', error);
                }
            }
            
            if (hasFullData && user) {
                console.log('Displaying full user data for:', email);
                console.log('User object:', user);
                
                userInfo = `
                    <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">User Account Details</h2>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üë§ Personal Information</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">Full Name:</span> <span class="text-white">${user.firstName || 'N/A'} ${user.lastName || 'N/A'}</span></div>
                                    <div><span class="text-gray-300">Email:</span> <span class="text-white">${user.email || email}</span></div>
                                    <div><span class="text-gray-300">Username:</span> <span class="text-white">${user.username || 'N/A'}</span></div>
                                    <div><span class="text-gray-300">Phone:</span> <span class="text-white">${user.phone || 'Not provided'}</span></div>
                                </div>
                            </div>
                            
                            <!-- Shipping Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üì¶ Shipping Address</h3>
                                <div class="text-sm">
                                    <div><span class="text-gray-300">Address:</span></div>
                                    <div class="text-white mt-1 pl-2">${user.shippingAddress || 'Not provided'}</div>
                                </div>
                            </div>
                            
                            <!-- Banking Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üè¶ Banking Details (Refunds)</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">IBAN:</span> <span class="text-white font-mono">${user.iban || 'Not provided'}</span></div>
                                    <div><span class="text-gray-300">BIC:</span> <span class="text-white font-mono">${user.bic || 'Not provided'}</span></div>
                                    <div><span class="text-gray-300">Account Owner:</span> <span class="text-white">${user.bankAccountOwner || 'Not provided'}</span></div>
                                </div>
                            </div>
                            
                            <!-- Account Status -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üìä Account Status</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">Created:</span> <span class="text-white">${new Date(parsedUserData?.storedAt || Date.now()).toLocaleDateString()}</span></div>
                                    <div><span class="text-gray-300">Status:</span> <span class="text-green-400">${localStorage.getItem('accountVerified') === 'true' ? 'Verified ‚úì' : 'Not Verified'}</span></div>
                                    <div><span class="text-gray-300">Pre-orders:</span> <span class="text-white">${user.preOrders ? user.preOrders.length : 0}</span></div>
                                    <div><span class="text-gray-300">Total Spent:</span> <span class="text-white">‚Ç¨${user.totalSpent || 0}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Debug Information -->
                        <div class="mt-6 bg-yellow-500 bg-opacity-10 border border-yellow-500 border-opacity-30 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-2">üîç Debug Information</h3>
                            <div class="text-xs text-gray-300 space-y-1">
                                <div>Raw User Data Available: ${userData ? 'Yes' : 'No'}</div>
                                <div>Cached Display Data Available: ${cachedDisplayData ? 'Yes' : 'No'}</div>
                                <div>Encrypted User Data Available: ${localStorage.getItem('wax_encounters_user_data') ? 'Yes' : 'No'}</div>
                                <div>Data Retrieved From: ${dataSource === 'cached' ? 'Cached Display Data' : dataSource === 'encrypted' ? 'Encrypted Storage (Admin Decrypted)' : dataSource === 'userData' ? 'User Data Storage' : 'Unknown'}</div>
                                <div>Admin Authenticated: ${adminDataAccess.isAuthenticated ? 'Yes' : 'No'}</div>
                                <div>Security Status: ${adminDataAccess.isAuthenticated ? 'üîì Decrypted Access' : 'üîí Encrypted (Limited Access)'}</div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-6 flex gap-4 justify-end">
                            <button onclick="processRefund('${email}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                                üí∞ Process Refund
                            </button>
                            <button onclick="initiateShipping('${email}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                üì¶ Initiate Shipping
                            </button>
                            <button onclick="contactUser('${email}')" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                                üìß Contact User
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Fallback for partial data
                userInfo = `
                    <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-2xl w-full">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">User Account Details</h2>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                        </div>
                        <div class="text-center text-gray-300">
                            <p>Limited user data available for: ${email}</p>
                            <p class="mt-2">Account Status: ${localStorage.getItem('accountVerified') === 'true' ? 'Verified ‚úì' : 'Not Verified'}</p>
                            <p class="mt-4 text-sm">Full user details will be available once the user completes their profile.</p>
                        </div>
                    </div>
                `;
            }
            
            backdrop.innerHTML = userInfo;
            document.body.appendChild(backdrop);
        }
        
        // Admin action functions
        function processRefund(email) {
            alert(`Processing refund for: ${email}\n\nThis would:\n- Verify refund amount\n- Process bank transfer\n- Send confirmation email\n- Update account status`);
        }
        
        function initiateShipping(email) {
            alert(`Initiating shipping for: ${email}\n\nThis would:\n- Generate shipping label\n- Update tracking information\n- Send tracking email to user\n- Update order status`);
        }
        
        function contactUser(email) {
            alert(`Contact user: ${email}\n\nThis would open email client or show contact options for:\n- Campaign updates\n- Shipping notifications\n- Refund confirmations\n- General support`);
        }
        
        // Debug function to help troubleshoot user data
        function debugUserData() {
            console.log('=== ADMIN DASHBOARD DEBUG ===');
            console.log('All localStorage keys:', Object.keys(localStorage));
            
            // Check each key for user data
            Object.keys(localStorage).forEach(key => {
                if (key.includes('user') || key.includes('data') || key.includes('account') || key.includes('cached')) {
                    console.log(`\nKey: ${key}`);
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        console.log('Parsed data:', parsed);
                        
                        // Check if this looks like user data
                        if (parsed && parsed.data && (parsed.data.email || parsed.data.username)) {
                            console.log('üéØ FOUND USER DATA in key:', key);
                            console.log('User email:', parsed.data.email);
                            console.log('User name:', parsed.data.firstName, parsed.data.lastName);
                            console.log('Full user object:', parsed.data);
                        }
                    } catch (e) {
                        console.log('Raw data (not JSON):', localStorage.getItem(key));
                    }
                }
            });
            
            console.log('\n=== VERIFICATION STATUS ===');
            console.log('accountVerified:', localStorage.getItem('accountVerified'));
            console.log('verifiedEmail:', localStorage.getItem('verifiedEmail'));
            
            console.log('\n=== SECURE STORAGE MANAGER ===');
            console.log('SecureStorageManager available:', !!window.SecureStorageManager);
            if (window.SecureStorageManager) {
                console.log('Session valid:', window.SecureStorageManager.isSessionValid());
            }
            
            console.log('=== END DEBUG ===');
        }
        
        // Make debug function globally available
        window.debugUserData = debugUserData;

        function manageCampaign(campaignId) {
            alert(`Manage Campaign: ${campaignId}\n\nThis would allow you to:\n- Update campaign status\n- Process refunds\n- Manage shipping\n- Contact backers`);
        }

        function viewCampaignDetails(campaignId) {
            alert(`Campaign Details: ${campaignId}\n\nThis would show:\n- Detailed campaign information\n- Backer list\n- Financial breakdown\n- Timeline and milestones`);
        }

        // Inventory management functions
        function updateInventory(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            const newQuantity = prompt(`Update stock for "${record.albumTitle}"\n\nCurrent quantity: ${record.quantity}\nEnter new quantity:`, record.quantity);
            
            if (newQuantity !== null && !isNaN(newQuantity) && newQuantity >= 0) {
                const success = window.PurchaseTracker.updateInventory(recordId, parseInt(newQuantity));
                
                if (success) {
                    alert(`Stock updated successfully!\n\nNew quantity: ${newQuantity}`);
                    loadInventoryData(); // Refresh inventory display
                } else {
                    alert('Failed to update stock');
                }
            }
        }

        function viewInventoryDetails(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            const details = `
Inventory Details: ${record.albumTitle}

Artist: ${record.artistName}
Genre: ${record.genre || 'Not specified'}
Price: ‚Ç¨${record.price}
Current Stock: ${record.quantity} units
Sold: ${record.sold || 0} units
Total Units: ${record.quantity + (record.sold || 0)} units
Status: ${record.status}
Uploaded: ${new Date(record.uploadedAt).toLocaleDateString()}

Description:
${record.description || 'No description provided'}
            `;

            alert(details);
        }

        function deleteInventoryItem(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            // Show confirmation dialog with record details
            const confirmMessage = `Are you sure you want to delete this inventory item?\n\n` +
                `Album: ${record.albumTitle}\n` +
                `Artist: ${record.artistName}\n` +
                `Current Stock: ${record.quantity} units\n` +
                `Sold: ${record.sold || 0} units\n\n` +
                `This action cannot be undone!`;
            
            if (confirm(confirmMessage)) {
                // Remove the record from the main records array
                const updatedRecords = records.filter(r => r.id !== recordId);
                
                // Update localStorage with cleaned records
                localStorage.setItem('uploadedRecords', JSON.stringify(updatedRecords));
                
                // Clean up any related orders that reference this record
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const updatedOrders = orders.filter(order => order.recordId !== recordId);
                localStorage.setItem('orders', JSON.stringify(updatedOrders));
                
                // Clean up any user pre-orders that reference this record
                const allUserKeys = Object.keys(localStorage).filter(key => key.startsWith('wax_encounters_user_data_'));
                allUserKeys.forEach(userKey => {
                    try {
                        const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
                        if (userData.data && userData.data.preOrders) {
                            const updatedPreOrders = userData.data.preOrders.filter(preOrder => preOrder.recordId !== recordId);
                            userData.data.preOrders = updatedPreOrders;
                            localStorage.setItem(userKey, JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.warn('Could not update user pre-orders for key:', userKey, error);
                    }
                });
                
                // Clean up any cached display data that might reference this record
                const cachedData = JSON.parse(localStorage.getItem('cachedDisplayData') || '{}');
                if (cachedData.preOrders) {
                    cachedData.preOrders = cachedData.preOrders.filter(preOrder => preOrder.recordId !== recordId);
                    localStorage.setItem('cachedDisplayData', JSON.stringify(cachedData));
                }
                
                // Show success message
                alert(`"${record.albumTitle}" has been completely removed from the website!\n\n` +
                      `‚úÖ Removed from inventory\n` +
                      `‚úÖ Removed from all user accounts\n` +
                      `‚úÖ Removed from order history\n` +
                      `‚úÖ Cleaned up all references`);
                
                // Refresh all dashboard displays
                loadInventoryData();
                loadCampaignsData();
                loadUsersData();
                updateStatistics();
                
                console.log('Record completely deleted from all locations:', recordId);
            }
        }

        // Refresh data
        document.getElementById('refreshUsersBtn').addEventListener('click', function() {
            loadDashboardData();
            alert('Dashboard data refreshed!');
        });

        // Admin logout
        document.getElementById('logoutAdminBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to log out of admin panel?')) {
                localStorage.removeItem('adminSession');
                alert('Logged out successfully.');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
