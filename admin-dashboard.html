<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Wax Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/security.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/purchase-tracker.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .admin-card { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(30px); border: 1px solid rgba(199, 122, 180, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status-funded { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-shipped { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-refunded { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <span class="text-pink-400 font-semibold">Admin Dashboard</span>
                        <a href="admin-upload.html" class="hover:text-gray-300 transition-colors duration-200">üìÄ Upload a Record</a>
                        <button id="logoutAdminBtn" onclick="event.stopPropagation(); return handleLogoutClick();" class="hover:text-gray-300 transition-colors duration-200">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24">
        <section class="relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="admin-card rounded-2xl p-8 inline-block">
                        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Admin Dashboard</h1>
                        <p class="text-lg text-gray-300">Monitor users, campaigns, and manage operations.</p>
                        <div class="mt-4">
                            <button id="adminAuthBtn" onclick="(function(){try{var k=prompt('Enter admin master key to access encrypted user data:');if(!k)return false; if(k==='WAX_ADMIN_MASTER_2024'){localStorage.setItem('adminAuthOK','1'); alert('‚úÖ Admin authenticated!'); try{if(window.loadUsersData) loadUsersData();}catch(_){} } else { alert('‚ùå Invalid admin key.'); }}catch(e){alert('Admin auth failed.');}})(); return false;" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors font-semibold">
                                üîê Authenticate for Full Data Access
                            </button>
                            <button id="vacationModeBtn" onclick="(function(){try{var current=null;try{current=JSON.parse(localStorage.getItem('vacationMode')||'null');}catch(_){} if(current&&current.active){ if(confirm('Vacation mode is active until '+ new Date(current.until).toLocaleString() +'\n\nDo you want to turn it OFF now?')){ localStorage.setItem('vacationMode', JSON.stringify({active:false, until:null})); alert('Vacation mode disabled. The site is now live.'); } return false; } var val=prompt('Enter return date and time (YYYY-MM-DDTHH:mm)'); if(!val) return false; var d=new Date(val); if(isNaN(d.getTime())){ alert('Invalid date/time.'); return false; } localStorage.setItem('vacationMode', JSON.stringify({active:true, until:d.toISOString()})); alert('Vacation mode enabled until '+ d.toLocaleString() +'. Users will see the vacation page.'); }catch(e){alert('Vacation toggle failed.');}})(); return false;" class="ml-2 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors font-semibold">
                                üå¥ Vacation Mode
                            </button>
                            <button id="vacationForceOffBtn" onclick="try{localStorage.setItem('vacationMode', JSON.stringify({active:false, until:null})); alert('Vacation mode disabled immediately.');}catch(e){alert('Failed disabling vacation mode.');} return false;" class="ml-2 px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors font-semibold">
                                ‚õî Disable Vacation Now
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-pink-300 mb-2" id="totalUsers">0</div>
                            <div class="text-sm text-gray-400">Total Users</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-400 mb-2" id="activeCampaigns">0</div>
                            <div class="text-sm text-gray-400">Active Campaigns</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-400 mb-2" id="totalRevenue">‚Ç¨0</div>
                            <div class="text-sm text-gray-400">Total Revenue</div>
                        </div>
                    </div>
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-yellow-400 mb-2" id="pendingRefunds">0</div>
                            <div class="text-sm text-gray-400">Pending Refunds</div>
                        </div>
                    </div>
                    <!-- Guest Orders Counter -->
                    <div class="admin-card rounded-xl p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-300 mb-2" id="guestOrdersCount">0</div>
                            <div class="text-sm text-gray-400">Guest Orders</div>
                        </div>
                    </div>
                </div>

                <!-- Users Database -->
                <div class="admin-card rounded-2xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold">Users Database</h3>
                        <div class="flex gap-2">
                            <button id="refreshUsersBtn" onclick="try{ if(window.loadDashboardData) { loadDashboardData(); alert('Dashboard data refreshed!'); } else { location.reload(); } }catch(e){ location.reload(); } return false;" class="premium-button px-4 py-2 text-black font-semibold rounded-lg text-sm">
                            Refresh Data
                        </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white border-opacity-20">
                                    <th class="text-left py-3 px-4 text-sm font-semibold">User ID</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Name</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Email</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Pre-orders</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Total Spent</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Status</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Guests Database (Only Guest Orders) -->
                <div class="admin-card rounded-2xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold">Guests Database</h3>
                        <div class="text-sm text-gray-400">Only purchases made without an account</div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white border-opacity-20">
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Guest ID</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Name</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Email</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Address</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Orders</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Status</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="guestsTableBody">
                                <!-- Guests will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Campaigns Overview -->
                <div class="admin-card rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-6">Campaign Progress</h3>
                    
                    <div class="space-y-4" id="campaignsList">
                        <!-- Campaigns will be populated here -->
                    </div>
                </div>


                <!-- Inventory Management -->
                <div class="admin-card rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-6 text-pink-400">Inventory Management</h3>
                    
                    <div class="space-y-4" id="inventoryList">
                        <!-- Inventory will be populated here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Fallback global handlers so buttons work even if early JS fails
        function handleLogoutClick() {
            try {
                if (confirm('Are you sure you want to log out of admin panel?')) {
                    localStorage.removeItem('adminSession');
                    const vm = JSON.parse(localStorage.getItem('vacationMode') || 'null');
                    if (vm && vm.active) {
                        window.location.replace('vacation.html?admin=1');
                    } else {
                        window.location.replace('login.html');
                    }
                }
            } catch (e) { console.error(e); alert('Logout failed.'); }
        }

        async function handleAdminAuthClick() {
            try {
                const adminPassword = prompt('Enter admin master key to access encrypted user data:');
                if (!adminPassword) return;
                if (window.adminDataAccess && await adminDataAccess.authenticateAdmin(adminPassword)) {
                    alert('‚úÖ Admin authenticated! You can now access encrypted user data.');
                    await loadUsersData();
                } else {
                    alert('‚ùå Invalid admin key. Access denied.');
                }
            } catch (e) { console.error(e); alert('Admin auth failed.'); }
        }

        function handleVacationClick() {
            try {
                const current = JSON.parse(localStorage.getItem('vacationMode') || 'null');
                if (current && current.active) {
                    if (confirm(`Vacation mode is active until ${new Date(current.until).toLocaleString()}\n\nDo you want to turn it OFF now?`)) {
                        localStorage.setItem('vacationMode', JSON.stringify({ active: false, until: null }));
                        alert('Vacation mode disabled. The site is now live.');
                    }
                    return;
                }
                if (typeof showVacationCalendarModal === 'function') {
                    showVacationCalendarModal();
                } else {
                    alert('Calendar not ready. Please refresh and try again.');
                }
            } catch (e) { console.error(e); alert('Vacation toggle failed.'); }
        }

        function forceVacationOffClick() {
            try {
                localStorage.setItem('vacationMode', JSON.stringify({ active: false, until: null }));
                alert('Vacation mode disabled immediately.');
            } catch (e) { console.error(e); alert('Failed disabling vacation mode.'); }
        }

        function handleRefreshDataClick() {
            try {
                loadDashboardData();
                alert('Dashboard data refreshed!');
            } catch (e) { console.error(e); alert('Failed to refresh data.'); }
        }
        // Check admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            // Safety: remove any stray full-screen overlays that could block clicks
            try { document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove()); } catch (e) { console.warn(e); }
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession) {
                alert('Access denied. Admin authentication required.');
                window.location.href = 'login.html';
                return;
            }

            loadDashboardData();
            
            // Admin authentication button for encrypted data access
            document.getElementById('adminAuthBtn').addEventListener('click', async function() {
                const adminPassword = prompt('Enter admin master key to access encrypted user data:');
                if (adminPassword) {
                    const isAuthenticated = await adminDataAccess.authenticateAdmin(adminPassword);
                    if (isAuthenticated) {
                        alert('‚úÖ Admin authenticated! You can now access encrypted user data.');
                        this.textContent = 'üîì Authenticated - Reloading Data...';
                        this.className = 'px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-semibold';
                        // Reload user data to show encrypted data
                        await loadUsersData();
                    } else {
                        alert('‚ùå Invalid admin key. Access denied.');
                    }
                }
            });

            // Vacation mode toggler (calendar style)
            document.getElementById('vacationModeBtn').addEventListener('click', function() {
                const current = JSON.parse(localStorage.getItem('vacationMode') || 'null');
                if (current && current.active) {
                    if (confirm(`Vacation mode is active until ${new Date(current.until).toLocaleString()}\n\nDo you want to turn it OFF now?`)) {
                        localStorage.setItem('vacationMode', JSON.stringify({ active: false, until: null }));
                        alert('Vacation mode disabled. The site is now live.');
                    }
                    return;
                }
                showVacationCalendarModal();
            });

            // Force disable vacation now (failsafe)
            document.getElementById('vacationForceOffBtn').addEventListener('click', function() {
                localStorage.setItem('vacationMode', JSON.stringify({ active: false, until: null }));
                alert('Vacation mode disabled immediately.');
            });

            window.showVacationCalendarModal = function() {
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                backdrop.onclick = function(e){ if(e.target===backdrop) document.body.removeChild(backdrop); };

                const container = document.createElement('div');
                container.className = 'bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 w-full max-w-md';
                container.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">Enable Vacation Mode</h2>
                    <label class="block text-sm text-gray-300 mb-2">Return date and time</label>
                    <input id="vacationDatetime" type="datetime-local" class="w-full px-3 py-2 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 mb-4">
                    <div class="flex justify-end gap-2">
                        <button id="vacCancel" class="px-4 py-2 rounded-lg text-sm bg-gray-600 hover:bg-gray-500 text-white">Cancel</button>
                        <button id="vacSave" class="px-4 py-2 rounded-lg text-sm bg-pink-500 hover:bg-pink-600 text-white font-semibold">Enable</button>
                    </div>
                `;
                backdrop.appendChild(container);
                document.body.appendChild(backdrop);

                const cancelBtn = container.querySelector('#vacCancel');
                const saveBtn = container.querySelector('#vacSave');
                const dtInput = container.querySelector('#vacationDatetime');

                // Prefill to tomorrow 09:00
                const now = new Date();
                const tomorrow = new Date(now.getTime() + 24*60*60*1000);
                tomorrow.setMinutes(0); tomorrow.setSeconds(0); tomorrow.setMilliseconds(0);
                const yyyy = tomorrow.getFullYear();
                const mm = String(tomorrow.getMonth()+1).padStart(2,'0');
                const dd = String(tomorrow.getDate()).padStart(2,'0');
                const hh = '09';
                const mi = '00';
                dtInput.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;

                cancelBtn.onclick = () => document.body.removeChild(backdrop);
                saveBtn.onclick = () => {
                    const val = dtInput.value;
                    if (!val) { alert('Please select a date and time.'); return; }
                    const until = new Date(val);
                    if (isNaN(until.getTime())) { alert('Invalid date/time.'); return; }
                    localStorage.setItem('vacationMode', JSON.stringify({ active: true, until: until.toISOString() }));
                    document.body.removeChild(backdrop);
                    alert(`Vacation mode enabled until ${until.toLocaleString()}. Users will see the vacation page.`);
                };
            }
        });

        // Global click delegation fallback to ensure buttons always respond
        document.addEventListener('click', function(evt) {
            const btn = evt.target.closest('#adminAuthBtn, #vacationModeBtn, #vacationForceOffBtn, #refreshUsersBtn');
            if (!btn) return;
            evt.preventDefault();
            try {
                if (btn.id === 'adminAuthBtn') return handleAdminAuthClick();
                if (btn.id === 'vacationModeBtn') return handleVacationClick();
                if (btn.id === 'vacationForceOffBtn') return forceVacationOffClick();
                if (btn.id === 'refreshUsersBtn') return handleRefreshDataClick();
            } catch (e) {
                console.error('Admin button handler error:', e);
                alert('Action failed. Please refresh and try again.');
            }
        }, true);

        // Load dashboard data
        function loadDashboardData() {
            loadUsersData();
            loadGuestsData();
            loadCampaignsData();
            loadInventoryData();
            updateStatistics();
        }

        // Secure admin data access system
        class AdminDataAccess {
            constructor() {
                this.adminPassword = null;
                this.isAuthenticated = false;
            }
            
            // Authenticate admin with master key
            async authenticateAdmin(adminPassword) {
                // In production, this would verify against server
                // For now, we'll use a secure admin key
                const masterAdminKey = 'WAX_ADMIN_MASTER_2024';
                
                if (adminPassword === masterAdminKey) {
                    this.adminPassword = adminPassword;
                    this.isAuthenticated = true;
                    return true;
                }
                return false;
            }
            
            // Decrypt user data for admin viewing
            async decryptUserDataForAdmin(encryptedData) {
                if (!this.isAuthenticated) {
                    throw new Error('Admin not authenticated');
                }
                
                try {
                    // Use the admin password as decryption key for user data
                    const decryptedData = await this.decryptData(encryptedData, this.adminPassword);
                    return JSON.parse(decryptedData);
                } catch (error) {
                    console.error('Failed to decrypt user data:', error);
                    throw new Error('Failed to decrypt user data');
                }
            }
            
            // Simple decryption method (in production, use proper server-side decryption)
            async decryptData(encryptedData, password) {
                // This is a simplified version - in production, use proper AES decryption
                try {
                    const parsed = JSON.parse(encryptedData);
                    if (parsed.encryptedData) {
                        // Use the security module for proper decryption
                        if (window.SecurityUtils) {
                            return await window.SecurityUtils.decryptData(parsed.encryptedData, password);
                        }
                    }
                    return encryptedData;
                } catch (error) {
                    return encryptedData;
                }
            }
        }
        
        // Global admin data access instance
        window.adminDataAccess = new AdminDataAccess();
        
        // Load users data
        async function loadUsersData() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';

            console.log('Loading users data for admin dashboard...');
            
            // Get all user data from localStorage
            const userData = localStorage.getItem('userData');
            const verifiedEmails = localStorage.getItem('verifiedEmail');
            const cachedDisplayData = localStorage.getItem('cachedDisplayData');
            
            // Also try the encrypted storage key
            const encryptedUserData = localStorage.getItem('wax_encounters_user_data');
            
            console.log('User data found:', !!userData);
            console.log('Verified email:', verifiedEmails);
            console.log('Cached display data:', cachedDisplayData);
            
            // NEW: Merge orders into user summaries (ensures totals/pre-orders appear)
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const emailToOrderSummary = new Map();
            orders.forEach(o => {
                // Only map orders to users if they are not guest orders
                if (!o.customerEmail || o.customerEmail === 'unknown' || !String(o.customerEmail).includes('@') || o.isGuest) return;
                const email = o.customerEmail || (verifiedEmails || '').toString();
                if (!email) return;
                const current = emailToOrderSummary.get(email) || { totalSpent: 0, preOrders: [], shippedStates: [] };
                current.totalSpent += Number(o.amount || 0);
                current.preOrders.push({
                    recordId: o.recordId,
                    recordTitle: o.recordTitle,
                    amount: o.amount,
                    timestamp: o.timestamp,
                    shipped: !!o.shipped,
                    trackingNumber: o.trackingNumber || null,
                    shipmentId: o.shipmentId || null
                });
                current.shippedStates.push(!!o.shipped);
                emailToOrderSummary.set(email, current);
            });
            
            // Find all admin user records (created during email verification)
            const allAdminUsers = [];
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('admin_user_')) {
                    try {
                        const userRecord = JSON.parse(localStorage.getItem(key));
                        allAdminUsers.push(userRecord);
                        console.log('Found admin user record:', userRecord);
                    } catch (error) {
                        console.error('Error parsing admin user record:', key, error);
                    }
                }
            });
            
            console.log('Total admin user records found:', allAdminUsers.length);

            // Process all users (both current user and admin user records)
            let usersAdded = 0;
            
            // Add current user if they have cached data
            if (cachedDisplayData) {
                try {
                    console.log('Adding current user from cached data:', cachedDisplayData);
                    
                    const userEmail = cachedDisplayData.email || verifiedEmails || 'N/A';
                    const userName = cachedDisplayData.fullName || 'User Account';
                    const accountCreated = cachedDisplayData.timestamp || Date.now();
                    
                    // Create a user object from cached data
                    const user = {
                        firstName: cachedDisplayData.firstName || 'N/A',
                        lastName: cachedDisplayData.lastName || 'N/A',
                        email: cachedDisplayData.email,
                        username: cachedDisplayData.username || cachedDisplayData.email?.split('@')[0],
                        phone: cachedDisplayData.phone || 'Not provided',
                        shippingAddress: cachedDisplayData.shippingAddress || 'Not provided',
                        iban: cachedDisplayData.iban || 'Not provided',
                        bic: cachedDisplayData.bic || 'Not provided',
                        bankAccountOwner: cachedDisplayData.bankAccountOwner || 'Not provided',
                        preOrders: cachedDisplayData.preOrders || [],
                        totalSpent: cachedDisplayData.totalSpent || 0
                    };
                    
                    addUserToTable(user, userName, userEmail, accountCreated, 'cached');
                    usersAdded++;
                } catch (error) {
                    console.error('Error parsing cached display data:', error);
                }
            }
            
            // Add all admin user records (from email verification)
            allAdminUsers.forEach(adminUser => {
                console.log('Adding admin user record:', adminUser);
                
                // Create user object from admin record
                const user = {
                    firstName: 'User',
                    lastName: 'Account',
                    email: adminUser.email,
                    username: adminUser.username || adminUser.email.split('@')[0],
                    phone: 'Not provided',
                    shippingAddress: 'Not provided',
                    iban: 'Not provided',
                    bic: 'Not provided',
                    bankAccountOwner: 'Not provided',
                    preOrders: [],
                    totalSpent: 0
                };
                
                addUserToTable(user, adminUser.fullName, adminUser.email, adminUser.verifiedAt, 'admin_record');
                usersAdded++;
            });
            
            // Try encrypted user data if admin is authenticated (for detailed info)
            if (encryptedUserData && adminDataAccess.isAuthenticated) {
                try {
                    console.log('Attempting to decrypt encrypted user data for detailed info...');
                    const decryptedUserData = await adminDataAccess.decryptUserDataForAdmin(encryptedUserData);
                    console.log('Decrypted user data:', decryptedUserData);
                    
                    if (decryptedUserData && decryptedUserData.data) {
                        const user = decryptedUserData.data;
                        const userEmail = user.email || verifiedEmails || 'N/A';
                        const userName = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : 'User Account';
                        const accountCreated = decryptedUserData.storedAt || Date.now();
                        
                        // Update existing user with detailed info or add new one
                        updateUserWithDetailedInfo(user, userName, userEmail, accountCreated);
                    }
                } catch (error) {
                    console.error('Error decrypting user data:', error);
                }
            }
            
            // Show message if no users found
            if (usersAdded === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="py-8 px-4 text-center text-gray-400">
                        No verified users found. Users will appear here once they verify their email addresses.
                    </td>
                `;
                usersTableBody.appendChild(row);
            }

            // NEW: Apply order summaries to table (create or update rows)
            emailToOrderSummary.forEach((summary, email) => {
                // Skip guest/unknown emails here; they will appear in Guest Orders
                if (!email || email === 'unknown' || !email.includes('@')) return;
                const rowId = 'user-row-' + email.replace('@', '_at_');
                const existingRow = document.getElementById(rowId);
                const name = email.split('@')[0];
                const user = { preOrders: summary.preOrders, totalSpent: Number(summary.totalSpent.toFixed(2)) };
                if (existingRow) {
                    const cells = existingRow.querySelectorAll('td');
                    cells[3].textContent = user.preOrders.length;
                    cells[4].textContent = '‚Ç¨' + user.totalSpent;
                } else {
                    addUserToTable(user, name, email, Date.now(), 'orders');
                }
            });
        }

        // Load guests data (from guest orders only)
        function loadGuestsData() {
            const guestsTableBody = document.getElementById('guestsTableBody');
            if (!guestsTableBody) return;
            guestsTableBody.innerHTML = '';

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            // Group guest orders by a stable guest key (contactEmail if present, else a composite key)
            const guestMap = new Map();
            orders.forEach(o => {
                const isGuest = o.isGuest || !o.customerEmail || o.customerEmail === 'unknown' || !String(o.customerEmail).includes('@');
                if (!isGuest) return;
                const email = (o.contactEmail || '').trim();
                const key = email || `guest_${(o.recipient?.firstName||'').toLowerCase()}_${(o.recipient?.lastName||'').toLowerCase()}_${(o.recipient?.postalCode||'').toLowerCase()}`;
                const current = guestMap.get(key) || { name: `${o.recipient?.firstName||''} ${o.recipient?.lastName||''}`.trim() || 'Guest', email: email || 'N/A', address: '', orders: [], allShipped: true };
                const addr = o.recipient ? `${o.recipient.address1||''} ${o.recipient.address2||''}, ${o.recipient.postalCode||''} ${o.recipient.city||''}, ${o.recipient.country||''}`.replace(/\s+,/g, ',').trim() : '';
                current.address = current.address || addr;
                current.orders.push(o);
                current.allShipped = current.allShipped && !!o.shipped;
                guestMap.set(key, current);
            });

            if (guestMap.size === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="py-8 px-4 text-center text-gray-400">No guest orders yet.</td>`;
                guestsTableBody.appendChild(row);
                return;
            }

            guestMap.forEach((g, key) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5';
                const statusText = g.allShipped ? 'Shipping done' : `Waiting for shipping (${g.orders.filter(o=>!o.shipped).length})`;
                const statusClass = g.allShipped ? 'status-funded' : 'status-pending';
                const safeId = key.replace(/[^a-zA-Z0-9_\-]/g, '_');
                row.id = 'guest-row-' + safeId;
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm">${safeId}</td>
                    <td class="py-3 px-4 text-sm">${g.name}</td>
                    <td class="py-3 px-4 text-sm">${g.email}</td>
                    <td class="py-3 px-4 text-sm">${g.address || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm">${g.orders.length}</td>
                    <td class="py-3 px-4"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="py-3 px-4">
                        <button onclick="viewGuestOrdersForKey('${safeId}')" class="text-blue-400 hover:text-blue-300 text-sm">View Orders</button>
                    </td>
                `;
                guestsTableBody.appendChild(row);
            });
        }
        
        // Helper function to add user to table
        function addUserToTable(user, userName, userEmail, accountCreated, dataSource) {
            const usersTableBody = document.getElementById('usersTableBody');
            const row = document.createElement('tr');
            row.className = 'border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5';
            row.id = 'user-row-' + userEmail.replace('@', '_at_');
            
            const preOrders = user.preOrders ? user.preOrders.length : 0;
            const totalSpent = user.totalSpent || 0;
            // NEW: Determine label status from orders
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const userOrders = orders.filter(o => o.customerEmail === userEmail);
            const waitingCount = userOrders.filter(o => !o.labelGenerated).length;
            const hasWaiting = waitingCount > 0;
            const createdDate = new Date(accountCreated).toLocaleDateString();
            
            // Determine account status (shipping-based)
            const isVerified = localStorage.getItem('accountVerified') === 'true' || dataSource === 'admin_record';
            const userOrdersAll = orders.filter(o => o.customerEmail === userEmail);
            const anyUnshipped = userOrdersAll.some(o => !o.shipped);
            const statusText = anyUnshipped ? `Waiting for shipping (${userOrdersAll.filter(o=>!o.shipped).length})` : 'Shipping done';
            const statusClass = anyUnshipped ? 'status-pending' : 'status-funded';
            
            row.innerHTML = `
                <td class="py-3 px-4 text-sm">${userEmail.split('@')[0]}</td>
                <td class="py-3 px-4 text-sm">${userName}</td>
                <td class="py-3 px-4 text-sm">${userEmail}</td>
                <td class="py-3 px-4 text-sm">${preOrders}</td>
                <td class="py-3 px-4 text-sm">‚Ç¨${totalSpent}</td>
                <td class="py-3 px-4">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td class="py-3 px-4">
                    <button onclick="viewUserDetails('${userEmail}')" class="text-pink-400 hover:text-pink-300 text-sm">View Details</button>
                    <button onclick="viewUserOrders('${userEmail}')" class="text-blue-400 hover:text-blue-300 text-sm ml-2">View Orders</button>
                </td>
            `;
            
            usersTableBody.appendChild(row);
            
            console.log('User added to admin dashboard:', userEmail, 'Source:', dataSource);
        }
        
        // Helper function to update user with detailed info
        function updateUserWithDetailedInfo(user, userName, userEmail, accountCreated) {
            const rowId = 'user-row-' + userEmail.replace('@', '_at_');
            const existingRow = document.getElementById(rowId);
            
            if (existingRow) {
                // Update existing row with detailed info
                const cells = existingRow.querySelectorAll('td');
                cells[1].textContent = userName; // Update name
                cells[3].textContent = user.preOrders ? user.preOrders.length : 0; // Update pre-orders
                cells[4].textContent = '‚Ç¨' + (user.totalSpent || 0); // Update total spent
                console.log('Updated existing user with detailed info:', userEmail);
            } else {
                // Add new row with detailed info
                addUserToTable(user, userName, userEmail, accountCreated, 'encrypted');
            }
        }

        // Load campaigns data
        function loadCampaignsData() {
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '';

            // Get uploaded records from localStorage
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            console.log('All uploaded records:', records);
            
            // Filter crowdfunding campaigns
            const campaigns = records.filter(record => record.type === 'crowdfunding');
            console.log('Crowdfunding campaigns found:', campaigns);
            
            // Add sample campaigns if no real ones exist (for demo purposes)
            if (campaigns.length === 0) {
                campaigns.push(
                    {
                        id: 'campaign-1',
                        name: 'Ethereal Dreams',
                        artist: 'Luna Nova',
                        target: 5000,
                        raised: 2450,
                        backers: 78,
                        status: 'active',
                        daysLeft: 22
                    },
                    {
                        id: 'campaign-2',
                        name: 'Neon Dreams',
                        artist: 'Cyber Pulse',
                        target: 3000,
                        raised: 3200,
                        backers: 203,
                        status: 'funded',
                        daysLeft: 0
                    }
                );
            } else {
                // Transform real campaigns to match the display format
                campaigns.forEach(campaign => {
                    campaign.name = campaign.albumTitle;
                    campaign.artist = campaign.artistName;
                    campaign.target = campaign.fundingGoal;
                    campaign.raised = campaign.raised || 0;
                    campaign.backers = campaign.backers || 0;
                    campaign.daysLeft = calculateDaysLeft(campaign.startDate, campaign.campaignDays);
                    campaign.status = campaign.raised >= campaign.fundingGoal ? 'funded' : 
                                    campaign.daysLeft <= 0 ? 'ended' : 'active';
                });
            }

            campaigns.forEach(campaign => {
                const campaignCard = document.createElement('div');
                campaignCard.className = 'p-4 bg-white bg-opacity-5 rounded-xl';
                
                const progressPercent = Math.min((campaign.raised / campaign.target) * 100, 100);
                const statusClass = campaign.status === 'funded' ? 'status-funded' : 
                                  campaign.status === 'shipped' ? 'status-shipped' : 'status-pending';
                const statusText = campaign.status === 'funded' ? 'Funded' : 
                                 campaign.status === 'shipped' ? 'Shipped' : 'Active';
                
                campaignCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-semibold text-lg">${campaign.name}</h4>
                            <p class="text-sm text-gray-400">by ${campaign.artist}</p>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <p class="text-sm text-gray-400 mt-1">${campaign.backers} backers</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-400">Progress</span>
                            <span class="text-sm font-semibold">‚Ç¨${campaign.raised} / ‚Ç¨${campaign.target}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-pink-500 to-purple-500 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${progressPercent.toFixed(1)}% funded ${campaign.daysLeft > 0 ? `‚Ä¢ ${campaign.daysLeft} days left` : ''}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewCampaignDetails('${campaign.id}')" class="glass-card px-3 py-1 rounded text-xs hover:bg-white hover:bg-opacity-10">
                            Details
                        </button>
                        <button onclick="endCampaign('${campaign.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold transition-colors duration-200">
                            End Campaign
                        </button>
                        <button onclick="deleteCampaign('${campaign.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-semibold transition-colors duration-200">
                            Delete
                        </button>
                    </div>
                `;
                
                campaignsList.appendChild(campaignCard);
            });
        }

        function calculateDaysLeft(startDate, campaignDays) {
            const start = new Date(startDate);
            const end = new Date(start.getTime() + (campaignDays * 24 * 60 * 60 * 1000));
            const now = new Date();
            const diffTime = end - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        // Load inventory data
        function loadInventoryData() {
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';

            // Get uploaded records from localStorage
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            console.log('All uploaded records for inventory:', records);
            
            // Filter immediate sale records (match collection page logic exactly)
            const inventoryItems = records.filter(record => 
                record.type === 'immediate' && 
                record.status === 'available' && 
                (Number(record.quantity) || 0) > 0
            );
            console.log('Immediate sale records found (admin inventory):', inventoryItems);
            
            if (inventoryItems.length === 0) {
                inventoryList.innerHTML = `
                    <div class="admin-card rounded-xl p-8 text-center">
                        <div class="w-16 h-16 bg-green-400 bg-opacity-20 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">No Inventory Items</h4>
                        <p class="text-gray-300 text-sm mb-4">Upload immediate sale records to manage inventory</p>
                        <a href="admin-upload.html" class="text-pink-400 hover:text-pink-300 text-sm font-medium">
                            Upload a Record ‚Üí
                        </a>
                    </div>
                `;
                return;
            }

            inventoryItems.forEach(item => {
                const inventoryElement = document.createElement('div');
                inventoryElement.className = 'admin-card rounded-xl p-6 mb-4';
                
                const stockPercentage = (item.quantity / (item.quantity + (item.sold || 0))) * 100;
                const isLowStock = item.quantity <= 10;
                const isOutOfStock = item.quantity <= 0;
                
                let statusClass = 'status-funded';
                let statusText = 'Available';
                
                if (isOutOfStock) {
                    statusClass = 'status-refunded';
                    statusText = 'Out of Stock';
                } else if (isLowStock) {
                    statusClass = 'status-pending';
                    statusText = 'Low Stock';
                }

                inventoryElement.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold mb-1">${item.albumTitle}</h4>
                            <p class="text-gray-300 text-sm">by ${item.artistName}</p>
                        </div>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-300">Stock Level</span>
                            <span class="text-white">${item.quantity} / ${item.quantity + (item.sold || 0)} units</span>
                        </div>
                        <div class="w-full bg-white bg-opacity-10 rounded-full h-3 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-1000 ease-out" 
                                 style="width: ${stockPercentage}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${stockPercentage.toFixed(1)}% in stock</p>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex space-x-4">
                            <span class="text-gray-300">‚Ç¨${item.price}</span>
                            <span class="text-gray-300">${item.sold || 0} sold</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="updateInventory('${item.id}')" class="text-pink-400 hover:text-pink-300 text-sm font-medium">
                                Update Stock
                            </button>
                            <button onclick="viewInventoryDetails('${item.id}')" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
                                Details
                            </button>
                            <button onclick="deleteInventoryItem('${item.id}')" class="text-red-400 hover:text-red-300 text-sm font-medium">
                                Delete Item
                            </button>
                        </div>
                    </div>
                `;
                
                inventoryList.appendChild(inventoryElement);
            });
        }

        // Update statistics
        function updateStatistics() {
            // Update total users (unique registered users only; exclude guests)
            const adminUserKeys = Object.keys(localStorage).filter(key => key.startsWith('admin_user_'));
            const adminUserEmails = new Set();
            adminUserKeys.forEach(key => {
                try { const rec = JSON.parse(localStorage.getItem(key) || '{}'); if (rec && rec.email) adminUserEmails.add(rec.email); } catch (_) {}
            });

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const registeredEmails = new Set();
            orders.forEach(o => {
                const email = (o.customerEmail || '').trim();
                const isGuest = o.isGuest || !email || !email.includes('@');
                if (!isGuest) registeredEmails.add(email);
            });

            // Include any verified account email stored locally
            const verifiedEmail = (localStorage.getItem('verifiedEmail') || '').trim();
            if (verifiedEmail && verifiedEmail.includes('@')) registeredEmails.add(verifiedEmail);

            // Include cached display data email (registered user with no orders yet)
            try {
                const cached = JSON.parse(localStorage.getItem('cachedDisplayData') || 'null');
                const cachedEmail = (cached && cached.email ? String(cached.email).trim() : '');
                if (cachedEmail && cachedEmail.includes('@')) registeredEmails.add(cachedEmail);
            } catch (_) {}

            // Union of registered emails and admin-account emails
            const uniqueUsersCount = new Set([...registeredEmails, ...adminUserEmails]).size;
            document.getElementById('totalUsers').textContent = uniqueUsersCount;

            // Update active campaigns
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const activeCampaigns = records.filter(record => record.type === 'crowdfunding' && record.status !== 'ended').length;
            document.getElementById('activeCampaigns').textContent = activeCampaigns;

            // Update total revenue
            const totalRevenue = records.reduce((sum, record) => {
                if (record.type === 'immediate') {
                    return sum + (record.price * (record.sold || 0));
                } else if (record.type === 'crowdfunding') {
                    return sum + (record.raised || 0);
                }
                return sum;
            }, 0);
            document.getElementById('totalRevenue').textContent = '‚Ç¨' + totalRevenue.toLocaleString();

            // Update pending refunds (for demo purposes)
            document.getElementById('pendingRefunds').textContent = '0';

            // Update guest orders count (only truly guest/unknown emails or flagged isGuest)
            const guestOrders = orders.filter(o => o.isGuest || !o.customerEmail || o.customerEmail === 'unknown' || !String(o.customerEmail).includes('@'));
            document.getElementById('guestOrdersCount').textContent = guestOrders.length;
        }

        // User management functions
        async function viewUserDetails(email) {
            // Get user data from localStorage
            const userData = localStorage.getItem('userData');
            const verifiedEmails = localStorage.getItem('verifiedEmail');
            const cachedDisplayData = localStorage.getItem('cachedDisplayData');
            
            console.log('Viewing details for user:', email);
            console.log('Available data:', { userData: !!userData, verifiedEmails, cachedDisplayData: !!cachedDisplayData });
            
            // Create a modal instead of alert for better display
            await showUserDetailsModal(email, userData, cachedDisplayData);
        }
        
        async function showUserDetailsModal(email, userData, cachedDisplayData) {
            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.onclick = function(e) {
                if (e.target === backdrop) {
                    document.body.removeChild(backdrop);
                }
            };
            
            let userInfo = '';
            let hasFullData = false;
            let dataSource = 'none';
            
            console.log('Modal data check:', { userData: !!userData, cachedDisplayData: !!cachedDisplayData, email });
            
            // Try to get user data from multiple sources
            let user = null;
            let parsedUserData = null;
            
            // First try cached display data (most reliable)
            if (cachedDisplayData) {
                try {
                    console.log('Attempting to retrieve user data from cached display data...');
                    const cached = JSON.parse(cachedDisplayData);
                    console.log('Cached display data:', cached);
                    
                    if (cached && cached.email === email) {
                        console.log('Found user data in cached display data');
                        // Create a user object from cached data
                        user = {
                            firstName: cached.firstName || 'N/A',
                            lastName: cached.lastName || 'N/A',
                            email: cached.email,
                            username: cached.username || cached.email.split('@')[0],
                            phone: cached.phone || 'Not provided',
                            shippingAddress: cached.shippingAddress || 'Not provided',
                            iban: cached.iban || 'Not provided',
                            bic: cached.bic || 'Not provided',
                            bankAccountOwner: cached.bankAccountOwner || 'Not provided',
                            preOrders: cached.preOrders || [],
                            totalSpent: cached.totalSpent || 0
                        };
                        
                        parsedUserData = {
                            storedAt: cached.timestamp || Date.now()
                        };
                        
                        hasFullData = true;
                        dataSource = 'cached';
                        console.log('Successfully created user object from cached data:', user);
                    }
                } catch (error) {
                    console.error('Error parsing cached display data:', error);
                }
            }
            
            // Try encrypted user data if admin is authenticated
            if (!hasFullData) {
                const encryptedUserData = localStorage.getItem('wax_encounters_user_data');
                if (encryptedUserData && adminDataAccess.isAuthenticated) {
                    try {
                        console.log('Attempting to decrypt encrypted user data...');
                        const decryptedUserData = await adminDataAccess.decryptUserDataForAdmin(encryptedUserData);
                        console.log('Decrypted user data:', decryptedUserData);
                        
                        if (decryptedUserData && decryptedUserData.data) {
                            user = decryptedUserData.data;
                            parsedUserData = decryptedUserData;
                            hasFullData = true;
                            dataSource = 'encrypted';
                            console.log('Successfully created user object from encrypted data:', user);
                        }
                    } catch (error) {
                        console.error('Error decrypting user data:', error);
                    }
                }
            }
            
            // Fallback to regular userData if available
            if (!hasFullData && userData) {
                try {
                    parsedUserData = JSON.parse(userData);
                    user = parsedUserData.data;
                    hasFullData = true;
                    dataSource = 'userData';
                    console.log('Successfully parsed user data for modal:', user);
                } catch (error) {
                    console.error('Error parsing userData in modal:', error);
                }
            }
            
            if (hasFullData && user) {
                console.log('Displaying full user data for:', email);
                console.log('User object:', user);
                
                userInfo = `
                    <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">User Account Details</h2>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üë§ Personal Information</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">Full Name:</span> <span class="text-white">${user.firstName || 'N/A'} ${user.lastName || 'N/A'}</span></div>
                                    <div><span class="text-gray-300">Email:</span> <span class="text-white">${user.email || email}</span></div>
                                    <div><span class="text-gray-300">Username:</span> <span class="text-white">${user.username || 'N/A'}</span></div>
                                    <div><span class="text-gray-300">Phone:</span> <span class="text-white">${user.phone || 'Not provided'}</span></div>
                                </div>
                            </div>
                            
                            <!-- Shipping Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üì¶ Shipping Address</h3>
                                <div class="text-sm">
                                    <div><span class="text-gray-300">Address:</span></div>
                                    <div class="text-white mt-1 pl-2">${user.shippingAddress || 'Not provided'}</div>
                                </div>
                            </div>
                            
                            <!-- Banking Information -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üè¶ Banking Details (Refunds)</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">IBAN:</span> <span class="text-white font-mono">${user.iban || 'Not provided'}</span></div>
                                    <div><span class="text-gray-300">BIC:</span> <span class="text-white font-mono">${user.bic || 'Not provided'}</span></div>
                                    <div><span class="text-gray-300">Account Owner:</span> <span class="text-white">${user.bankAccountOwner || 'Not provided'}</span></div>
                                </div>
                            </div>
                            
                            <!-- Account Status -->
                            <div class="bg-black bg-opacity-30 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-pink-400 mb-4">üìä Account Status</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-300">Created:</span> <span class="text-white">${new Date(parsedUserData?.storedAt || Date.now()).toLocaleDateString()}</span></div>
                                    <div><span class="text-gray-300">Status:</span> <span class="text-green-400">${localStorage.getItem('accountVerified') === 'true' ? 'Verified ‚úì' : 'Not Verified'}</span></div>
                                    <div><span class="text-gray-300">Pre-orders:</span> <span class="text-white">${user.preOrders ? user.preOrders.length : 0}</span></div>
                                    <div><span class="text-gray-300">Total Spent:</span> <span class="text-white">‚Ç¨${user.totalSpent || 0}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Debug Information -->
                        <div class="mt-6 bg-yellow-500 bg-opacity-10 border border-yellow-500 border-opacity-30 rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-2">üîç Debug Information</h3>
                            <div class="text-xs text-gray-300 space-y-1">
                                <div>Raw User Data Available: ${userData ? 'Yes' : 'No'}</div>
                                <div>Cached Display Data Available: ${cachedDisplayData ? 'Yes' : 'No'}</div>
                                <div>Encrypted User Data Available: ${localStorage.getItem('wax_encounters_user_data') ? 'Yes' : 'No'}</div>
                                <div>Data Retrieved From: ${dataSource === 'cached' ? 'Cached Display Data' : dataSource === 'encrypted' ? 'Encrypted Storage (Admin Decrypted)' : dataSource === 'userData' ? 'User Data Storage' : 'Unknown'}</div>
                                <div>Admin Authenticated: ${adminDataAccess.isAuthenticated ? 'Yes' : 'No'}</div>
                                <div>Security Status: ${adminDataAccess.isAuthenticated ? 'üîì Decrypted Access' : 'üîí Encrypted (Limited Access)'}</div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-6 flex gap-4 justify-end">
                            <button onclick="processRefund('${email}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                                üí∞ Process Refund
                            </button>
                            <button onclick="initiateShipping('${email}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                üì¶ Generate Label
                            </button>
                            <button onclick="contactUser('${email}')" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                                üìß Contact User
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Fallback for partial data
                userInfo = `
                    <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-2xl w-full">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">User Account Details</h2>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                        </div>
                        <div class="text-center text-gray-300">
                            <p>Limited user data available for: ${email}</p>
                            <p class="mt-2">Account Status: ${localStorage.getItem('accountVerified') === 'true' ? 'Verified ‚úì' : 'Not Verified'}</p>
                            <p class="mt-4 text-sm">Full user details will be available once the user completes their profile.</p>
                        </div>
                    </div>
                `;
            }
            
            backdrop.innerHTML = userInfo;
            document.body.appendChild(backdrop);
        }
        
        // Admin action functions
        function processRefund(email) {
            alert(`Processing refund for: ${email}\n\nThis would:\n- Verify refund amount\n- Process bank transfer\n- Send confirmation email\n- Update account status`);
        }
        
        function initiateShipping(email) {
            try {
                // Retrieve last shipping selection saved from payment page
                const saved = JSON.parse(localStorage.getItem('lastSelectedShipping') || 'null');
                if (!saved || !saved.selection || !saved.address) {
                    alert('No recent shipping selection found. Ask the customer to calculate shipping on the payment page first.');
                    return;
                }

                const payload = {
                    selectedServiceId: saved.selection.id,
                    recipient: {
                        firstName: saved.address.firstName,
                        lastName: saved.address.lastName,
                        address1: saved.address.address1,
                        address2: saved.address.address2,
                        city: saved.address.city,
                        state: saved.address.state,
                        postalCode: saved.address.postalCode,
                        country: saved.address.country,
                        email: email
                    },
                    parcel: {
                        lengthCm: 33,
                        widthCm: 33,
                        heightCm: 3,
                        weightKg: 0.8
                    }
                };

                // Label generation via server has been removed. Shipping is tracked with the "Mark Shipping Done" flow.
                alert('Server label generation is disabled. Use "Mark Shipping Done" in order views.');
            } catch (e) {
                console.error('Initiate shipping error:', e);
                alert('Unexpected error while generating the label.');
            }
        }
        
        function contactUser(email) {
            alert(`Contact user: ${email}\n\nThis would open email client or show contact options for:\n- Campaign updates\n- Shipping notifications\n- Refund confirmations\n- General support`);
        }
        
        // Debug function to help troubleshoot user data
        function debugUserData() {
            console.log('=== ADMIN DASHBOARD DEBUG ===');
            console.log('All localStorage keys:', Object.keys(localStorage));
            
            // Check each key for user data
            Object.keys(localStorage).forEach(key => {
                if (key.includes('user') || key.includes('data') || key.includes('account') || key.includes('cached')) {
                    console.log(`\nKey: ${key}`);
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        console.log('Parsed data:', parsed);
                        
                        // Check if this looks like user data
                        if (parsed && parsed.data && (parsed.data.email || parsed.data.username)) {
                            console.log('üéØ FOUND USER DATA in key:', key);
                            console.log('User email:', parsed.data.email);
                            console.log('User name:', parsed.data.firstName, parsed.data.lastName);
                            console.log('Full user object:', parsed.data);
                        }
                    } catch (e) {
                        console.log('Raw data (not JSON):', localStorage.getItem(key));
                    }
                }
            });
            
            console.log('\n=== VERIFICATION STATUS ===');
            console.log('accountVerified:', localStorage.getItem('accountVerified'));
            console.log('verifiedEmail:', localStorage.getItem('verifiedEmail'));
            
            console.log('\n=== SECURE STORAGE MANAGER ===');
            console.log('SecureStorageManager available:', !!window.SecureStorageManager);
            if (window.SecureStorageManager) {
                console.log('Session valid:', window.SecureStorageManager.isSessionValid());
            }
            
            console.log('=== END DEBUG ===');
        }
        
        // Make debug function globally available
        window.debugUserData = debugUserData;

        // Function to recalculate campaign stats from orders
        window.recalculateCampaignStats = function() {
            console.log('=== RECALCULATING CAMPAIGN STATS ===');
            
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            
            // Group orders by recordId
            const ordersByRecord = {};
            orders.forEach(order => {
                if (!ordersByRecord[order.recordId]) {
                    ordersByRecord[order.recordId] = [];
                }
                ordersByRecord[order.recordId].push(order);
            });
            
            // Update each record with actual order data
            let updatedRecords = 0;
            records.forEach(record => {
                const recordOrders = ordersByRecord[record.id] || [];
                const actualBackers = recordOrders.length;
                const actualRaised = recordOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
                
                if (record.backers !== actualBackers || record.raised !== actualRaised) {
                    record.backers = actualBackers;
                    record.raised = actualRaised;
                    updatedRecords++;
                    console.log(`Updated ${record.albumTitle}: ${actualBackers} backers, ‚Ç¨${actualRaised} raised`);
                }
            });
            
            if (updatedRecords > 0) {
                localStorage.setItem('uploadedRecords', JSON.stringify(records));
                console.log(`Updated ${updatedRecords} campaign records`);
            }
            
            alert(`Campaign stats recalculated!\n\nUpdated ${updatedRecords} campaigns with actual order data.\n\nClick "Refresh Data" to see updated stats.`);
        };

        // Function to clean up test users and orders
        window.cleanupTestData = function() {
            console.log('=== CLEANING UP TEST DATA ===');
            
            // Remove orders with test emails
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const testEmails = ['your-email@example.com', 'your-real-email@example.com', 'test@example.com', 'example@test.com'];
            const cleanedOrders = orders.filter(o => !testEmails.includes(o.customerEmail));
            
            if (orders.length !== cleanedOrders.length) {
                localStorage.setItem('orders', JSON.stringify(cleanedOrders));
                console.log(`Removed ${orders.length - cleanedOrders.length} test orders`);
            }
            
            // Remove admin user records with test emails
            const adminKeys = Object.keys(localStorage).filter(key => key.startsWith('admin_user_'));
            let removedAdminUsers = 0;
            adminKeys.forEach(key => {
                try {
                    const userRecord = JSON.parse(localStorage.getItem(key));
                    if (testEmails.includes(userRecord.email)) {
                        localStorage.removeItem(key);
                        removedAdminUsers++;
                        console.log(`Removed admin user record: ${userRecord.email}`);
                    }
                } catch (e) {
                    console.warn('Error processing admin user record:', key, e);
                }
            });
            
            // Clean up userData entries
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            let removedUserData = 0;
            testEmails.forEach(email => {
                if (userData[email]) {
                    delete userData[email];
                    removedUserData++;
                    console.log(`Removed userData for: ${email}`);
                }
            });
            if (removedUserData > 0) {
                localStorage.setItem('userData', JSON.stringify(userData));
            }
            
            console.log(`Cleanup complete: ${removedAdminUsers} admin users, ${removedUserData} userData entries, ${orders.length - cleanedOrders.length} orders removed`);
            alert(`Test data cleaned up!\n\nRemoved:\n- ${orders.length - cleanedOrders.length} test orders\n- ${removedAdminUsers} admin user records\n- ${removedUserData} userData entries\n\nClick "Refresh Data" to see updated dashboard.`);
        };

        // Function to check what user data exists in localStorage
        window.checkAllUserData = function() {
            console.log('=== COMPLETE USER DATA CHECK ===');
            
            // Check all localStorage keys
            const allKeys = Object.keys(localStorage);
            console.log('All localStorage keys:', allKeys);
            
            // Check for different types of user data
            const userDataKeys = allKeys.filter(key => 
                key.includes('user') || 
                key.includes('User') || 
                key.includes('account') || 
                key.includes('wax_encounters') ||
                key.includes('verified') ||
                key.includes('cached')
            );
            
            console.log('User-related keys found:', userDataKeys);
            
            userDataKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    console.log(`Key: ${key}`);
                    console.log(`Value:`, value);
                    if (value && value.startsWith('{')) {
                        const parsed = JSON.parse(value);
                        console.log(`Parsed:`, parsed);
                    }
                    console.log('---');
                } catch (e) {
                    console.log(`Key: ${key} - Error parsing:`, e.message);
                }
            });
            
            // Check if you can log in normally
            console.log('Can you log in normally? Try logging in and then check this again.');
            console.log('===============================');
        };

        // Function to manually restore user data to admin dashboard
        window.restoreUserToAdminDashboard = function() {
            console.log('=== MANUAL USER RESTORATION ===');
            
            // Check if you can log in normally first
            const canLogin = window.SecureStorageManager && window.SecureStorageManager.hasUserData();
            console.log('Can login normally:', canLogin);
            
            if (!canLogin) {
                alert('No user data found. Please log in normally first, then try this function again.');
                return;
            }
            
            // Try to get user data
            const userData = localStorage.getItem('userData');
            const verifiedEmail = localStorage.getItem('verifiedEmail');
            const accountVerified = localStorage.getItem('accountVerified');
            
            console.log('User data exists:', !!userData);
            console.log('Verified email:', verifiedEmail);
            console.log('Account verified:', accountVerified);
            
            if (userData || verifiedEmail || accountVerified) {
                // Create a simple user record for the admin dashboard
                const simpleUser = {
                    firstName: 'User',
                    lastName: 'Account',
                    email: verifiedEmail || 'user@example.com',
                    username: verifiedEmail ? verifiedEmail.split('@')[0] : 'user',
                    phone: 'Not provided',
                    shippingAddress: 'Not provided',
                    iban: 'Not provided',
                    bic: 'Not provided',
                    bankAccountOwner: 'Not provided',
                    preOrders: [],
                    totalSpent: 0
                };
                
                // Add to admin user records
                const adminUserKey = `admin_user_${Date.now()}`;
                const adminUserRecord = {
                    email: simpleUser.email,
                    username: simpleUser.username,
                    fullName: `${simpleUser.firstName} ${simpleUser.lastName}`,
                    verifiedAt: new Date().toISOString(),
                    source: 'manual_restoration'
                };
                
                localStorage.setItem(adminUserKey, JSON.stringify(adminUserRecord));
                console.log('Created admin user record:', adminUserRecord);
                
                alert('User data restored to admin dashboard! Click "Refresh Data" to see it.');
                
                // Refresh the dashboard
                loadUsersData();
            } else {
                alert('No user data found. Please create a new account or log in first.');
            }
            
            console.log('===============================');
        };


        function viewCampaignDetails(campaignId) {
            alert(`Campaign Details: ${campaignId}\n\nThis would show:\n- Detailed campaign information\n- Backer list\n- Financial breakdown\n- Timeline and milestones`);
        }

        // Inventory management functions
        function updateInventory(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            const newQuantity = prompt(`Update stock for "${record.albumTitle}"\n\nCurrent quantity: ${record.quantity}\nEnter new quantity:`, record.quantity);
            
            if (newQuantity !== null && !isNaN(newQuantity) && newQuantity >= 0) {
                const success = window.PurchaseTracker.updateInventory(recordId, parseInt(newQuantity));
                
                if (success) {
                    alert(`Stock updated successfully!\n\nNew quantity: ${newQuantity}`);
                    loadInventoryData(); // Refresh inventory display
                } else {
                    alert('Failed to update stock');
                }
            }
        }

        function viewInventoryDetails(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            const details = `
Inventory Details: ${record.albumTitle}

Artist: ${record.artistName}
Genre: ${record.genre || 'Not specified'}
Price: ‚Ç¨${record.price}
Current Stock: ${record.quantity} units
Sold: ${record.sold || 0} units
Total Units: ${record.quantity + (record.sold || 0)} units
Status: ${record.status}
Uploaded: ${new Date(record.uploadedAt).toLocaleDateString()}

Description:
${record.description || 'No description provided'}
            `;

            alert(details);
        }

        function deleteInventoryItem(recordId) {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const record = records.find(r => r.id === recordId);
            
            if (!record) {
                alert('Record not found');
                return;
            }

            // Show confirmation dialog with record details
            const confirmMessage = `Are you sure you want to delete this inventory item?\n\n` +
                `Album: ${record.albumTitle}\n` +
                `Artist: ${record.artistName}\n` +
                `Current Stock: ${record.quantity} units\n` +
                `Sold: ${record.sold || 0} units\n\n` +
                `This action cannot be undone!`;
            
            if (confirm(confirmMessage)) {
                // Remove the record from the main records array
                const updatedRecords = records.filter(r => r.id !== recordId);
                
                // Update localStorage with cleaned records
                localStorage.setItem('uploadedRecords', JSON.stringify(updatedRecords));
                
                // Clean up any related orders that reference this record
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const updatedOrders = orders.filter(order => order.recordId !== recordId);
                localStorage.setItem('orders', JSON.stringify(updatedOrders));
                
                // Clean up any user pre-orders that reference this record
                const allUserKeys = Object.keys(localStorage).filter(key => key.startsWith('wax_encounters_user_data_'));
                allUserKeys.forEach(userKey => {
                    try {
                        const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
                        if (userData.data && userData.data.preOrders) {
                            const updatedPreOrders = userData.data.preOrders.filter(preOrder => preOrder.recordId !== recordId);
                            userData.data.preOrders = updatedPreOrders;
                            localStorage.setItem(userKey, JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.warn('Could not update user pre-orders for key:', userKey, error);
                    }
                });
                
                // Clean up any cached display data that might reference this record
                const cachedData = JSON.parse(localStorage.getItem('cachedDisplayData') || '{}');
                if (cachedData.preOrders) {
                    cachedData.preOrders = cachedData.preOrders.filter(preOrder => preOrder.recordId !== recordId);
                    localStorage.setItem('cachedDisplayData', JSON.stringify(cachedData));
                }
                
                // Show success message
                alert(`"${record.albumTitle}" has been completely removed from the website!\n\n` +
                      `‚úÖ Removed from inventory\n` +
                      `‚úÖ Removed from all user accounts\n` +
                      `‚úÖ Removed from order history\n` +
                      `‚úÖ Cleaned up all references`);
                
                // Refresh all dashboard displays
                loadInventoryData();
                loadCampaignsData();
                loadUsersData();
                updateStatistics();
                
                console.log('Record completely deleted from all locations:', recordId);
            }
        }

        // Campaign management functions
        function endCampaign(campaignId) {
            console.log('Ending campaign:', campaignId);
            
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const campaign = records.find(r => r.id === campaignId);
            
            if (!campaign) {
                alert('Campaign not found!');
                return;
            }

            // Check if campaign is already ended
            if (campaign.status === 'ended' || campaign.status === 'pressing') {
                alert('This campaign has already been ended!');
                return;
            }

            // Show confirmation dialog
            const confirmMessage = `üéµ End Campaign & Proceed to Press\n\n` +
                `"${campaign.albumTitle}" by ${campaign.artistName}\n\n` +
                `Current Status:\n` +
                `‚Ä¢ Raised: $${campaign.raised || 0}\n` +
                `‚Ä¢ Goal: $${campaign.fundingGoal || 0}\n` +
                `‚Ä¢ Backers: ${campaign.backers || 0}\n\n` +
                `This will:\n` +
                `‚Ä¢ Stop accepting new pre-orders\n` +
                `‚Ä¢ Show "Proceeding to Press" status\n` +
                `‚Ä¢ Keep campaign visible on Support a Record page\n` +
                `‚Ä¢ Allow you to finance any remaining amount\n\n` +
                `Are you sure you want to end this campaign?`;
            
            if (confirm(confirmMessage)) {
                // Update campaign status
                campaign.status = 'pressing';
                campaign.endedAt = new Date().toISOString();
                campaign.endedBy = 'admin';
                
                // Update localStorage
                const updatedRecords = records.map(r => r.id === campaignId ? campaign : r);
                localStorage.setItem('uploadedRecords', JSON.stringify(updatedRecords));
                
                // Show success message
                alert(`‚úÖ Campaign Ended Successfully!\n\n` +
                      `"${campaign.albumTitle}" is now proceeding to press.\n\n` +
                      `‚Ä¢ No new pre-orders will be accepted\n` +
                      `‚Ä¢ Campaign remains visible on Support a Record page\n` +
                      `‚Ä¢ Status shows "Proceeding to Press"`);
                
                // Refresh dashboard
                loadCampaignsData();
                updateStatistics();
                
                console.log('Campaign ended and moved to pressing phase:', campaignId);
            }
        }

        function deleteCampaign(campaignId) {
            console.log('Deleting campaign:', campaignId);
            
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const campaign = records.find(r => r.id === campaignId);
            
            if (!campaign) {
                alert('Campaign not found!');
                return;
            }

            // Show clean confirmation dialog
            const confirmMessage = `üóëÔ∏è Delete Campaign\n\n` +
                `"${campaign.albumTitle}" by ${campaign.artistName}\n\n` +
                `This will permanently remove the campaign from:\n` +
                `‚Ä¢ Support a Record page\n` +
                `‚Ä¢ All user pre-orders\n` +
                `‚Ä¢ Campaign progress tracking\n\n` +
                `This action cannot be undone.\n\n` +
                `Are you sure you want to delete this campaign?`;
            
            if (confirm(confirmMessage)) {
                // Remove the campaign from the main records array
                const updatedRecords = records.filter(r => r.id !== campaignId);
                
                // Update localStorage with cleaned records
                localStorage.setItem('uploadedRecords', JSON.stringify(updatedRecords));
                
                // Clean up any related orders that reference this campaign
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const updatedOrders = orders.filter(order => order.recordId !== campaignId);
                localStorage.setItem('orders', JSON.stringify(updatedOrders));
                
                // Clean up any user pre-orders that reference this campaign
                const allUserKeys = Object.keys(localStorage).filter(key => key.startsWith('wax_encounters_user_data_'));
                allUserKeys.forEach(userKey => {
                    try {
                        const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
                        if (userData.data && userData.data.preOrders) {
                            const updatedPreOrders = userData.data.preOrders.filter(preOrder => preOrder.recordId !== campaignId);
                            userData.data.preOrders = updatedPreOrders;
                            localStorage.setItem(userKey, JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.warn('Could not update user pre-orders for key:', userKey, error);
                    }
                });
                
                // Clean up any cached display data that might reference this campaign
                const cachedData = JSON.parse(localStorage.getItem('cachedDisplayData') || '{}');
                if (cachedData.preOrders) {
                    cachedData.preOrders = cachedData.preOrders.filter(preOrder => preOrder.recordId !== campaignId);
                    localStorage.setItem('cachedDisplayData', JSON.stringify(cachedData));
                }
                
                // Show clean success message
                alert(`‚úÖ Campaign Deleted Successfully!\n\n` +
                      `"${campaign.albumTitle}" has been completely removed from the website.`);
                
                // Refresh all dashboard displays
                loadInventoryData();
                loadCampaignsData();
                loadUsersData();
                updateStatistics();
                
                console.log('Campaign completely deleted from all locations:', campaignId);
            }
        }

        // Refresh data
        document.getElementById('refreshUsersBtn').addEventListener('click', function() {
            loadDashboardData();
            alert('Dashboard data refreshed!');
        });

        // Admin logout is handled only via inline onclick -> handleLogoutClick()

        // NEW: View Orders modal with per-order label actions
        function viewUserOrders(email) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const userOrders = orders.filter(o => o.customerEmail === email);

            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.onclick = function(e) { if (e.target === backdrop) document.body.removeChild(backdrop); };

            // Sort orders: waiting first, then processed
            const sortedOrders = userOrders.sort((a, b) => {
                if (!!a.shipped === !!b.shipped) {
                    return new Date(b.timestamp) - new Date(a.timestamp); // Newest first
                }
                return a.shipped ? 1 : -1; // Waiting orders first
            });

            const list = sortedOrders.map(o => `
                <div class="bg-black bg-opacity-30 rounded-xl p-4 mb-3 border-l-4 ${o.shipped ? 'border-green-400' : 'border-yellow-400'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold">${o.recordTitle} <span class="text-gray-400">(${o.recordId})</span></div>
                            <div class="text-sm text-gray-400">‚Ç¨${o.amount} ‚Ä¢ ${new Date(o.timestamp).toLocaleString()}</div>
                            ${o.recipient ? `<div class="text-xs text-gray-400 mt-1">${o.recipient.firstName || ''} ${o.recipient.lastName || ''} ‚Äî ${o.recipient.address1 || ''} ${o.recipient.address2 || ''}, ${o.recipient.postalCode || ''} ${o.recipient.city || ''}, ${o.recipient.country || ''}</div>` : ''}
                            <div class="text-sm ${o.shipped ? 'text-green-400' : 'text-yellow-400'}">${o.shipped ? '‚úÖ Shipping done' : '‚è≥ Waiting for shipping'}</div>
                            ${o.shipping ? `<div class="text-xs text-gray-500 mt-1">Shipping: ${o.shipping.carrier} ${o.shipping.serviceName}</div>` : ''}
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button ${o.shipped ? 'disabled' : ''} onclick="markOrderShipped('${email}','${o.id}')" class="px-3 py-1 rounded text-sm ${o.shipped ? 'bg-gray-600 text-gray-300' : 'bg-green-500 hover:bg-green-600 text-white'}">${o.shipped ? 'Shipping Done' : 'Mark Shipping Done'}</button>
                        </div>
                    </div>
                </div>
            `).join('');

            const waitingCount = userOrders.filter(o => !o.shipped).length;
            const processedCount = userOrders.filter(o => o.shipped).length;

            backdrop.innerHTML = `
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold">Orders for ${email}</h2>
                            <div class="text-sm text-gray-400 mt-1">
                                ${waitingCount} waiting ‚Ä¢ ${processedCount} processed ‚Ä¢ ${userOrders.length} total
                            </div>
                        </div>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                    </div>
                    ${userOrders.length ? list : '<div class="text-gray-300">No orders found for this user.</div>'}
                </div>
            `;
            document.body.appendChild(backdrop);
        }

        function markOrderShipped(email, orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const idx = orders.findIndex(o => o.id === orderId && o.customerEmail === email);
            if (idx === -1) { alert('Order not found'); return; }
            orders[idx].shipped = true;
            localStorage.setItem('orders', JSON.stringify(orders));
            loadUsersData();
            // Refresh modal
            document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
            viewUserOrders(email);
        }

        // NEW: Guest Orders modal
        function viewGuestOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const guests = orders.filter(o => o.isGuest || !o.customerEmail || o.customerEmail === 'unknown' || !o.customerEmail.includes('@'));

            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.onclick = function(e) { if (e.target === backdrop) document.body.removeChild(backdrop); };

            const list = guests.map(o => `
                <div class="bg-black bg-opacity-30 rounded-xl p-4 mb-3 border-l-4 ${o.shipped ? 'border-green-400' : 'border-yellow-400'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold">${o.recordTitle} <span class="text-gray-400">(${o.recordId})</span></div>
                            <div class="text-sm text-gray-400">‚Ç¨${o.amount} ‚Ä¢ ${new Date(o.timestamp).toLocaleString()}</div>
                            <div class="text-xs text-gray-500 mt-1">Guest order</div>
                            ${o.recipient ? `<div class=\"text-xs text-gray-400 mt-1\">${o.recipient.firstName || ''} ${o.recipient.lastName || ''} ‚Äî ${o.recipient.address1 || ''} ${o.recipient.address2 || ''}, ${o.recipient.postalCode || ''} ${o.recipient.city || ''}, ${o.recipient.country || ''}</div>` : ''}
                            <div class="text-sm ${o.shipped ? 'text-green-400' : 'text-yellow-400'}">${o.shipped ? '‚úÖ Shipping done' : '‚è≥ Waiting for shipping'}</div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button ${o.shipped ? 'disabled' : ''} onclick="markGuestOrderShipped('${o.id}')" class="px-3 py-1 rounded text-sm ${o.shipped ? 'bg-gray-600 text-gray-300' : 'bg-green-500 hover:bg-green-600 text-white'}">${o.shipped ? 'Shipping Done' : 'Mark Shipping Done'}</button>
                        </div>
                    </div>
                </div>
            `).join('');

            backdrop.innerHTML = `
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold">Guest Orders</h2>
                            <div class="text-sm text-gray-400 mt-1">${guests.length} guest orders</div>
                        </div>
                        <button onclick="document.body.removeChild(this.closest('.fixed'))" class="text-white hover:text-pink-400 text-2xl">&times;</button>
                    </div>
                    ${guests.length ? list : '<div class="text-gray-300">No guest orders found.</div>'}
                </div>
            `;
            document.body.appendChild(backdrop);
        }

        // Open guest orders for a specific guest key from the Guests Database table
        function viewGuestOrdersForKey(safeKey) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const guests = orders.filter(o => o.isGuest || !o.customerEmail || o.customerEmail === 'unknown' || !o.customerEmail.includes('@'));
            const match = guests.filter(o => {
                const email = (o.contactEmail || '').trim();
                const key = email || `guest_${(o.recipient?.firstName||'').toLowerCase()}_${(o.recipient?.lastName||'').toLowerCase()}_${(o.recipient?.postalCode||'').toLowerCase()}`;
                const sk = key.replace(/[^a-zA-Z0-9_\-]/g, '_');
                return sk === safeKey;
            });
            if (match.length === 0) { alert('No orders found for this guest.'); return; }
            // Temporarily reuse the same modal renderer by building a tiny container and injecting list
            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.onclick = function(e) { if (e.target === backdrop) document.body.removeChild(backdrop); };
            const list = match.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).map(o => `
                <div class=\"bg-black bg-opacity-30 rounded-xl p-4 mb-3 border-l-4 ${o.shipped ? 'border-green-400' : 'border-yellow-400'}\">
                    <div class=\"flex justify-between items-start\">
                        <div class=\"flex-1\">
                            <div class=\"font-semibold\">${o.recordTitle} <span class=\"text-gray-400\">(${o.recordId})</span></div>
                            <div class=\"text-sm text-gray-400\">‚Ç¨${o.amount} ‚Ä¢ ${new Date(o.timestamp).toLocaleString()}</div>
                            ${(o.recipient ? `<div class=\\\"text-xs text-gray-400 mt-1\\\">${o.recipient.firstName || ''} ${o.recipient.lastName || ''} ‚Äî ${o.recipient.address1 || ''} ${o.recipient.address2 || ''}, ${o.recipient.postalCode || ''} ${o.recipient.city || ''}, ${o.recipient.country || ''}</div>` : '')}
                            <div class=\"text-sm ${o.shipped ? 'text-green-400' : 'text-yellow-400'}\">${o.shipped ? '‚úÖ Shipping done' : '‚è≥ Waiting for shipping'}</div>
                        </div>
                        <div class=\"flex flex-col gap-2 ml-4\">
                            <button ${o.shipped ? 'disabled' : ''} onclick=\"markGuestOrderShipped('${o.id}')\" class=\"px-3 py-1 rounded text-sm ${o.shipped ? 'bg-gray-600 text-gray-300' : 'bg-green-500 hover:bg-green-600 text-white'}\">${o.shipped ? 'Shipping Done' : 'Mark Shipping Done'}</button>
                        </div>
                    </div>
                </div>
            `).join('');
            backdrop.innerHTML = `
                <div class=\"bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto\">
                    <div class=\"flex justify-between items-center mb-4\">
                        <div>
                            <h2 class=\"text-xl font-bold\">Guest Orders</h2>
                            <div class=\"text-sm text-gray-400 mt-1\">${match.filter(o=>!o.shipped).length} waiting ‚Ä¢ ${match.filter(o=>o.shipped).length} processed ‚Ä¢ ${match.length} total</div>
                        </div>
                        <button onclick=\"document.body.removeChild(this.closest('.fixed'))\" class=\"text-white hover:text-pink-400 text-2xl\">&times;</button>
                    </div>
                    ${list}
                </div>`;
            document.body.appendChild(backdrop);
        }

        function markGuestOrderShipped(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const idx = orders.findIndex(o => o.id === orderId);
            if (idx === -1) { alert('Order not found'); return; }
            orders[idx].shipped = true;
            localStorage.setItem('orders', JSON.stringify(orders));
            // Refresh the modal by re-opening Guest Orders
            document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
            viewGuestOrders();
        }
    </script>
</body>
</html>
