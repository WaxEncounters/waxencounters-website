<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload a Record - Wax Encounters Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .premium-button { background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .premium-button:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(255, 255, 255, 0.2); }
        .main-background { position: fixed; top: 0; left: 0; right: 0; height: 200vh; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('images/background image.jpeg'); background-size: cover; background-position: center top; background-repeat: no-repeat; z-index: -1; }
        .admin-card { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(30px); border: 1px solid rgba(199, 122, 180, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6); }
        .upload-area { border: 2px dashed rgba(199, 122, 180, 0.5); transition: all 0.3s ease; }
        .upload-area:hover { border-color: rgba(199, 122, 180, 0.8); background: rgba(199, 122, 180, 0.1); }
        .upload-area.dragover { border-color: #c77ab4; background: rgba(199, 122, 180, 0.2); }
        .image-preview { max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; }
        .record-type-card { transition: all 0.3s ease; cursor: pointer; }
        .record-type-card:hover { transform: translateY(-2px); }
        .record-type-card.selected { border-color: #c77ab4; background: rgba(199, 122, 180, 0.1); }
        .section-fade { opacity: 0; transform: translateY(40px); transition: opacity 1.2s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1.2s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .section-fade.visible { opacity: 1; transform: translateY(0); }
    </style>
    <link rel="icon" href="data:,">
    <script src="js/purchase-tracker.js"></script>
</head>
<body class="text-white overflow-x-hidden">
    <div class="main-background"></div>
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="index.html" class="text-xl font-bold tracking-wider">WAX ENCOUNTERS</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <span class="text-pink-400 font-semibold">Admin Upload</span>
                        <a href="admin-dashboard.html" class="hover:text-gray-300 transition-colors duration-200">ðŸ“Š Dashboard</a>
                        <button id="logoutAdminBtn" class="hover:text-gray-300 transition-colors duration-200">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pt-24">
        <section class="relative">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12 section-fade">
                    <div class="admin-card rounded-2xl p-8 inline-block">
                        <h1 class="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">Upload a Record</h1>
                        <p class="text-lg text-gray-300">Add new vinyl records to your platform</p>
                    </div>
                </div>

                <!-- Upload Form -->
                <div class="admin-card rounded-2xl p-8 section-fade" style="transition-delay: 200ms;">
                    <form id="recordUploadForm" class="space-y-8">
                        <!-- Record Type Selection -->
                        <div>
                            <h3 class="text-2xl font-bold mb-6 text-pink-400">Record Type</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="record-type-card admin-card rounded-xl p-6" data-type="immediate">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-green-400 bg-opacity-20 rounded-full mx-auto mb-4 flex items-center justify-center">
                                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-semibold mb-2">Immediate Sale</h4>
                                        <p class="text-gray-300 text-sm">Ready to ship, set price and quantity</p>
                                    </div>
                                </div>
                                <div class="record-type-card admin-card rounded-xl p-6" data-type="crowdfunding">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-blue-400 bg-opacity-20 rounded-full mx-auto mb-4 flex items-center justify-center">
                                            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-semibold mb-2">Crowdfunding Campaign</h4>
                                        <p class="text-gray-300 text-sm">Set funding goal and timeline</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Record Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <!-- Basic Information -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Basic Information</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Artist Name *</label>
                                            <input type="text" name="artistName" required class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="e.g., Luna Nova">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Album Title *</label>
                                            <input type="text" name="albumTitle" required class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="e.g., Ethereal Dreams">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Genre</label>
                                            <input type="text" name="genre" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="e.g., Electronic, Ambient">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                                            <textarea name="description" rows="3" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base resize-none" placeholder="Describe the album..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Album Images -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Album Images</h3>
                                    <p class="text-sm text-gray-400 mb-4">Upload up to 5 images for this album (cover, vinyl mockups, artist photos, etc.)</p>
                                    <div class="upload-area rounded-xl p-8 text-center">
                                        <input type="file" id="coverImage" name="coverImage" accept="image/*" multiple class="hidden" required>
                                        <div id="uploadPrompt">
                                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                            </svg>
                                            <p class="text-gray-300 mb-2">Click to upload or drag and drop</p>
                                            <p class="text-sm text-gray-400">PNG, JPG up to 10MB each (max 5 images)</p>
                                        </div>
                                        <div id="imagePreview" class="hidden">
                                            <div id="imageGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4"></div>
                                            <button type="button" id="removeAllImages" class="text-red-400 hover:text-red-300 text-sm">Remove All Images</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="space-y-6">
                                <!-- Pricing Information -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-4 text-pink-400">Pricing</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Price (â‚¬) *</label>
                                            <input type="number" name="price" step="0.01" min="0" required class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="35.00">
                                        </div>
                                    </div>
                                </div>

                                <!-- Immediate Sale Settings -->
                                <div id="immediateSettings" class="hidden">
                                    <h3 class="text-xl font-semibold mb-4 text-green-400">Immediate Sale Settings</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Initial Quantity *</label>
                                            <input type="number" name="quantity" min="1" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="100">
                                        </div>
                                        <div class="bg-green-400 bg-opacity-10 border border-green-400 border-opacity-30 rounded-lg p-4">
                                            <p class="text-sm text-green-300">
                                                <strong>Auto Inventory:</strong> Quantity will automatically decrease with each sale. 
                                                You'll be notified when stock runs low.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Crowdfunding Settings -->
                                <div id="crowdfundingSettings" class="hidden">
                                    <h3 class="text-xl font-semibold mb-4 text-blue-400">Crowdfunding Settings</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Funding Goal (â‚¬) *</label>
                                            <input type="number" name="fundingGoal" step="0.01" min="0" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="3500.00">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Campaign Duration (Days) *</label>
                                            <input type="number" name="campaignDays" min="1" max="365" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base" placeholder="30">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">Start Date</label>
                                            <input type="date" name="startDate" class="w-full px-4 py-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 focus:outline-none focus:border-pink-400 focus:bg-opacity-15 transition-all duration-200 text-base">
                                        </div>
                                        <div class="bg-blue-400 bg-opacity-10 border border-blue-400 border-opacity-30 rounded-lg p-4">
                                            <p class="text-sm text-blue-300">
                                                <strong>Auto Tracking:</strong> Progress will be tracked automatically. 
                                                Users will be notified of campaign updates.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center pt-6 border-t border-white border-opacity-20">
                            <button type="submit" class="premium-button px-12 py-4 text-black font-semibold rounded-xl text-lg">
                                Upload Record
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Recent Uploads -->
                <div class="admin-card rounded-2xl p-8 mt-8 section-fade" style="transition-delay: 400ms;">
                    <h3 class="text-2xl font-bold mb-6 text-pink-400">Recent Uploads</h3>
                    <div id="recentUploads" class="space-y-4">
                        <!-- This will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Check admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession) {
                alert('Access denied. Admin authentication required.');
                window.location.href = 'login.html';
                return;
            }

            initializeUploadPage();
        });

        function initializeUploadPage() {
            // Record type selection
            document.querySelectorAll('.record-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.record-type-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const type = this.dataset.type;
                    updateFormSettings(type);
                });
            });

            // Image upload handling
            setupImageUpload();
            setupMultipleImageUpload();
            
            // Form submission
            document.getElementById('recordUploadForm').addEventListener('submit', handleFormSubmission);
            
            // Logout functionality
            document.getElementById('logoutAdminBtn').addEventListener('click', function() {
                localStorage.removeItem('adminSession');
                window.location.href = 'login.html';
            });

            // Load recent uploads
            loadRecentUploads();
            
            // Initialize animations
            initializeAnimations();
        }

        function updateFormSettings(type) {
            const immediateSettings = document.getElementById('immediateSettings');
            const crowdfundingSettings = document.getElementById('crowdfundingSettings');
            
            if (type === 'immediate') {
                immediateSettings.classList.remove('hidden');
                crowdfundingSettings.classList.add('hidden');
                
                // Make quantity required for immediate sale
                document.querySelector('input[name="quantity"]').required = true;
                
                // Remove required from crowdfunding fields
                document.querySelector('input[name="fundingGoal"]').required = false;
                document.querySelector('input[name="campaignDays"]').required = false;
            } else if (type === 'crowdfunding') {
                immediateSettings.classList.add('hidden');
                crowdfundingSettings.classList.remove('hidden');
                
                // Remove required from quantity
                document.querySelector('input[name="quantity"]').required = false;
                
                // Make crowdfunding fields required
                document.querySelector('input[name="fundingGoal"]').required = true;
                document.querySelector('input[name="campaignDays"]').required = true;
            }
        }

        function setupImageUpload() {
            const coverInput = document.getElementById('coverImage');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const imagePreview = document.getElementById('imagePreview');
            const imageGrid = document.getElementById('imageGrid');
            const removeAllBtn = document.getElementById('removeAllImages');
            const uploadArea = document.querySelector('.upload-area');

            // Click to upload
            uploadArea.addEventListener('click', () => coverInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageUpload(files);
            });

            // File input change
            coverInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    handleImageUpload(files);
                }
            });

            // Remove all images
            removeAllBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                coverInput.value = '';
                uploadPrompt.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                imageGrid.innerHTML = '';
            });

            function handleImageUpload(files) {
                // Handle both single file and array of files
                const fileArray = Array.isArray(files) ? files : [files];
                
                for (let file of fileArray) {
                    if (!file || !file.type || !file.type.startsWith('image/')) {
                        alert('Please select valid image files.');
                        return;
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        alert('Image size must be less than 10MB.');
                        return;
                    }
                }
                
                // Use the multiple image handler
                handleMultipleImages(fileArray);
            }
        }

        // Enhanced image upload functions for multiple images
        function setupMultipleImageUpload() {
            const coverInput = document.getElementById('coverImage');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const imagePreview = document.getElementById('imagePreview');
            const imageGrid = document.getElementById('imageGrid');
            const removeAllBtn = document.getElementById('removeAllImages');

            // Override the existing single image handler
            function handleMultipleImages(files) {
                // Limit to 5 images
                if (files.length > 5) {
                    alert('You can upload a maximum of 5 images.');
                    files = files.slice(0, 5);
                }

                // Validate all files
                const validFiles = [];
                for (let file of files) {
                    if (!file.type.startsWith('image/')) {
                        alert(`"${file.name}" is not an image file. Skipping...`);
                        continue;
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        alert(`"${file.name}" is larger than 10MB. Skipping...`);
                        continue;
                    }

                    validFiles.push(file);
                }

                if (validFiles.length === 0) {
                    return;
                }

                // Update file input with valid files
                const dataTransfer = new DataTransfer();
                validFiles.forEach(file => dataTransfer.items.add(file));
                coverInput.files = dataTransfer.files;

                // Display all images
                displayMultipleImages(validFiles);
            }

            function displayMultipleImages(files) {
                imageGrid.innerHTML = '';
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'relative group';
                        imageContainer.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg ${index === 0 ? 'ring-2 ring-green-400' : ''}">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 rounded-lg"></div>
                            <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation(); removeImage(${index})">
                                Ã—
                            </button>
                            <button type="button" class="absolute bottom-2 left-2 ${index === 0 ? 'bg-green-500 opacity-100' : 'bg-pink-500 opacity-0 group-hover:opacity-100'} text-white px-2 py-1 rounded text-xs transition-opacity" onclick="event.stopPropagation(); setAsMainImage(${index})">
                                ${index === 0 ? 'MAIN IMAGE' : 'Set as Main'}
                            </button>
                            ${index === 0 ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold">COVER</div>' : ''}
                        `;
                        imageGrid.appendChild(imageContainer);
                    };
                    reader.readAsDataURL(file);
                });

                uploadPrompt.classList.add('hidden');
                imagePreview.classList.remove('hidden');
            }

            // Global function to remove individual images
            window.removeImage = function(index) {
                const currentFiles = Array.from(coverInput.files);
                currentFiles.splice(index, 1);
                
                const dataTransfer = new DataTransfer();
                currentFiles.forEach(file => dataTransfer.items.add(file));
                coverInput.files = dataTransfer.files;
                
                if (currentFiles.length === 0) {
                    uploadPrompt.classList.remove('hidden');
                    imagePreview.classList.add('hidden');
                } else {
                    displayMultipleImages(currentFiles);
                }
            };

            // Global function to set main image
            window.setAsMainImage = function(index) {
                const currentFiles = Array.from(coverInput.files);
                if (index === 0) return; // Already main
                
                // Move selected image to first position
                const selectedFile = currentFiles[index];
                currentFiles.splice(index, 1);
                currentFiles.unshift(selectedFile);
                
                // Update file input without triggering change event
                const dataTransfer = new DataTransfer();
                currentFiles.forEach(file => dataTransfer.items.add(file));
                
                // Temporarily remove event listener to prevent triggering
                const originalHandler = coverInput.onchange;
                coverInput.onchange = null;
                coverInput.files = dataTransfer.files;
                coverInput.onchange = originalHandler;
                
                // Redisplay images with new order
                displayMultipleImages(currentFiles);
            };

            // Override existing event listeners
            coverInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    handleMultipleImages(files);
                }
            });

            removeAllBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                coverInput.value = '';
                uploadPrompt.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                imageGrid.innerHTML = '';
            });
        }

        // Helper function to compress and convert file to data URL
        function convertFileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calculate new dimensions (max 600px width/height for smaller storage)
                    const maxSize = 600;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed data URL (0.6 quality for smaller size)
                    const compressedDataURL = canvas.toDataURL('image/jpeg', 0.6);
                    resolve(compressedDataURL);
                };
                
                img.onerror = reject;
                
                // Load the image
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleFormSubmission(e) {
            e.preventDefault();
            
            try {
                console.log('Starting form submission...');
                
                const formData = new FormData(e.target);
                const recordData = Object.fromEntries(formData.entries());
                console.log('Form data:', recordData);
                
                // Get selected record type
                const selectedType = document.querySelector('.record-type-card.selected')?.dataset.type;
                console.log('Selected type:', selectedType);
                if (!selectedType) {
                    alert('Please select a record type.');
                    return;
                }

                // Get album images (up to 5)
                const albumImages = Array.from(document.getElementById('coverImage').files);
                console.log('Album images count:', albumImages.length);
                if (albumImages.length === 0) {
                    alert('Please upload at least one image for the album.');
                    return;
                }

            // Validate required fields based on type
            if (selectedType === 'immediate') {
                if (!recordData.quantity || recordData.quantity < 1) {
                    alert('Please enter a valid quantity for immediate sale.');
                    return;
                }
            } else if (selectedType === 'crowdfunding') {
                if (!recordData.fundingGoal || recordData.fundingGoal < 0) {
                    alert('Please enter a valid funding goal.');
                    return;
                }
                if (!recordData.campaignDays || recordData.campaignDays < 1) {
                    alert('Please enter a valid campaign duration.');
                    return;
                }
            }

                // Convert all album images to base64 data URLs
                console.log('Converting images to base64...');
                const albumImagesDataUrls = await Promise.all(
                    albumImages.map(img => convertFileToDataURL(img))
                );
                console.log('Images converted successfully, count:', albumImagesDataUrls.length);

                // Create record object
                console.log('Creating record object...');
                const record = {
                    id: generateRecordId(),
                    type: selectedType,
                    artistName: recordData.artistName,
                    albumTitle: recordData.albumTitle,
                    genre: recordData.genre,
                    description: recordData.description,
                    price: parseFloat(recordData.price),
                    coverImage: albumImagesDataUrls[0], // First image as cover
                    albumImages: albumImagesDataUrls, // All images
                    uploadedAt: new Date().toISOString(),
                    status: selectedType === 'immediate' ? 'available' : 'campaign',
                    ...(selectedType === 'immediate' ? {
                        quantity: parseInt(recordData.quantity),
                        sold: 0
                    } : {
                        fundingGoal: parseFloat(recordData.fundingGoal),
                        campaignDays: parseInt(recordData.campaignDays),
                        startDate: recordData.startDate || new Date().toISOString().split('T')[0],
                        raised: 0,
                        backers: 0
                    })
                };
                console.log('Record object created:', record);

                // Save record to localStorage (in production, this would go to a database)
                console.log('Saving record...');
                const recordId = saveRecord(record);
                console.log('Record saved with ID:', recordId);
                
                // Show success message
                alert('Record uploaded successfully!');
                
                // Reset form
                e.target.reset();
                document.querySelectorAll('.record-type-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('immediateSettings').classList.add('hidden');
                document.getElementById('crowdfundingSettings').classList.add('hidden');
                document.getElementById('uploadPrompt').classList.remove('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('imageGrid').innerHTML = '';
                
                // Reload recent uploads
                loadRecentUploads();
            } catch (error) {
                console.error('Error uploading record:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error uploading record. Please check the console for details and try again.');
            }
        }

        function generateRecordId() {
            return 'record_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveRecord(record) {
            try {
                console.log('saveRecord called with:', record);
                
                // Check if PurchaseTracker is available
                if (typeof window.PurchaseTracker === 'undefined') {
                    console.log('PurchaseTracker not found, saving directly to localStorage');
                    return saveRecordDirectly(record);
                }
                
                console.log('PurchaseTracker found, using it to save record');
                // Use the PurchaseTracker to add the record
                const recordId = window.PurchaseTracker.addRecord(record);
                console.log('Record saved with ID:', recordId);
                return recordId;
            } catch (error) {
                console.error('Error saving record:', error);
                console.error('Error details:', error.message);
                
                // If it's a quota error, try to clear old records and retry
                if (error.name === 'QuotaExceededError') {
                    console.log('Storage quota exceeded, clearing old records...');
                    clearOldRecords();
                    return saveRecordDirectly(record);
                }
                
                // Other errors: fallback to direct save
                console.log('Using fallback: saving directly to localStorage');
                return saveRecordDirectly(record);
            }
        }

        function saveRecordDirectly(record) {
            try {
                const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
                records.push(record);
                localStorage.setItem('uploadedRecords', JSON.stringify(records));
                console.log('Record saved directly to localStorage with ID:', record.id);
                return record.id;
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.log('Still quota exceeded, clearing old records and retrying...');
                    clearOldRecords();
                    
                    try {
                        const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
                        records.push(record);
                        localStorage.setItem('uploadedRecords', JSON.stringify(records));
                        console.log('Record saved after clearing old records with ID:', record.id);
                        return record.id;
                    } catch (secondError) {
                        if (secondError.name === 'QuotaExceededError') {
                            console.log('Still quota exceeded, clearing all localStorage...');
                            clearAllLocalStorage();
                            localStorage.setItem('uploadedRecords', JSON.stringify([record]));
                            console.log('Record saved after clearing all localStorage with ID:', record.id);
                            return record.id;
                        }
                        throw secondError;
                    }
                }
                throw error;
            }
        }

        function clearAllLocalStorage() {
            try {
                // Clear all localStorage except essential items
                const essentialKeys = ['adminSession'];
                const keysToKeep = essentialKeys.filter(key => localStorage.getItem(key));
                
                localStorage.clear();
                
                // Restore essential items
                keysToKeep.forEach(key => {
                    localStorage.setItem(key, localStorage.getItem(key));
                });
                
                console.log('Cleared all localStorage, kept essential items:', keysToKeep);
            } catch (error) {
                console.error('Error clearing all localStorage:', error);
            }
        }

        function clearOldRecords() {
            try {
                const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
                // Keep only the 5 most recent records for more aggressive cleanup
                const recentRecords = records.slice(-5);
                localStorage.setItem('uploadedRecords', JSON.stringify(recentRecords));
                console.log('Cleared old records, kept', recentRecords.length, 'most recent ones');
                
                // Also clear other localStorage items that might be taking up space
                const keysToCheck = ['userData', 'cachedDisplayData', 'admin_user_'];
                keysToCheck.forEach(keyPrefix => {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(keyPrefix)) {
                            try {
                                const item = localStorage.getItem(key);
                                if (item && item.length > 100000) { // If item is larger than 100KB
                                    console.log('Removing large item:', key, 'size:', item.length);
                                    localStorage.removeItem(key);
                                }
                            } catch (e) {
                                console.log('Could not check item:', key);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error clearing old records:', error);
            }
        }

        function loadRecentUploads() {
            const records = JSON.parse(localStorage.getItem('uploadedRecords') || '[]');
            const recentUploads = document.getElementById('recentUploads');
            
            if (records.length === 0) {
                recentUploads.innerHTML = '<p class="text-gray-400 text-center py-8">No records uploaded yet.</p>';
                return;
            }

            // Show last 5 records
            const recentRecords = records.slice(-5).reverse();
            
            recentUploads.innerHTML = recentRecords.map(record => `
                <div class="admin-card rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-pink-400 bg-opacity-20 rounded-lg flex items-center justify-center">
                            <span class="text-pink-400 font-bold">${record.type === 'immediate' ? 'ðŸ’°' : 'ðŸ“ˆ'}</span>
                        </div>
                        <div>
                            <h4 class="font-semibold">${record.albumTitle}</h4>
                            <p class="text-sm text-gray-300">by ${record.artistName}</p>
                            <p class="text-xs text-gray-400">
                                ${record.type === 'immediate' ? 
                                    `â‚¬${record.price} â€¢ ${record.quantity - record.sold} available` : 
                                    `â‚¬${record.price} â€¢ Goal: â‚¬${record.fundingGoal} â€¢ ${record.raised} raised`
                                }
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${
                            record.status === 'available' ? 'bg-green-400 bg-opacity-20 text-green-400' : 
                            record.status === 'campaign' ? 'bg-blue-400 bg-opacity-20 text-blue-400' : 
                            'bg-gray-400 bg-opacity-20 text-gray-400'
                        }">
                            ${record.type === 'immediate' ? 'Available' : 'Campaign'}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">
                            ${new Date(record.uploadedAt).toLocaleDateString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function initializeAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);
            
            document.querySelectorAll('.section-fade').forEach(el => {
                observer.observe(el);
            });
        }
    </script>
</body>
</html>
